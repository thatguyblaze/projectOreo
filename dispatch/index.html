<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CADNEXT - Advanced Dispatch System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0B0F17;
            color: #cbd5e1;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes type { from { width: 0; } to { width: 100%; } }

        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-zoom { animation: zoomIn 0.2s ease-out forwards; }
        .animate-pulse-custom { animation: pulse-red 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-type { overflow: hidden; white-space: nowrap; animation: type 1s steps(40, end); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Tooltip visibility */
        .group:hover .group-hover\:block { display: block; }
    </style>
</head>
<body class="h-screen overflow-hidden selection:bg-blue-500/30">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const icons = {
            Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>,
            Flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-2.246-5.318 6-6.5 3.438 1.787 5.4 5.312 4.686 9.387A5.002 5.002 0 1 1 12 18c0 0 0-4.182-4.182-4.182a4.182 4.182 0 0 1 .682-3.318"/>,
            HeartPulse: <React.Fragment><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="M12 5 9.04 20.26a.92.92 0 0 0 1.06 1.08l9.4-2.81"/></React.Fragment>,
            Crosshair: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></React.Fragment>,
            Radio: <React.Fragment><circle cx="12" cy="12" r="2"/><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"/></React.Fragment>,
            MapPin: <React.Fragment><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></React.Fragment>,
            Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>,
            DollarSign: <React.Fragment><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></React.Fragment>,
            Clock: <React.Fragment><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></React.Fragment>,
            CheckCircle: <React.Fragment><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></React.Fragment>,
            AlertTriangle: <React.Fragment><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></React.Fragment>,
            User: <React.Fragment><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></React.Fragment>,
            Zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
            Layers: <React.Fragment><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></React.Fragment>,
            ChevronRight: <polyline points="9 18 15 12 9 6"/>,
            TrendingUp: <React.Fragment><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></React.Fragment>,
            Skull: <React.Fragment><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></React.Fragment>,
            PauseCircle: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="10" y1="15" x2="10" y2="9"/><line x1="14" y1="15" x2="14" y2="9"/></React.Fragment>,
            FastForward: <React.Fragment><polygon points="13 19 22 12 13 5 13 19"/><polygon points="2 19 11 12 2 5 2 19"/></React.Fragment>,
            RotateCcw: <React.Fragment><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></React.Fragment>,
            Briefcase: <React.Fragment><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></React.Fragment>,
            Award: <React.Fragment><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></React.Fragment>,
            ChevronsUp: <React.Fragment><path d="m17 11-5-5-5 5"/><path d="m17 18-5-5-5 5"/></React.Fragment>,
            Target: <React.Fragment><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></React.Fragment>,
            Wifi: <React.Fragment><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></React.Fragment>,
            Lock: <React.Fragment><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></React.Fragment>,
            Unlock: <React.Fragment><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></React.Fragment>,
            XCircle: <React.Fragment><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></React.Fragment>,
            CloudRain: <React.Fragment><line x1="16" y1="13" x2="16" y2="21"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="12" y1="15" x2="12" y2="23"/><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/></React.Fragment>,
            Sun: <React.Fragment><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></React.Fragment>,
            CloudLightning: <React.Fragment><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="13 11 9 17 15 17 11 23"/></React.Fragment>,
            Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
        };

        const Lucide = ({ icon, size, className }) => {
            if (!icons[icon]) return null;
            return <Icon path={icons[icon]} size={size} className={className} />;
        };

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playSound = (type) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const createOsc = (freq, type, duration, vol) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, now);
                gain.gain.setValueAtTime(vol, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + duration);
            };
            if (type === 'incoming') { createOsc(880, 'sine', 0.6, 0.1); setTimeout(() => createOsc(1100, 'sine', 0.6, 0.05), 150); }
            else if (type === 'dispatch') { 
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.frequency.setValueAtTime(200, now); osc.frequency.linearRampToValueAtTime(800, now + 0.3);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.connect(gain); gain.connect(audioCtx.destination); osc.start(now); osc.stop(now + 0.3);
            }
            else if (type === 'click') createOsc(2000, 'sine', 0.03, 0.02);
            else if (type === 'error') createOsc(150, 'sawtooth', 0.3, 0.1);
            else if (type === 'success') { createOsc(600, 'sine', 0.1, 0.05); setTimeout(() => createOsc(900, 'sine', 0.2, 0.05), 100); }
            else if (type === 'locked') { createOsc(1200, 'sine', 0.1, 0.05); }
            else if (type === 'ability') { createOsc(400, 'square', 0.5, 0.1); setTimeout(() => createOsc(600, 'square', 0.5, 0.1), 100); }
            else if (type === 'levelup') { createOsc(300, 'triangle', 0.1, 0.1); setTimeout(() => createOsc(400, 'triangle', 0.1, 0.1), 100); setTimeout(() => createOsc(600, 'triangle', 0.4, 0.1), 200); }
            else if (type === 'gameover') { createOsc(100, 'sawtooth', 2.0, 0.2); setTimeout(() => createOsc(80, 'sawtooth', 2.0, 0.2), 200); }
        };

        // --- CONSTANTS ---
        const PROTOCOLS = [
            { id: 'CIVIL', label: 'Civil', color: 'bg-blue-500' },
            { id: 'VIOLENT', label: 'Violent', color: 'bg-red-500' },
            { id: 'MEDICAL', label: 'Medical', color: 'bg-emerald-500' },
            { id: 'HAZARD', label: 'Hazard', color: 'bg-orange-500' },
            { id: 'CRITICAL', label: 'Critical', color: 'bg-purple-500' }
        ];

        const INCIDENT_TYPES = [
            { name: 'Noise Complaint', code: '10-48', risk: 1, units: 'police', time: 15, payout: 100, cat: 'CIVIL', msgs: ["Caller reports loud music from unit 4B.", "Barking dog for 3 hours straight.", "Construction noise after ordinance hours."] },
            { name: 'Loitering', code: '10-14', risk: 1, units: 'police', time: 10, payout: 80, cat: 'CIVIL', msgs: ["Group of teens blocking the convenience store entrance.", "Suspect sleeping in the bank ATM vestibule.", "Individuals attempting to open car doors in parking lot."] },
            { name: 'Minor MVA', code: '10-50', risk: 1, units: 'police', time: 20, payout: 150, cat: 'CIVIL', msgs: ["Fender bender at 4th and Main. No injuries.", "Car hit a parked vehicle and fled.", "Traffic signal malfunction causing confusion."] },
            { name: 'Chest Pain', code: '10-33', risk: 2, units: 'ems', time: 25, payout: 300, cat: 'MEDICAL', msgs: ["Male, 56, reports severe pressure in chest.", "Female having trouble breathing, history of heart issues.", "Elderly patient collapsed in the kitchen."] },
            { name: 'Structure Fire', code: '10-70', risk: 3, units: 'fire_ems', time: 40, payout: 600, cat: 'HAZARD', msgs: ["Black smoke seen coming from the roof.", "Flames visible in second story window.", "Commercial fire alarm going off in apartment complex."] },
            { name: 'Armed Robbery', code: '10-30', risk: 3, units: 'police_swat', time: 35, payout: 750, cat: 'VIOLENT', msgs: ["Subject entered store with a handgun. Demand money.", "Silent panic alarm from the First National Bank.", "Clerk reports being held at knifepoint."] },
            { name: 'Domestic', code: '10-16', risk: 2, units: 'police', time: 25, payout: 250, cat: 'VIOLENT', msgs: ["Fighting audible through apartment walls.", "Neighbor reports thrown objects and screaming.", "Verbal altercation escalating in the street."] },
            { name: 'Hazmat', code: '10-90', risk: 3, units: 'fire_ems', time: 50, payout: 800, cat: 'HAZARD', msgs: ["Overturned truck leaking unknown green fluid.", "Strong chemical smell in the subway station.", "White powder found in mailroom."] },
            { name: 'Active Shooter', code: '10-32', risk: 3, units: 'all', time: 45, payout: 1000, cat: 'CRITICAL', msgs: ["SHOTS FIRED AT THE MALL. MULTIPLE CALLS.", "Man with a rifle spotted near the school.", "Multiple victims down in the plaza."] },
            { name: 'Cyber Attack', code: '10-99', risk: 3, units: 'swat', time: 60, payout: 1200, cat: 'CRITICAL', msgs: ["City power grid compromised by external actor.", "Mainframe breach at City Hall.", "Traffic light control system has been hacked."] }
        ];

        const ZONES = ['Downtown', 'Northside', 'West End', 'Port District', 'Highlands', 'Industrial', 'Tech Park', 'Metro Station'];
        const UNIT_DATA = {
            police: { label: 'Patrol', baseCost: 500, icon: 'Shield', color: 'text-blue-400', bg: 'bg-blue-500/20', border: 'border-blue-500/30' },
            fire: { label: 'Engine', baseCost: 800, icon: 'Flame', color: 'text-orange-400', bg: 'bg-orange-500/20', border: 'border-orange-500/30' },
            ems: { label: 'Medic', baseCost: 600, icon: 'HeartPulse', color: 'text-emerald-400', bg: 'bg-emerald-500/20', border: 'border-emerald-500/30' },
            swat: { label: 'Tac-Ops', baseCost: 1500, icon: 'Crosshair', color: 'text-purple-400', bg: 'bg-purple-500/20', border: 'border-purple-500/30' }
        };
        const ABILITIES = [
            { id: 'rapid', name: 'Rapid Clear', cost: 2000, icon: 'FastForward', desc: 'Resolve oldest call' },
            { id: 'jam', name: 'Comms Jammer', cost: 1500, icon: 'PauseCircle', desc: 'Pause new calls (30s)' },
            { id: 'recall', name: 'Fleet Recall', cost: 1000, icon: 'RotateCcw', desc: 'Reset all units' }
        ];

        const OBJECTIVES = [
            { id: 'pol_3', text: 'Resolve 3 Police incidents', type: 'police', count: 3, reward: 500 },
            { id: 'fir_2', text: 'Resolve 2 Fire incidents', type: 'fire', count: 2, reward: 600 },
            { id: 'ems_2', text: 'Resolve 2 Medical incidents', type: 'ems', count: 2, reward: 400 },
            { id: 'all_5', text: 'Resolve 5 Total incidents', type: 'any', count: 5, reward: 800 },
        ];

        const WEATHER_TYPES = [
            { id: 'clear', name: 'Clear', icon: 'Sun', mod: 1.0, desc: 'Normal Operations' },
            { id: 'rain', name: 'Heavy Rain', icon: 'CloudRain', mod: 1.2, desc: '+20% Travel Time' },
            { id: 'storm', name: 'Severe Storm', icon: 'CloudLightning', mod: 1.4, desc: '+40% Travel Time, High Risk' }
        ];

        // --- HELPERS ---
        const generateCallerInfo = () => {
            const firstNames = ["James", "Mary", "John", "Patricia", "Robert", "Jennifer", "Michael", "Linda", "William", "Elizabeth", "David", "Barbara"];
            const lastNames = ["Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez"];
            const streets = ["Maple", "Oak", "Cedar", "Pine", "Elm", "Washington", "Lake", "Hill"];
            const types = ["St", "Ave", "Blvd", "Rd", "Ln"];
            
            const name = `${firstNames[Math.floor(Math.random()*firstNames.length)]} ${lastNames[Math.floor(Math.random()*lastNames.length)]}`;
            const age = Math.floor(Math.random() * 60) + 18;
            const phone = `555-${Math.floor(Math.random()*900)+100}-${Math.floor(Math.random()*9000)+1000}`;
            const address = `${Math.floor(Math.random()*9999)+1} ${streets[Math.floor(Math.random()*streets.length)]} ${types[Math.floor(Math.random()*types.length)]}`;
            
            return { name, age, phone, address };
        };

        // --- COMPONENTS ---
        const UnitControl = ({ type, count, available, onAdd, onRemove, req }) => {
            const config = UNIT_DATA[type];
            const isMet = count >= req;
            return (
                <div className={`flex items-center justify-between p-3 rounded-xl border transition-all ${isMet && req > 0 ? 'bg-emerald-500/5 border-emerald-500/30' : 'bg-slate-800/40 border-white/5'}`}>
                    <div className="flex items-center gap-3">
                        <div className={`p-2 rounded-lg ${config.bg} ${config.color}`}><Lucide icon={config.icon} size={18} /></div>
                        <div>
                            <div className="text-sm font-bold text-slate-200">{config.label}</div>
                            <div className="text-xs text-slate-500">Req: <span className={req > 0 ? 'text-slate-300' : 'text-slate-600'}>{req}</span></div>
                        </div>
                    </div>
                    <div className="flex items-center gap-3 bg-slate-900/50 rounded-lg p-1 border border-white/5">
                        <button onClick={onRemove} className="w-7 h-7 flex items-center justify-center rounded hover:bg-white/10 text-slate-400 transition-colors">-</button>
                        <span className={`w-4 text-center font-bold text-sm ${count >= req && req > 0 ? 'text-emerald-400' : 'text-slate-200'}`}>{count}</span>
                        <button onClick={onAdd} disabled={count >= available} className="w-7 h-7 flex items-center justify-center rounded hover:bg-white/10 text-slate-400 disabled:opacity-30 transition-colors">+</button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const DispatchCAD = () => {
            const [started, setStarted] = useState(false);
            const [gameOver, setGameOver] = useState(false);
            const [funds, setFunds] = useState(2500);
            const [score, setScore] = useState(0);
            const [shiftTime, setShiftTime] = useState(0);
            const [streak, setStreak] = useState(0);
            const [threatLevel, setThreatLevel] = useState(0);
            const [spawnPaused, setSpawnPaused] = useState(false);
            
            // Mechanics
            const [weather, setWeather] = useState(WEATHER_TYPES[0]);
            const [zoneHeat, setZoneHeat] = useState(ZONES.reduce((acc, z) => ({...acc, [z]: 0}), {}));
            
            // Persistent Data
            const [highScore, setHighScore] = useState(0);
            const [recentGames, setRecentGames] = useState([]);

            // Leveling
            const [level, setLevel] = useState(1);
            const [xp, setXp] = useState(0);
            const xpToNext = level * 1000;

            const [fleet, setFleet] = useState({ 
                police: { total: 4, available: 4, speedLvl: 1 }, 
                fire: { total: 2, available: 2, speedLvl: 1 }, 
                ems: { total: 2, available: 2, speedLvl: 1 }, 
                swat: { total: 1, available: 1, speedLvl: 1 } 
            });
            const [queue, setQueue] = useState([]);
            const [activeCalls, setActiveCalls] = useState([]);
            const [incoming, setIncoming] = useState(null); 
            const [viewingCall, setViewingCall] = useState(null); 
            
            const [selectedUnits, setSelectedUnits] = useState({ police: 0, fire: 0, ems: 0, swat: 0 });
            const [selectedProtocol, setSelectedProtocol] = useState(null); // User's guess
            
            // Objectives
            const [currentObjective, setCurrentObjective] = useState(OBJECTIVES[0]);
            const [objectiveProgress, setObjectiveProgress] = useState(0);

            const formatTime = (s) => `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
            const calculateCost = (type) => { const base = UNIT_DATA[type].baseCost; return Math.floor(base + (base * (fleet[type].total * 0.2))); };
            const calculateUpgradeCost = (lvl) => 2000 * lvl;

            // Load Persistence
            useEffect(() => {
                const savedScore = localStorage.getItem('cadnext_highscore');
                const savedGames = localStorage.getItem('cadnext_recents');
                if(savedScore) setHighScore(parseInt(savedScore));
                if(savedGames) setRecentGames(JSON.parse(savedGames));
            }, []);

            // Save on Game Over
            useEffect(() => {
                if(gameOver) {
                    if(score > highScore) {
                        setHighScore(score);
                        localStorage.setItem('cadnext_highscore', score);
                    }
                    const newRecents = [{score, date: new Date().toLocaleDateString()}, ...recentGames].slice(0, 5);
                    setRecentGames(newRecents);
                    localStorage.setItem('cadnext_recents', JSON.stringify(newRecents));
                }
            }, [gameOver]);

            // Game Loop
            useEffect(() => {
                if (!started || gameOver) return;
                const interval = setInterval(() => {
                    setShiftTime(t => t + 1);
                    
                    // Weather Cycle (Every 60s chance)
                    if(Math.random() < 0.01) {
                        const nextW = WEATHER_TYPES[Math.floor(Math.random() * WEATHER_TYPES.length)];
                        setWeather(nextW);
                    }

                    // Passive Threat
                    setThreatLevel(t => Math.min(100, t + (queue.length * 0.1)));

                    setActiveCalls(prev => {
                        const remaining = [];
                        prev.forEach(c => {
                            if (Date.now() - c.startTime > c.duration * 1000) {
                                setFunds(f => f + c.payout);
                                const earnedScore = (c.risk * 10) + (streak * 5);
                                setScore(s => s + earnedScore);
                                setXp(x => {
                                    const newXp = x + earnedScore;
                                    if (newXp >= xpToNext) {
                                        setLevel(l => l + 1);
                                        setFunds(f => f + 1500); 
                                        playSound('levelup');
                                        return newXp - xpToNext;
                                    }
                                    return newXp;
                                });
                                
                                // Objective
                                if (currentObjective.type === 'any' || c.units.includes(currentObjective.type)) {
                                    setObjectiveProgress(p => {
                                        const newP = p + 1;
                                        if (newP >= currentObjective.count) {
                                            setFunds(f => f + currentObjective.reward);
                                            playSound('success');
                                            setCurrentObjective(OBJECTIVES[Math.floor(Math.random() * OBJECTIVES.length)]);
                                            return 0;
                                        }
                                        return newP;
                                    });
                                }

                                setStreak(s => Math.min(s + 1, 10));
                                setThreatLevel(t => Math.max(0, t - 5));
                                setZoneHeat(zh => ({...zh, [c.zone]: Math.max(0, zh[c.zone] - 10)}));
                                playSound('success');
                                setFleet(f => { 
                                    const next = { ...f }; 
                                    Object.keys(c.assigned).forEach(k => {
                                        next[k].available = Math.min(next[k].total, next[k].available + c.assigned[k]);
                                    }); 
                                    return next; 
                                });
                            } else remaining.push(c);
                        });
                        return remaining;
                    });
                    
                    // Spawn Logic with Heat
                    const chaosLevel = Math.floor(shiftTime / 60);
                    if (Math.random() < (0.08 + (chaosLevel * 0.02)) && !spawnPaused) {
                        if (threatLevel >= 100) { setGameOver(true); playSound('gameover'); }
                        else {
                            const z = ZONES[Math.floor(Math.random() * ZONES.length)];
                            const heatRisk = zoneHeat[z] > 50 ? 1 : 0;
                            const tpl = INCIDENT_TYPES[Math.floor(Math.random() * INCIDENT_TYPES.length)];
                            const req = { police: 0, fire: 0, ems: 0, swat: 0 };
                            const calcReq = (base, type) => {
                                const raw = Math.ceil(base) + (chaosLevel > 2 ? 1 : 0);
                                return Math.min(fleet[type].total + 1, raw); 
                            };

                            if (tpl.units.includes('police')) req.police = calcReq(tpl.risk * 0.8, 'police');
                            if (tpl.units.includes('fire')) req.fire = calcReq(tpl.risk * 0.7, 'fire');
                            if (tpl.units.includes('ems')) req.ems = 1;
                            if (tpl.units.includes('swat')) { req.swat = 1; req.police += 1; }
                            if (tpl.units === 'all') { req.police = 2; req.fire = 1; req.ems = 1; }
                            
                            const info = generateCallerInfo();

                            const call = {
                                id: Math.random().toString(36).substr(2, 6).toUpperCase(),
                                type: tpl.name, code: tpl.code, risk: Math.min(3, tpl.risk + heatRisk), units: tpl.units, cat: tpl.cat,
                                msg: tpl.msgs[Math.floor(Math.random() * tpl.msgs.length)],
                                zone: z,
                                info: info,
                                baseDuration: tpl.time, 
                                duration: tpl.time, 
                                payout: Math.floor(tpl.payout * (1 + streak * 0.1 + chaosLevel * 0.05)),
                                req, timestamp: Date.now()
                            };
                            if (!incoming && queue.length < 5) { 
                                setIncoming(call);
                                setSelectedUnits({ police: 0, fire: 0, ems: 0, swat: 0 });
                                setSelectedProtocol(null);
                                playSound('incoming'); 
                            }
                            else { 
                                setQueue(q => [...q, call]); 
                                setThreatLevel(t => Math.min(100, t + 3));
                                setZoneHeat(zh => ({...zh, [z]: Math.min(100, zh[z] + 5)}));
                            }
                        }
                    }
                }, 1000);
                return () => clearInterval(interval);
            }, [started, incoming, gameOver, streak, shiftTime, queue.length, spawnPaused, threatLevel, level, xp, currentObjective, weather, zoneHeat]);

            // Start
            useEffect(() => {
                if (started && !incoming) {
                    const tpl = INCIDENT_TYPES[0];
                    const info = generateCallerInfo();
                    const call = {
                        id: "INIT-01", type: tpl.name, code: tpl.code, risk: 1, units: 'police', cat: 'CIVIL',
                        msg: tpl.msgs[0],
                        info: info,
                        zone: ZONES[0], baseDuration: 10, duration: 10, payout: 200,
                        req: { police: 1, fire: 0, ems: 0, swat: 0 }, timestamp: Date.now()
                    };
                    setIncoming(call);
                    setSelectedUnits({ police: 0, fire: 0, ems: 0, swat: 0 });
                    setSelectedProtocol(null);
                    playSound('incoming');
                }
            }, [started]);

            const handleOpenCall = (call) => {
                if (incoming) setQueue(q => [...q, incoming]);
                setIncoming(call);
                setQueue(q => q.filter(c => c.id !== call.id));
                setSelectedUnits({ police: 0, fire: 0, ems: 0, swat: 0 });
                setSelectedProtocol(null);
                playSound('click');
            };

            const handleMinimizeIncoming = (e) => {
                if (incoming) {
                    setQueue(q => [...q, incoming]);
                    setIncoming(null);
                    playSound('click');
                }
            }

            const handleDispatch = () => {
                const validSelection = Object.keys(selectedUnits).every(k => selectedUnits[k] <= fleet[k].available);
                const hasReqUnits = Object.keys(incoming.req).every(k => selectedUnits[k] >= incoming.req[k]);
                
                if (!incoming || !selectedProtocol || !hasReqUnits || !validSelection) {
                    playSound('error'); return;
                }
                
                let speedBonus = 0;
                Object.keys(selectedUnits).forEach(k => { if (selectedUnits[k] > 0) speedBonus += (fleet[k].speedLvl - 1) * 0.1; });
                
                // SCORING LOGIC
                const isCorrectProtocol = selectedProtocol === incoming.cat;
                const wMod = weather.mod;
                const finalDuration = Math.max(5, (incoming.baseDuration * wMod) * (1 - Math.min(0.5, speedBonus)));
                
                const dispatchedCall = { 
                    ...incoming, 
                    duration: finalDuration, 
                    startTime: Date.now(), 
                    assigned: selectedUnits,
                    // Penalty if wrong
                    payout: isCorrectProtocol ? incoming.payout : Math.floor(incoming.payout * 0.5)
                };

                if (!isCorrectProtocol) {
                    setThreatLevel(t => Math.min(100, t + 10)); // Penalty for bad triage
                    playSound('error'); // Audible warning
                } else {
                    playSound('dispatch');
                }

                setFleet(prev => { 
                    const next = { ...prev }; 
                    Object.keys(selectedUnits).forEach(k => { next[k].available = Math.max(0, next[k].available - selectedUnits[k]); }); 
                    return next; 
                });
                setActiveCalls(prev => [...prev, dispatchedCall]);
                setIncoming(null);
            };

            const handleAbort = (call) => {
                setFleet(f => {
                    const next = { ...f };
                    Object.keys(call.assigned).forEach(k => next[k].available += call.assigned[k]);
                    return next;
                });
                setActiveCalls(prev => prev.filter(c => c.id !== call.id));
                setThreatLevel(t => Math.min(100, t + 10));
                setViewingCall(null);
                playSound('error');
            };

            const buyUnit = (type) => {
                const cost = calculateCost(type);
                if (funds >= cost) {
                    setFunds(f => f - cost);
                    setFleet(prev => ({ ...prev, [type]: { ...prev[type], total: prev[type].total + 1, available: prev[type].available + 1 } }));
                    playSound('success');
                } else playSound('error');
            };

            const buyUpgrade = (type) => {
                const lvl = fleet[type].speedLvl;
                const cost = calculateUpgradeCost(lvl);
                if (funds >= cost) {
                    setFunds(f => f - cost);
                    setFleet(prev => ({ ...prev, [type]: { ...prev[type], speedLvl: prev[type].speedLvl + 1 } }));
                    playSound('levelup');
                } else playSound('error');
            };

            const useAbility = (id) => {
                const ab = ABILITIES.find(a => a.id === id);
                if (funds < ab.cost) { playSound('error'); return; }
                setFunds(f => f - ab.cost); playSound('ability');
                if (id === 'rapid' && activeCalls.length > 0) {
                    const t = activeCalls[0];
                    setActiveCalls(p => p.slice(1));
                    setFunds(f => f + t.payout); setThreatLevel(l => Math.max(0, l - 10));
                    setFleet(f => { const n = { ...f }; Object.keys(t.assigned).forEach(k => n[k].available += t.assigned[k]); return n; });
                } else if (id === 'jam') {
                    setSpawnPaused(true); setTimeout(() => setSpawnPaused(false), 30000);
                } else if (id === 'recall') {
                    setActiveCalls([]);
                    setFleet(f => { const n = { ...f }; Object.keys(n).forEach(k => n[k].available = n[k].total); return n; });
                    setThreatLevel(l => Math.min(100, l + 15));
                }
            };

            if (!started) return (
                <div className="h-screen bg-slate-950 flex items-center justify-center p-6 text-slate-200 font-sans">
                    <div className="max-w-md w-full text-center space-y-8 animate-zoom">
                        <div className="relative inline-block"><div className="absolute inset-0 bg-blue-500 blur-2xl opacity-20 rounded-full"></div><Lucide icon="Radio" size={64} className="relative z-10 text-white mx-auto" /></div>
                        <div>
                            <h1 className="text-5xl font-bold tracking-tight text-white mb-2">CAD<span className="text-blue-500">NEXT</span></h1>
                            <p className="text-slate-400 text-lg">Advanced Dispatch System</p>
                        </div>
                        <div className="bg-slate-900 p-4 rounded-xl border border-white/5 text-sm">
                            <div className="flex justify-between mb-2"><span className="text-slate-500">High Score</span><span className="text-emerald-400 font-mono font-bold">{highScore}</span></div>
                            <div className="text-left text-xs text-slate-500 mb-1 font-bold uppercase tracking-wider">Recent Operations</div>
                            {recentGames.length === 0 ? <div className="text-slate-600 italic">No history found</div> : 
                                <ul className="space-y-1">
                                    {recentGames.map((g, i) => (
                                        <li key={i} className="flex justify-between text-slate-400"><span>{g.date}</span><span>{g.score} pts</span></li>
                                    ))}
                                </ul>
                            }
                        </div>
                        <button onClick={() => { if (audioCtx.state === 'suspended') audioCtx.resume(); setStarted(true); }} className="w-full py-4 bg-white text-black font-bold rounded-xl hover:scale-[1.02] transition-transform shadow-xl shadow-white/10">START SHIFT</button>
                    </div>
                </div>
            );

            if (gameOver) return (
                <div className="h-screen bg-slate-950 flex items-center justify-center p-6 text-slate-200 font-sans">
                    <div className="max-w-md w-full text-center space-y-6 animate-zoom">
                        <Lucide icon="Skull" size={80} className="mx-auto text-red-500" />
                        <h1 className="text-4xl font-bold text-white">SYSTEM FAILURE</h1>
                        <p className="text-slate-400">City Overwhelmed.</p>
                        <div className="bg-slate-900 p-6 rounded-xl border border-white/10 space-y-2">
                            <div className="flex justify-between text-sm"><span>Shift Duration:</span> <span className="font-mono text-white">{formatTime(shiftTime)}</span></div>
                            <div className="flex justify-between text-sm"><span>Score:</span> <span className="font-mono text-emerald-400">{score}</span></div>
                        </div>
                        <button onClick={() => window.location.reload()} className="w-full py-3 bg-red-600 text-white font-bold rounded-xl hover:bg-red-500 transition-colors">REBOOT SYSTEM</button>
                    </div>
                </div>
            );

            return (
                <div className="h-screen bg-[#0B0F17] text-slate-300 font-sans flex overflow-hidden">
                    <aside className="w-80 flex flex-col border-r border-white/5 bg-slate-900/50 backdrop-blur-xl z-20 h-full">
                        
                        {/* 1. Queue */}
                        <div className="flex-1 flex flex-col min-h-0 border-b border-white/5">
                            <div className="p-3 border-b border-white/5 flex items-center justify-between bg-slate-900/80 sticky top-0 z-10">
                                <div className="flex items-center gap-2"><Lucide icon="Layers" size={14} className="text-blue-500" /><span className="font-bold text-xs text-slate-200 uppercase tracking-wider">Queue</span></div>
                                <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold ${queue.length > 5 ? 'bg-red-500 text-white animate-pulse-custom' : 'bg-white/10 text-white'}`}>{queue.length}</span>
                            </div>
                            <div className="overflow-y-auto p-2 space-y-2">
                                {queue.length === 0 && <div className="text-center py-8 text-slate-600 text-xs italic">No Pending Calls</div>}
                                {queue.map(call => (
                                    <div key={call.id} onClick={() => handleOpenCall(call)} className="p-3 rounded bg-slate-800/40 border border-white/5 hover:bg-slate-800 hover:border-blue-500/50 transition-all cursor-pointer group">
                                        <div className="flex justify-between items-start mb-1"><span className="font-bold text-xs text-slate-200 group-hover:text-blue-400">{call.type}</span><span className={`text-[9px] px-1.5 py-0.5 rounded font-bold ${call.risk >= 3 ? 'bg-red-500/20 text-red-400' : 'bg-slate-700/50 text-slate-400'}`}>CODE {call.risk}</span></div>
                                        <div className="flex items-center gap-2 text-[10px] text-slate-500"><Lucide icon="Clock" size={10} /> {Math.floor((Date.now() - call.timestamp)/1000)}s ago</div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* 2. Tactical Support */}
                        <div className="p-3 border-t border-b border-white/5 bg-slate-900/80">
                            <div className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 flex items-center gap-2"><Lucide icon="Zap" size={10} /> Support</div>
                            <div className="grid grid-cols-1 gap-1">
                                {ABILITIES.map(a => (
                                    <button key={a.id} title={a.desc} onClick={() => useAbility(a.id)} disabled={funds < a.cost} className="group w-full flex items-center justify-between p-2 rounded bg-slate-800 border border-white/5 hover:border-emerald-500/30 disabled:opacity-50 relative">
                                        <div className="flex items-center gap-2"><Lucide icon={a.icon} size={12} className="text-slate-400 group-hover:text-white" /><span className="text-[10px] font-bold text-slate-300 group-hover:text-white">{a.name}</span></div>
                                        <div className={`text-[10px] font-mono font-bold ${funds >= a.cost ? 'text-emerald-400' : 'text-slate-600'}`}>${a.cost}</div>
                                        <div className="hidden group-hover:block absolute left-full ml-2 w-32 bg-slate-900 border border-white/10 p-2 text-[9px] text-slate-300 rounded z-50 shadow-xl">{a.desc}</div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* 3. Fleet Management */}
                        <div className="p-3 bg-black/20 h-1/3 flex flex-col min-h-0">
                            <div className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 flex items-center gap-2"><Lucide icon="Briefcase" size={10} /> Fleet Assets</div>
                            <div className="flex-1 overflow-y-auto grid grid-cols-2 gap-2 pr-1">
                                {Object.entries(fleet).map(([k, v]) => {
                                    const uData = UNIT_DATA[k];
                                    const cost = calculateCost(k);
                                    const upCost = calculateUpgradeCost(v.speedLvl);
                                    return (
                                        <div key={k} className={`p-3 rounded-lg border bg-slate-900/50 ${uData.border} flex flex-col justify-between relative group`}>
                                            <div className="flex justify-between items-center mb-2">
                                                <div className="flex items-center gap-2"><Lucide icon={uData.icon} size={20} className={uData.color} /><span className={`text-xs font-bold uppercase ${uData.color}`}>{k}</span></div>
                                                <span className="text-sm font-bold text-white">{v.available}/{v.total}</span>
                                            </div>
                                            
                                            {/* Info Tooltip on Hover */}
                                            <div className="hidden group-hover:block absolute bottom-full mb-2 left-0 w-full bg-black border border-white/10 p-2 text-[9px] text-slate-300 rounded z-50 shadow-xl">
                                                Level {v.speedLvl}: +{Math.floor((v.speedLvl-1)*10)}% Speed Efficiency
                                            </div>

                                            <div className="flex flex-col gap-2 mt-auto">
                                                <button onClick={() => buyUnit(k)} disabled={funds < cost} className="w-full py-3 bg-white/5 hover:bg-white/10 text-[12px] font-bold text-center rounded border border-white/5 disabled:opacity-30 font-mono text-emerald-400/90 uppercase tracking-wide hover:border-emerald-500/50 transition-colors">BUY ${cost}</button>
                                                <button onClick={() => buyUpgrade(k)} disabled={funds < upCost} className="w-full py-3 bg-white/5 hover:bg-white/10 text-[12px] font-bold text-center rounded border border-white/5 disabled:opacity-30 font-mono text-blue-400/90 uppercase tracking-wide hover:border-blue-500/50 transition-colors">UPG ${upCost}</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col relative bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-slate-900 via-[#0B0F17] to-[#0B0F17]">
                        <header className="h-14 border-b border-white/5 flex items-center justify-between px-6 bg-slate-900/40 backdrop-blur-sm z-30">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div><span className="font-bold text-slate-200 tracking-tight text-lg">CAD<span className="text-slate-600">NEXT</span></span></div>
                                <div className="h-6 w-px bg-white/10 mx-2"></div>
                                <div className="flex items-center gap-4 text-xs">
                                    <div className="flex items-center gap-2" title="Shift Time"><Lucide icon="Clock" size={12} className="text-slate-500" /><span className="font-mono text-white font-bold">{formatTime(shiftTime)}</span></div>
                                    <div className="flex items-center gap-2" title="Available Funds"><Lucide icon="DollarSign" size={12} className="text-slate-500" /><span className="font-mono text-emerald-400 font-bold">${funds.toLocaleString()}</span></div>
                                </div>
                            </div>
                            
                            {/* Weather & Objective */}
                            <div className="hidden md:flex items-center gap-6">
                                <div className="flex items-center gap-2 text-xs text-slate-400">
                                    <Lucide icon={weather.icon} size={14} />
                                    <span>{weather.name}</span>
                                </div>
                                <div className="flex items-center gap-2 bg-blue-500/10 border border-blue-500/20 px-3 py-1 rounded-full">
                                    <Lucide icon="Target" size={12} className="text-blue-400" />
                                    <span className="text-[10px] text-blue-200 font-medium">{currentObjective.text}: {objectiveProgress}/{currentObjective.count}</span>
                                </div>
                            </div>

                            {/* Level Bar & Threat */}
                            <div className="flex items-center gap-6 w-1/3">
                                <div className="flex-1">
                                    <div className="flex justify-between text-[9px] font-bold uppercase text-slate-500 mb-1"><span>Level {level}</span><span>{Math.floor(xp)}/{level*1000}</span></div>
                                    <div className="h-1 bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-blue-500 transition-all duration-500" style={{width: `${Math.min(100, (xp/(level*1000))*100)}%`}}></div></div>
                                </div>
                                <div className="w-24">
                                    <div className="flex justify-between text-[9px] font-bold uppercase text-slate-500 mb-1"><span>Threat</span><span className={threatLevel>80?'text-red-500':''}>{Math.floor(threatLevel)}%</span></div>
                                    <div className="h-1 bg-slate-800 rounded-full overflow-hidden"><div className={`h-full transition-all duration-500 ${threatLevel>80?'bg-red-500 animate-pulse-custom':threatLevel>50?'bg-orange-500':'bg-blue-500'}`} style={{width: `${threatLevel}%`}}></div></div>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 p-6 flex flex-col overflow-hidden">
                            <div className="mb-6 flex items-center justify-between">
                                <h2 className="text-sm font-bold text-slate-200 uppercase tracking-widest flex items-center gap-2"><Lucide icon="Activity" size={16} className="text-emerald-500" /> Active Operations</h2>
                                <div className="flex gap-4 text-[10px] font-bold text-slate-500 uppercase"><span>Streak: <span className="text-white">{streak}x</span></span>{spawnPaused && <span className="text-red-500 animate-pulse-custom">SPAWNS PAUSED</span>}</div>
                            </div>
                            <div className="flex-1 overflow-y-auto pr-2 space-y-3">
                                {activeCalls.length === 0 && <div className="h-48 flex flex-col items-center justify-center text-slate-600 border border-dashed border-slate-800 rounded-xl bg-slate-900/20"><Lucide icon="Activity" size={32} className="mb-3 opacity-50" /><span className="text-sm font-medium">No Active Operations</span></div>}
                                {activeCalls.map(call => {
                                    const progress = Math.min(100, ((Date.now() - call.startTime) / (call.duration * 1000)) * 100);
                                    return (
                                        <div key={call.id} onClick={() => setViewingCall(call)} className="group relative bg-slate-900/40 hover:bg-slate-900/60 border border-white/5 rounded-xl p-4 transition-all animate-fade-in cursor-pointer">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1"><span className={`w-2 h-2 rounded-full ${call.risk >= 3 ? 'bg-red-500 animate-pulse-custom' : call.risk === 2 ? 'bg-orange-400' : 'bg-blue-400'}`} /> <span className="text-xs font-mono text-slate-500">#{call.id}</span></div>
                                                    <h4 className="font-bold text-slate-200">{call.type}</h4>
                                                    <div className="text-xs text-slate-500 flex items-center gap-1 mt-1"><Lucide icon="MapPin" size={10} /> {call.zone} <span className={zoneHeat[call.zone] > 50 ? "text-red-500 ml-2" : "text-slate-600 ml-2"}>HEAT: {zoneHeat[call.zone]}%</span></div>
                                                </div>
                                                <div className="text-right"><span className="text-xs font-mono font-bold text-slate-400">{Math.ceil(call.duration - (Date.now() - call.startTime)/1000)}s</span></div>
                                            </div>
                                            <div className="h-1 w-full bg-slate-800 rounded-full overflow-hidden"><div className="h-full bg-blue-500 transition-all duration-1000" style={{ width: `${progress}%` }} /></div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Active Call Intel Viewer */}
                        {viewingCall && (
                            <div className="absolute inset-0 z-50 bg-black/70 backdrop-blur-md flex items-center justify-center p-6 animate-zoom" onClick={() => setViewingCall(null)}>
                                <div className="w-full max-w-lg bg-[#0F131C] border border-white/10 rounded-2xl shadow-2xl p-6" onClick={e => e.stopPropagation()}>
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-lg font-bold text-white">Live Feed: {viewingCall.type}</h3>
                                        <button onClick={() => setViewingCall(null)} className="text-slate-500 hover:text-white"><Lucide icon="XCircle" size={20} /></button>
                                    </div>
                                    <div className="space-y-4 mb-6">
                                        <div className="bg-slate-900 p-4 rounded border border-white/5">
                                            <div className="text-xs text-slate-500 uppercase mb-1">Status</div>
                                            <div className="text-emerald-400 font-mono">UNITS ON SCENE</div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            {Object.entries(viewingCall.assigned).map(([k,v]) => v > 0 && (
                                                <div key={k} className="bg-slate-900 p-2 rounded border border-white/5 flex justify-between">
                                                    <span className="text-xs font-bold text-slate-400 uppercase">{k}</span>
                                                    <span className="text-xs font-mono text-white">{v} deployed</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <button onClick={() => handleAbort(viewingCall)} className="w-full py-3 border border-red-500/50 text-red-500 hover:bg-red-500 hover:text-white transition-colors rounded text-xs font-bold uppercase tracking-widest">Emergency Recall (Abort)</button>
                                </div>
                            </div>
                        )}

                        {incoming && (
                            <div className="absolute inset-0 z-50 bg-black/70 backdrop-blur-md flex items-center justify-center p-6 animate-zoom" onClick={handleMinimizeIncoming}>
                                <div className="w-full max-w-4xl bg-[#0F131C] border border-white/10 rounded-2xl shadow-2xl flex flex-col md:flex-row overflow-hidden" onClick={e => e.stopPropagation()}>
                                    <div className="w-full md:w-1/3 bg-slate-900/50 p-6 border-r border-white/5 flex flex-col">
                                        <div className="mb-6">
                                            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-white/5 mb-4"><span className="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse-custom"></span><span className="text-xs font-medium text-slate-300">Incoming Alert</span></div>
                                            <h2 className="text-2xl font-bold text-white mb-2">{incoming.type}</h2>
                                            <div className="text-sm text-slate-400 flex items-center gap-2"><Lucide icon="MapPin" size={14} /> {incoming.zone}</div>
                                        </div>
                                        
                                        {/* Detailed Caller Info */}
                                        <div className="bg-slate-800/50 p-3 rounded border border-white/5 mb-4">
                                            <div className="flex justify-between text-[10px] text-slate-500 uppercase mb-1"><span>Caller Profile</span></div>
                                            <div className="text-xs font-mono text-white">{incoming.info.name} (Age: {incoming.info.age})</div>
                                            <div className="text-[10px] font-mono text-slate-400 mt-1">{incoming.info.phone}</div>
                                            <div className="text-[10px] font-mono text-slate-400">{incoming.info.address}</div>
                                        </div>

                                        <div className="space-y-2">
                                            <div className="p-3 rounded bg-white/5 border border-white/5 flex justify-between items-center"><div className="text-xs text-slate-500 uppercase tracking-wider">Code</div><div className="text-sm font-mono font-bold text-white">{incoming.code}</div></div>
                                            <div className="p-3 rounded bg-white/5 border border-white/5 flex justify-between items-center"><div className="text-xs text-slate-500 uppercase tracking-wider">Payout</div><div className="text-sm font-mono font-bold text-emerald-400">${incoming.payout}</div></div>
                                        </div>
                                        <div className="mt-auto pt-6"><button onClick={() => { setQueue(q => [...q, incoming]); setIncoming(null); playSound('click'); }} className="w-full py-3 rounded-lg border border-white/10 text-slate-400 text-sm font-medium hover:bg-white/5 hover:text-white transition-colors">Move to Queue</button></div>
                                    </div>
                                    
                                    {/* Right Panel */}
                                    <div className="flex-1 p-6 flex flex-col">
                                        <div className="mb-6">
                                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">1. Incident Triage (Identify Protocol)</h3>
                                            <div className="bg-slate-900 p-4 rounded-xl border border-white/5 mb-4 min-h-[80px] flex items-center">
                                                <div>
                                                    <div className="text-[10px] font-bold text-slate-500 uppercase mb-1">Caller Transcript</div>
                                                    <div className="font-mono text-sm text-emerald-400 animate-type">"{incoming.msg}"</div>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-5 gap-2">
                                                {PROTOCOLS.map(p => (
                                                    <button 
                                                        key={p.id} 
                                                        onClick={() => { setSelectedProtocol(p.id); playSound('click'); }} 
                                                        className={`py-2 rounded border text-[9px] font-bold uppercase tracking-wider transition-all ${selectedProtocol === p.id ? `${p.color} border-transparent text-white shadow-lg` : 'bg-slate-800 border-white/5 text-slate-400 hover:bg-slate-700'}`}
                                                    >
                                                        {p.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="mb-6 flex-1">
                                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-3">2. Unit Assignment</h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                {Object.keys(incoming.req).map(key => incoming.req[key] > 0 && (
                                                    <UnitControl key={key} type={key} req={incoming.req[key]} count={selectedUnits[key]} available={fleet[key].available} onAdd={() => { setSelectedUnits(p => ({...p, [key]: p[key]+1})); playSound('click'); }} onRemove={() => { setSelectedUnits(p => ({...p, [key]: Math.max(0, p[key]-1)})); playSound('click'); }} />
                                                ))}
                                            </div>
                                        </div>
                                        <button onClick={handleDispatch} className={`w-full py-4 rounded-xl font-bold text-sm tracking-widest uppercase transition-all flex items-center justify-center gap-3 ${selectedProtocol && Object.keys(incoming.req).every(k => selectedUnits[k] >= incoming.req[k]) && Object.keys(selectedUnits).every(k => selectedUnits[k] <= fleet[k].available) ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/25 scale-[1.01]' : 'bg-slate-800 text-slate-600 cursor-not-allowed'}`}>
                                            {selectedProtocol ? 'Authorize Dispatch' : 'Select Protocol First'} <Lucide icon="ChevronRight" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DispatchCAD />);
    </script>
</body>
</html>