<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treadz - Towing Quote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Fix for Tailwind CSS conflict with Leaflet */
        /* Fix for Tailwind CSS conflict with Leaflet */
        .leaflet-pane img,
        .leaflet-tile,
        .leaflet-marker-icon,
        .leaflet-marker-shadow {
            max-width: none !important;
            max-height: none !important;
            box-shadow: none;
            border: none;
        }

        /* Map Toast / Calibration UI */
        #map-toast {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 12px;
            font-weight: 600;
            color: #1f2937;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        #map-toast.visible {
            opacity: 1;
            top: 20px;
        }

        #map-toast.success {
            border-left: 4px solid #22c55e;
            color: #14532d;
        }

        #map-toast.warning {
            border-left: 4px solid #f59e0b;
            color: #78350f;
        }
    </style>
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Tow Ticket Modal Styles */
        .ticket-lines input {
            border: none;
            border-bottom: 1px solid #333;
            width: 100%;
            background: transparent;
            font-family: inherit;
            font-size: 14px;
            padding: 0 4px;
            border-radius: 0;
        }

        .ticket-lines input:focus {
            outline: none;
            border-bottom: 2px solid #2563eb;
        }

        .ticket-label {
            font-size: 12px;
            color: #666;
            margin-right: 8px;
            white-space: nowrap;
        }

        .ticket-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Print specific overrides */
        @media print {
            body * {
                visibility: hidden;
            }

            #tow-ticket-modal,
            #tow-ticket-modal * {
                visibility: visible;
            }

            #tow-ticket-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 9999;
                padding: 0;
                margin: 0;
                overflow: visible;
            }

            #tow-ticket-content {
                box-shadow: none !important;
                border: none !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* Hide modal UI elements */
            .modal-close,
            .ticket-actions {
                display: none !important;
            }

            /* Ensure inputs print their values */
            input {
                border: none !important;
                border-bottom: 1px solid #000 !important;
            }
        }
    </style>
</head>

<body class="antialiased h-screen flex flex-col bg-gray-100 overflow-hidden">
    <!-- Navigation -->
    <nav class="main-nav sticky top-0 z-40 p-4 w-full flex-shrink-0">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <!-- LEFT: Logo & Global Navigation -->
            <div class="flex items-center gap-8">
                <a href="../index.html" class="flex-shrink-0">
                    <img src="../treadztntLogo.png" alt="Treadz" class="h-10 w-auto">
                </a>

                <!-- Vertical Divider -->
                <div class="hidden md:block h-6 w-px bg-white/20"></div>

                <!-- Global Nav Items -->
                <div class="hidden md:flex items-center gap-1">
                    <a href="../index.html"
                        class="btn btn-secondary text-gray-300 hover:text-white hover:bg-white/10 font-medium py-2 px-4 rounded-lg transition-all">Inventory</a>
                    <a href="ticket/index.html"
                        class="btn btn-secondary active font-semibold py-2 px-4 rounded-lg">Towing</a>
                    <a href="../quote/index.html"
                        class="btn btn-secondary text-gray-300 hover:text-white hover:bg-white/10 font-medium py-2 px-4 rounded-lg transition-all">Quote</a>
                    <a href="../receipt/index.html"
                        class="btn btn-secondary text-gray-300 hover:text-white hover:bg-white/10 font-medium py-2 px-4 rounded-lg transition-all">Receipts</a>
                </div>
            </div>

            <!-- RIGHT: Page-Specific Actions (None for Towing) -->
            <!-- RIGHT: Page-Specific Actions (None for Towing) -->
            <div class="flex items-center gap-2">
                <a href="ticket/index.html"
                    class="btn btn-secondary text-sm font-medium py-2 px-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    <span class="hidden xl:inline">Ticket</span>
                </a>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <main class="flex-grow flex flex-col lg:flex-row h-full overflow-y-auto lg:overflow-hidden">

        <!-- Left Panel: Inputs & Calculator -->
        <div
            class="w-full lg:w-1/3 bg-white border-b lg:border-b-0 lg:border-r border-gray-200 flex flex-col h-auto lg:h-full shadow-xl z-20 overflow-y-auto flex-shrink-0">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-blue-600">
                        <path
                            d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
                        <circle cx="7" cy="17" r="2" />
                        <path d="M9 17h6" />
                        <circle cx="17" cy="17" r="2" />
                    </svg>
                    Job Details
                </h2>
            </div>

            <div class="p-6 space-y-6">
                <!-- Locations -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pickup Location</label>
                        <div class="relative">
                            <input type="text" id="pickup-input" placeholder="Enter Pickup Address"
                                class="w-full pl-9 pr-10 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="absolute left-3 top-2.5 text-green-500">
                                <circle cx="12" cy="10" r="3" />
                                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z" />
                            </svg>

                            <!-- Instant Street View Button -->
                            <button onclick="viewStreetView('pickup')"
                                class="absolute right-2 top-1.5 p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-all"
                                title="Instant Street View">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            <ul id="pickup-suggestions"
                                class="absolute left-0 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg z-50 hidden max-h-48 overflow-y-auto top-full mt-1">
                                <!-- Suggestions rendered here -->
                            </ul>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Dropoff Location (Default:
                            Shop)</label>
                        <div class="relative">
                            <input type="text" id="dropoff-input" placeholder="Enter Destination"
                                value="409 E Main St, Mount Carmel, TN 37645"
                                class="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="absolute left-3 top-2.5 text-red-500">
                                <circle cx="12" cy="10" r="3" />
                                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z" />
                            </svg>
                            <ul id="dropoff-suggestions"
                                class="absolute left-0 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg z-50 hidden max-h-48 overflow-y-auto top-full mt-1">
                                <!-- Suggestions rendered here -->
                            </ul>
                        </div>
                    </div>

                    <button id="calculate-route-btn"
                        class="w-full btn bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium flex items-center justify-center gap-2 shadow-sm transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                        </svg>
                        Calculate Route & Miles
                    </button>
                    <div id="route-status" class="text-xs text-center text-gray-500 h-4 min-h-[1rem]"></div>
                </div>



                <!-- Calculator -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Quote Calculator</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Miles</label>
                            <input type="number" id="miles-input" value="0.0" min="0" step="0.1"
                                class="w-full p-2 bg-white border border-gray-300 rounded-lg text-right font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none text-gray-900">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ETA</label>
                            <div id="eta-display"
                                class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-right font-mono text-xs text-gray-500 flex items-center justify-end h-[42px]">
                                -- min
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hook Fee ($)</label>
                            <input type="number" id="hook-fee-input" value="75.00" min="0" step="5"
                                class="w-full p-2 bg-white border border-gray-300 rounded-lg text-right font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none text-gray-900">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rate / Mile ($)</label>
                            <input type="number" id="rate-input" value="4.00" min="0" step="0.50"
                                class="w-full p-2 bg-white border border-gray-300 rounded-lg text-right font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none text-gray-900">
                        </div>
                    </div>
                </div>

                <!-- Total Display -->
                <div class="bg-gray-900 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-gray-400 text-sm font-medium">ESTIMATED QUOTE</span>
                        <div class="text-center">
                            <span class="text-3xl font-bold" id="total-display">$75.00</span>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 pt-2 border-t border-gray-700 mt-2">
                        <span id="mileage-breakdown">0 miles @ $4.00/mi</span>
                        <span>+ Hook Fee</span>
                    </div>
                </div>
            </div>
            <!-- Reset Pin -->
            <div class="mt-4 text-center">
                <button onclick="resetShopLocation()" class="text-xs text-gray-400 hover:text-red-500 underline">
                    Reset Shop Location Pin
                </button>
            </div>
        </div>

        <!-- Right Panel: Leaflet Map -->
        <div
            class="flex-grow bg-gray-100 flex flex-col p-0 lg:p-6 h-[400px] lg:h-auto border-t lg:border-t-0 border-gray-200">
            <div
                class="bg-white lg:rounded-2xl shadow-sm border-0 lg:border border-gray-200 flex-grow p-0 lg:p-1 overflow-hidden relative z-0 h-full">
                <div id="map"></div>
                <!-- Calibration Toast -->
                <div id="map-toast"></div>
            </div>
        </div>

    </main>

    <!-- Leaflet JS -->
    <script src="../js/treadz-core.js"></script>
    <script src="../js/mobile-nav.js" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- ELEMENTS ---
        const milesInput = document.getElementById('miles-input');
        const hookFeeInput = document.getElementById('hook-fee-input');
        const rateInput = document.getElementById('rate-input');
        const totalDisplay = document.getElementById('total-display');
        const breakdownDisplay = document.getElementById('mileage-breakdown');
        const etaDisplay = document.getElementById('eta-display');
        const pickupInput = document.getElementById('pickup-input');
        const dropoffInput = document.getElementById('dropoff-input');
        const btnCalc = document.getElementById('calculate-route-btn');
        const statusDiv = document.getElementById('route-status');

        // --- INIT FROM CONFIG ---
        // dropoffInput.value = TreadzConfig.SHOP_ADDRESS; // Optional: Pre-fill
        hookFeeInput.value = TreadzConfig.FEES.TOW_HOOK.toFixed(2);
        rateInput.value = TreadzConfig.FEES.TOW_RATE_PER_MILE.toFixed(2);

        // Enable Global Scroll
        TreadzUtils.enableGlobalScroll();

        // --- STATE ---
        let map;
        let routeLayer;
        let points = { shop: null, pickup: null, dropoff: null };
        let markers = { shop: null, pickup: null, dropoff: null };

        // --- INIT MAP ---
        function initMap() {
            // Versioned storage key to bust cache of "bad" locations
            const STORAGE_KEY = 'treadz_shop_coords_v4'; // Bumped version

            let isVerified = false;

            // Restore Saved Shop Location or Use Config Default
            const savedShop = localStorage.getItem(STORAGE_KEY);
            if (savedShop) {
                try {
                    points.shop = JSON.parse(savedShop);
                    isVerified = true;
                } catch (e) {
                    points.shop = { ...TreadzConfig.SHOP_COORDS, display_name: TreadzConfig.BUSINESS_NAME };
                }
            } else {
                points.shop = { ...TreadzConfig.SHOP_COORDS, display_name: TreadzConfig.BUSINESS_NAME };
            }

            // center on Shop
            map = L.map('map').setView([points.shop.lat, points.shop.lon], 14);

            // 1. Google Streets
            const googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: 'Map data &copy; Google'
            });

            // 2. Google Hybrid (Satellite + Labels) - DEFAULT
            const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: 'Map data &copy; Google'
            });

            // Default to Google Hybrid
            googleHybrid.addTo(map);

            L.control.layers({
                "Google Hybrid": googleHybrid,
                "Google Streets": googleStreets
            }).addTo(map);

            updateMarkers();

            // Fix "Stretched" canvas issues
            setTimeout(() => {
                map.invalidateSize();

                // Show Status Feedback
                if (isVerified) {
                    showMapToast("‚úÖ Using Verified Shop Location", "success");
                }
            }, 500);
        }

        // --- TOAST HELPER ---
        function showMapToast(msg, type = 'info') {
            const toast = document.getElementById('map-toast');
            if (!toast) return;

            toast.innerText = msg;
            toast.className = ''; // reset
            toast.classList.add(type);
            toast.classList.add('visible');

            // Auto hide after 5s
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 6000);
        }

        function resetShopLocation() {
            points.shop = { ...TreadzConfig.SHOP_COORDS, display_name: TreadzConfig.BUSINESS_NAME };
            localStorage.removeItem('treadz_shop_coords_v4'); // Clear saved
            updateMarkers();
            map.setView([points.shop.lat, points.shop.lon], 18);
            recalculateRoute();
        }

        // --- OPEN API HELPERS ---
        // SEARCH STRATEGY CONSTANTS IMPORTED FROM CONFIG

        async function geocode(addressInput) {
            const query = addressInput.trim();
            const location = `${TreadzConfig.SHOP_COORDS.lon},${TreadzConfig.SHOP_COORDS.lat}`;

            // Helper to run fetch
            const runGeocode = async (dist) => {
                const url = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&singleLine=${encodeURIComponent(query)}&maxLocations=1&outFields=Match_addr,Addr_type&location=${location}&distance=${dist}`;
                const res = await fetch(url);
                if (!res.ok) return null;
                const d = await res.json();
                return (d.candidates && d.candidates.length > 0) ? d.candidates[0] : null;
            };

            try {
                // STRATEGY: Local First -> Then Regional
                // 1. Try Local
                let match = await runGeocode(TreadzConfig.SEARCH.RADIUS_LOCAL_METERS);

                // 2. If nothing, try Wide
                if (!match) {
                    // console.log("Local miss, expanding search...");
                    match = await runGeocode(TreadzConfig.SEARCH.RADIUS_REGIONAL_METERS);
                }

                if (match) {
                    return {
                        lat: match.location.y,
                        lon: match.location.x,
                        display_name: match.address,
                        raw: match
                    };
                }
                return null;
            } catch (error) {
                console.error("Geocoding failed:", error);
                return null;
            }
        }

        async function fetchSuggestions(text) {
            if (text.length < 3) return [];

            const location = `${TreadzConfig.SHOP_COORDS.lon},${TreadzConfig.SHOP_COORDS.lat}`;

            // Helper
            const runSuggest = async (dist, max) => {
                const url = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/suggest?f=json&text=${encodeURIComponent(text)}&maxSuggestions=${max}&location=${location}&distance=${dist}`;
                const res = await fetch(url);
                return await res.json();
            };

            try {
                // STRATEGY: Local First -> Then Regional
                // 1. Try Local (Strict)
                let data = await runSuggest(TreadzConfig.SEARCH.RADIUS_LOCAL_METERS, TreadzConfig.SEARCH.SUGGESTIONS_LOCAL_MAX);
                let suggestions = data.suggestions || [];

                // 2. If results are poor (0 or very few), try Wide
                if (suggestions.length < 2) {
                    const wideData = await runSuggest(TreadzConfig.SEARCH.RADIUS_REGIONAL_METERS, TreadzConfig.SEARCH.SUGGESTIONS_TOTAL_MAX);
                    const wideSuggestions = wideData.suggestions || [];

                    // Deduplicate
                    const existingKeys = new Set(suggestions.map(s => s.magicKey));

                    wideSuggestions.forEach(s => {
                        if (!existingKeys.has(s.magicKey)) {
                            suggestions.push(s);
                        }
                    });
                }

                return suggestions;
            } catch (e) {
                console.error("Suggestion error:", e);
                return [];
            }
        }

        async function reverseGeocode(lat, lon) {
            try {
                // ArcGIS Reverse Geocode
                const url = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=json&location=${lon},${lat}&distance=100&outSR=4326`;

                const response = await fetch(url);
                const data = await response.json();

                if (data && data.address) {
                    return data.address.Match_addr || data.address.LongLabel;
                }
                return null;
            } catch (error) {
                console.error("Reverse geocoding failed", error);
                return null;
            }
        }

        async function getRouteData(p1, p2, p3) {
            try {
                const coords = `${p1.lon},${p1.lat};${p2.lon},${p2.lat};${p3.lon},${p3.lat}`;
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error("Routing failed", error);
                return null;
            }
        }

        // --- MAIN LOGIC ---
        async function handleCalculateClick() {
            const startAddr = pickupInput.value.trim();
            const endAddr = dropoffInput.value.trim();

            if (!startAddr || !endAddr) {
                statusDiv.innerText = "Please enter both addresses.";
                statusDiv.className = "text-xs text-center text-red-500 font-bold";
                return;
            }

            statusDiv.innerText = "Searching...";
            statusDiv.className = "text-xs text-center text-blue-600 animate-pulse font-bold";
            btnCalc.disabled = true;

            // Resolve
            const [pickup, dropoff] = await Promise.all([geocode(startAddr), geocode(endAddr)]);

            if (!pickup || !dropoff) {
                statusDiv.innerText = "Could not locate address. Try adding city/zip.";
                statusDiv.className = "text-xs text-center text-red-500 font-bold";
                btnCalc.disabled = false;
                return;
            }

            points.pickup = pickup;
            points.dropoff = dropoff;

            // Show Found Info
            statusDiv.innerHTML = `
                <div class="space-y-1">
                    <div class="text-green-700">1: ${pickup.display_name}</div>
                    <div class="text-green-700">2: ${dropoff.display_name}</div>
                    <div class="text-gray-400 font-normal">Drag markers to correct locations.</div>
                </div>`;
            statusDiv.className = "text-[10px] text-center mb-2 font-medium";

            updateMarkers();
            await recalculateRoute();

            btnCalc.disabled = false;
        }

        function updateMarkers() {
            // Remove old
            if (markers.shop) map.removeLayer(markers.shop);
            if (markers.pickup) map.removeLayer(markers.pickup);
            if (markers.dropoff) map.removeLayer(markers.dropoff);

            // SHOP MARKER REMOVED PER USER REQUEST

            // 1. Pickup (Draggable)
            if (points.pickup) {
                markers.pickup = L.marker([points.pickup.lat, points.pickup.lon], { draggable: true, title: 'Pickup' })
                    .addTo(map)
                    .bindPopup("<b>Pickup (Start)</b><br>Drag to fix location");

                markers.pickup.on('dragend', async (e) => {
                    const ll = e.target.getLatLng();
                    points.pickup.lat = ll.lat;
                    points.pickup.lon = ll.lng;

                    // Reverse Geocode
                    pickupInput.value = "Updating address...";
                    const addr = await reverseGeocode(ll.lat, ll.lng);
                    if (addr) {
                        pickupInput.value = addr;
                        points.pickup.display_name = addr;
                    } else {
                        pickupInput.value = "Custom Location";
                    }

                    recalculateRoute();
                });
            }

            // 2. Dropoff (Draggable)
            if (points.dropoff) {
                markers.dropoff = L.marker([points.dropoff.lat, points.dropoff.lon], { draggable: true, title: 'Dropoff' })
                    .addTo(map)
                    .bindPopup("<b>Dropoff (End)</b><br>Drag to fix location");

                markers.dropoff.on('dragend', async (e) => {
                    const ll = e.target.getLatLng();
                    points.dropoff.lat = ll.lat;
                    points.dropoff.lon = ll.lng;

                    // Reverse Geocode
                    dropoffInput.value = "Updating address...";
                    const addr = await reverseGeocode(ll.lat, ll.lng);
                    if (addr) {
                        dropoffInput.value = addr;
                        points.dropoff.display_name = addr;
                    } else {
                        dropoffInput.value = "Custom Location";
                    }

                    recalculateRoute();
                });
            }

            // Fit Bounds
            const group = [];
            if (points.pickup) group.push([points.pickup.lat, points.pickup.lon]);
            if (points.dropoff) group.push([points.dropoff.lat, points.dropoff.lon]);

            if (group.length > 1) {
                map.fitBounds(L.latLngBounds(group), { padding: [50, 50] });
            }
        }

        async function recalculateRoute() {
            if (!points.pickup || !points.dropoff) return;

            // Simple 2-point route: Pickup -> Dropoff
            const data = await getRouteDataTwoPoints(points.pickup, points.dropoff);

            if (data && data.routes && data.routes.length > 0) {
                const route = data.routes[0];

                // Draw Line
                if (routeLayer) map.removeLayer(routeLayer);
                routeLayer = L.geoJSON(route.geometry, {
                    style: { color: '#2563eb', weight: 5, opacity: 0.8 }
                }).addTo(map);

                // metrics
                const totalMeters = route.distance;
                const factor = 0.000621371;

                const miles = (totalMeters * factor);
                milesInput.value = miles.toFixed(1);

                // Google Maps Reality Adjustment (0.7x factor)
                // OSRM is very conservative; this brings it closer to real-world driving times.
                const timeMin = Math.round((route.duration / 60) * 0.7);
                etaDisplay.innerText = `${timeMin} min`;

                // Clear "enroute" data since we are only doing A -> B
                milesInput.dataset.enroute = 0;
                milesInput.dataset.towing = milesInput.value;

                calculateTotal();
            }
        }

        async function getRouteDataTwoPoints(p1, p2) {
            try {
                const coords = `${p1.lon},${p1.lat};${p2.lon},${p2.lat}`;
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error("Routing failed", error);
                return null;
            }
        }

        // --- STREET VIEW HELPER ---
        async function viewStreetView(type) {
            let point = points[type];
            const inputId = type === 'pickup' ? 'pickup-input' : 'dropoff-input';
            const val = document.getElementById(inputId).value.trim();

            if (!val) {
                alert("Please enter an address first.");
                return;
            }

            // If no point cached, or cached point doesn't match input (rough check), try to geocode
            if (!point) {
                // Show loading state on button?
                const btn = document.querySelector(`button[onclick="viewStreetView('${type}')"]`);
                const original = btn.innerHTML;
                btn.innerHTML = `<svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

                point = await geocode(val);

                btn.innerHTML = original;

                if (point) {
                    points[type] = point; // Cache it
                } else {
                    alert("Could not locate address for Street View.");
                    return;
                }
            }

            if (point && point.lat) {
                // Open "Instant" Street View
                // using map_action=pano to force street view if available
                const url = `https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${point.lat},${point.lon}`;
                window.open(url, '_blank', 'width=1000,height=600,noopener,noreferrer');
            }
        }



        function calculateTotal() {
            const miles = parseFloat(milesInput.value) || 0;
            const hook = parseFloat(hookFeeInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;

            const total = hook + (miles * rate);

            totalDisplay.innerText = `$${total.toFixed(2)}`;

            // Simplified display: Just towing miles
            breakdownDisplay.innerText = `${miles.toFixed(1)} miles @ $${rate.toFixed(2)}/mi`;
        }
        // Listeners
        milesInput.addEventListener('input', calculateTotal);
        hookFeeInput.addEventListener('input', calculateTotal);
        rateInput.addEventListener('input', calculateTotal);
        btnCalc.onclick = handleCalculateClick;

        // --- AUTOCOMPLETE LOGIC ---
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }



        async function getDetailsFromMagicKey(magicKey) {
            const url = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=json&magicKey=${magicKey}&maxLocations=1&outFields=Match_addr,Addr_type`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.candidates && data.candidates.length > 0) {
                    const match = data.candidates[0];
                    return {
                        lat: match.location.y,
                        lon: match.location.x,
                        display_name: match.address,
                        raw: match
                    };
                }
            } catch (e) {
                console.error("MagicKey details error:", e);
            }
            return null;
        }

        async function handleSuggestionSelect(type, suggestion) {
            const inputId = type === 'pickup' ? 'pickup-input' : 'dropoff-input';
            const containerId = type === 'pickup' ? 'pickup-suggestions' : 'dropoff-suggestions';

            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);

            input.value = suggestion.text;
            container.classList.add('hidden');

            // Feedback
            statusDiv.innerText = "Loading location...";
            statusDiv.className = "text-xs text-center text-blue-600 animate-pulse font-bold";

            // Get Details
            const point = await getDetailsFromMagicKey(suggestion.magicKey);

            if (point) {
                points[type] = point;
                statusDiv.innerText = "";
                updateMarkers();
                recalculateRoute();
            } else {
                statusDiv.innerText = "Could not load location.";
                statusDiv.className = "text-xs text-center text-red-500";
            }
        }

        function renderSuggestions(suggestions, containerId, inputId, type) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);

            container.innerHTML = '';

            if (suggestions.length === 0) {
                container.classList.add('hidden');
                return;
            }

            suggestions.forEach(s => {
                const li = document.createElement('li');
                li.className = "px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm text-gray-700 border-b last:border-0 border-gray-100";
                li.innerText = s.text;

                li.onclick = () => {
                    handleSuggestionSelect(type, s);
                };

                container.appendChild(li);
            });

            container.classList.remove('hidden');
        }

        function setupAutocomplete() {
            const setupInput = (inputId, containerId, type) => {
                const input = document.getElementById(inputId);
                const container = document.getElementById(containerId);

                const handleInput = debounce(async (e) => {
                    const text = e.target.value;
                    if (!text) {
                        container.classList.add('hidden');
                        return;
                    }
                    const suggestions = await fetchSuggestions(text);
                    renderSuggestions(suggestions, containerId, inputId, type);
                }, 300);

                input.addEventListener('input', handleInput);

                // Hide on click outside
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !container.contains(e.target)) {
                        container.classList.add('hidden');
                    }
                });
            };

            setupInput('pickup-input', 'pickup-suggestions', 'pickup');
            setupInput('dropoff-input', 'dropoff-suggestions', 'dropoff');
        }

        // --- DISPATCH HELPERS ---
        function buildDispatchMessage() {
            const name = document.getElementById('cust-name').value || "N/A";
            const phone = document.getElementById('cust-phone').value || "N/A";
            const vehicle = document.getElementById('cust-vehicle').value || "N/A";
            const pickup = pickupInput.value || "N/A";
            const dropoff = dropoffInput.value || "N/A";

            // Build Google Maps Link
            let mapLink = "";
            if (points.pickup && points.dropoff) {
                // Use exact coordinates for accuracy
                const start = `${points.pickup.lat},${points.pickup.lon}`;
                const end = `${points.dropoff.lat},${points.dropoff.lon}`;
                mapLink = `https://www.google.com/maps/dir/?api=1&origin=${start}&destination=${end}&travelmode=driving`;
            }

            return `üö® TOW DISPATCH üö®
üë§ ${name}
üìû ${phone}
üöó ${vehicle}

üìç PICKUP:
${pickup}

üìç DROPOFF:
${dropoff}

NAV: ${mapLink}`;
        }






        // Initialize
        initMap();
        setupAutocomplete();
        calculateTotal();

    </script>

</body>

</html>