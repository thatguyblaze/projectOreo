<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treadz - Towing Quote</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
    </style>
</head>

<body class="antialiased h-screen flex flex-col bg-gray-100 overflow-hidden">
    <!-- Navigation -->
    <nav class="main-nav sticky top-0 z-40 p-4 w-full flex-shrink-0 bg-gray-900 text-white shadow-lg">
        <div class="max-w-full mx-auto flex items-center justify-between px-4">
            <div class="flex items-center gap-4">
                <a href="../../index.html" class="flex items-center gap-4 group">
                    <img src="../../treadztntLogo.png" alt="Treadz Logo" class="h-12 w-auto bg-white rounded-md p-0.5">
                </a>
                <span class="text-xl font-bold tracking-tight text-white hidden sm:block">TOWING DASHBOARD</span>
            </div>
            <div class="flex items-center gap-2">
                <a href="../receipt/index.html"
                    class="btn btn-secondary py-2 px-4 flex items-center gap-2 hover:bg-gray-100 hover:text-gray-900 transition-colors text-sm rounded-lg border-transparent text-white bg-transparent">
                    Receipts
                </a>
                <a href="../quote/index.html"
                    class="btn btn-secondary py-2 px-4 flex items-center gap-2 hover:bg-gray-100 hover:text-gray-900 transition-colors text-sm rounded-lg border-transparent text-white bg-transparent">
                    Quote Calculator
                </a>
                <a href="../../index.html"
                    class="btn btn-secondary py-2 px-4 flex items-center gap-2 hover:bg-gray-100 hover:text-gray-900 transition-colors text-sm rounded-lg border-transparent text-white bg-transparent">
                    Inventory
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex h-full overflow-hidden">

        <!-- Left Panel: Inputs & Calculator -->
        <div
            class="w-full lg:w-1/3 bg-white border-r border-gray-200 flex flex-col h-full shadow-xl z-20 overflow-y-auto">
            <div class="p-6 border-b border-gray-100">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="text-blue-600">
                        <path
                            d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2" />
                        <circle cx="7" cy="17" r="2" />
                        <path d="M9 17h6" />
                        <circle cx="17" cy="17" r="2" />
                    </svg>
                    Job Details
                </h2>
            </div>

            <div class="p-6 space-y-6">
                <!-- Locations -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pickup Location</label>
                        <div class="relative">
                            <input type="text" id="pickup-input" placeholder="Enter Pickup Address"
                                class="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="absolute left-3 top-2.5 text-green-500">
                                <circle cx="12" cy="10" r="3" />
                                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z" />
                            </svg>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Dropoff Location (Default:
                            Shop)</label>
                        <div class="relative">
                            <input type="text" id="dropoff-input" placeholder="Enter Destination"
                                value="409 E Main St, Mount Carmel, TN 37645"
                                class="w-full pl-9 pr-3 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm transition-all text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="absolute left-3 top-2.5 text-red-500">
                                <circle cx="12" cy="10" r="3" />
                                <path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z" />
                            </svg>
                        </div>
                    </div>

                    <button id="calculate-route-btn" onclick="calculateRoute()"
                        class="w-full btn bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium flex items-center justify-center gap-2 shadow-sm transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="3 11 22 2 13 21 11 13 3 11"></polygon>
                        </svg>
                        Calculate Route & Miles
                    </button>
                    <div id="route-status" class="text-xs text-center text-gray-500 h-4"></div>
                </div>

                <hr class="border-gray-100">

                <!-- Calculator -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Quote Calculator</h3>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Total Miles</label>
                            <input type="number" id="miles-input" value="0.0" min="0" step="0.1"
                                class="w-full p-2 bg-white border border-gray-300 rounded-lg text-right font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none text-gray-900">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ETA</label>
                            <div id="eta-display"
                                class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-right font-mono text-xs text-gray-500 flex items-center justify-end h-[42px]">
                                -- min
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hook Fee ($)</label>
                            <input type="number" id="hook-fee-input" value="75.00" min="0" step="5"
                                class="w-full p-2 bg-white border border-gray-300 rounded-lg text-right font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none text-gray-900">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rate / Mile ($)</label>
                            <input type="number" id="rate-input" value="4.00" min="0" step="0.50"
                                class="w-full p-2 bg-white border border-gray-300 rounded-lg text-right font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none text-gray-900">
                        </div>
                    </div>
                </div>

                <!-- Total Display -->
                <div class="bg-gray-900 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-gray-400 text-sm font-medium">ESTIMATED QUOTE</span>
                        <div class="text-center">
                            <span class="text-3xl font-bold" id="total-display">$75.00</span>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 pt-2 border-t border-gray-700 mt-2">
                        <span id="mileage-breakdown">0 miles @ $4.00/mi</span>
                        <span>+ Hook Fee</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Leaflet Map -->
        <div class="flex-grow bg-gray-100 flex flex-col p-6 hidden lg:flex">
            <div
                class="bg-white rounded-2xl shadow-sm border border-gray-200 flex-grow p-1 overflow-hidden relative z-0">
                <div id="map"></div>
            </div>
        </div>

    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- ELEMENTS ---
        const milesInput = document.getElementById('miles-input');
        const hookFeeInput = document.getElementById('hook-fee-input');
        const rateInput = document.getElementById('rate-input');
        const totalDisplay = document.getElementById('total-display');
        const breakdownDisplay = document.getElementById('mileage-breakdown');
        const etaDisplay = document.getElementById('eta-display');
        const pickupInput = document.getElementById('pickup-input');
        const dropoffInput = document.getElementById('dropoff-input');
        const btnCalc = document.getElementById('calculate-route-btn');
        const statusDiv = document.getElementById('route-status');

        // --- STATE ---
        let map;
        let routeLayer;
        let markers = [];

        // --- INIT MAP ---
        function initMap() {
            // Default center: Mt Carmel TN
            map = L.map('map').setView([36.5644, -82.6580], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
        }


        // --- OPEN API HELPERS ---
        // 1. Nominatim for Geocoding (Address -> Lat/Lon)
        async function geocode(address, retryCount = 0) {
            try {
                // Bias search to user's region (TN/VA) if state not specified
                let query = address.trim();
                const lower = query.toLowerCase();
                if (!lower.includes(' tn') && !lower.includes(' tennessee') && !lower.includes(' va') && !lower.includes(' virginia')) {
                    query += ", TN";
                }

                // Use 'addressdetails=1' to arguably get better matching
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&addressdetails=1`;

                const response = await fetch(url, {
                    headers: { 'Accept-Language': 'en-US' }
                });

                if (response.status === 429 || response.status === 503) {
                    if (retryCount < 2) {
                        console.warn(`Geocoding rate limited (${response.status}). Retrying...`);
                        await new Promise(r => setTimeout(r, 1500)); // Wait 1.5s
                        return geocode(address, retryCount + 1);
                    }
                    throw new Error(`Geocoding server overload: ${response.status}`);
                }

                if (!response.ok) throw new Error(`Geocoding error: ${response.status}`);

                const text = await response.text();
                try {
                    const data = JSON.parse(text);
                    if (Array.isArray(data) && data.length > 0) {
                        return {
                            lat: parseFloat(data[0].lat),
                            lon: parseFloat(data[0].lon),
                            display_name: data[0].display_name
                        };
                    }
                } catch (e) {
                    console.error("Geocoding invalid JSON response:", text.substring(0, 100));
                }
                return null;

            } catch (error) {
                console.error("Geocoding failed:", error);
                return null;
            }
        }

        // 2. OSRM for Routing (Lat/Lon -> Route geometry & distance)
        async function getRouteData(start, end) {
            try {
                // formatting: lon,lat;lon,lat
                const coords = `${start.lon},${start.lat};${end.lon},${end.lat}`;
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
                    return data.routes[0];
                }
                return null;
            } catch (error) {
                console.error("Routing failed", error);
                return null;
            }
        }


        // --- MAIN LOGIC ---
        async function calculateRoute() {
            const startAddr = pickupInput.value.trim();
            const endAddr = dropoffInput.value.trim();

            if (!startAddr || !endAddr) {
                statusDiv.textContent = "Please enter both addresses.";
                statusDiv.className = "text-xs text-center text-red-500 h-4";
                return;
            }

            statusDiv.textContent = "Calculating route...";
            statusDiv.className = "text-xs text-center text-blue-500 h-4 animate-pulse";
            btnCalc.disabled = true;

            // 1. Geocode
            const start = await geocode(startAddr);
            const end = await geocode(endAddr);

            if (!start || !end) {
                statusDiv.textContent = "Could not find one or both addresses.";
                statusDiv.className = "text-xs text-center text-red-500 h-4";
                btnCalc.disabled = false;
                return;
            }

            // 2. Get Route
            const route = await getRouteData(start, end);

            if (route) {
                // Update Inputs
                const distanceMeters = route.distance;
                const durationSeconds = route.duration;

                // Convert to Miles (1 meter = 0.000621371 mile)
                const distanceMiles = (distanceMeters * 0.000621371).toFixed(1);
                const durationMinutes = Math.round(durationSeconds / 60);

                milesInput.value = distanceMiles;
                etaDisplay.textContent = `${durationMinutes} min`;

                // Trigger Recalc
                calculateTotal();

                // 3. Update Map
                updateMapVisuals(start, end, route.geometry);

                statusDiv.textContent = "Route found!";
                statusDiv.className = "text-xs text-center text-green-600 h-4";

            } else {
                statusDiv.textContent = "Could not calculate driving route.";
                statusDiv.className = "text-xs text-center text-red-500 h-4";
            }

            btnCalc.disabled = false;
        }

        function updateMapVisuals(start, end, geometry) {
            // Clear old
            if (routeLayer) map.removeLayer(routeLayer);
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            // Add Markers
            const startMarker = L.marker([start.lat, start.lon]).addTo(map).bindPopup("Pickup: " + start.display_name);
            const endMarker = L.marker([end.lat, end.lon]).addTo(map).bindPopup("Dropoff: " + end.display_name);
            markers.push(startMarker, endMarker);

            // Add Route Line
            if (geometry) {
                // GeoJSON layer
                routeLayer = L.geoJSON(geometry, {
                    style: { color: 'blue', weight: 5, opacity: 0.7 }
                }).addTo(map);

                // Fit bounds
                const bounds = L.latLngBounds([start.lat, start.lon], [end.lat, end.lon]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }


        // --- CALCULATOR ---
        function calculateTotal() {
            const miles = parseFloat(milesInput.value) || 0;
            const hookFee = parseFloat(hookFeeInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;

            const total = hookFee + (miles * rate);

            totalDisplay.textContent = '$' + total.toFixed(2);
            breakdownDisplay.textContent = `${miles.toFixed(1)} miles @ $${rate.toFixed(2)}/mi`;
        }

        // Listeners
        milesInput.addEventListener('input', calculateTotal);
        hookFeeInput.addEventListener('input', calculateTotal);
        rateInput.addEventListener('input', calculateTotal);

        // Init
        initMap();
        calculateTotal();

    </script>
</body>

</html>