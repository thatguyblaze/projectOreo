<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tow Ticket - Treadz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/style.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .font-signature {
            font-family: 'Dancing Script', cursive;
            font-size: 1.5rem;
            line-height: normal;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .ticket-page {
            width: 100%;
            max-width: 500px;
            /* Slightly wider for modern look */
            margin: 0 auto;
            position: relative;
        }

        .form-input {
            width: 100%;
            background: rgba(243, 244, 246, 0.6);
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            background: white;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .toggle-btn {
            width: 100%;
            padding: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background: white;
            color: #4b5563;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .toggle-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .toggle-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 700;
            color: #111827;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        @media print {
            @page {
                size: A4;
                margin: 0.5cm;
            }

            body {
                font-size: 11px !important;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .ticket-page,
            .glass-panel {
                box-shadow: none !important;
                border: none !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            .print\:hidden,
            .no-print,
            .no-print-bg,
            button,
            nav,
            #history-panel,
            .sidebar-toggle,
            .sticky-footer,
            #sig-pad-wrapper,
            #sig-empty-state,
            .toggle-btn:not(.active),
            #other-agency-input.hidden {
                display: none !important;
            }

            /* Layout Overrides */
            .flex-col {
                flex-direction: row !important;
                /* Force rows where possible */
                flex-wrap: wrap;
            }

            /* Restore Grid for Print */
            .grid {
                display: grid !important;
            }

            /* Force specific print grids */
            .print\:grid-cols-2 {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .print\:gap-x-8 {
                column-gap: 2rem !important;
            }

            /* Input Styling */
            input,
            select,
            textarea {
                border: none !important;
                border-bottom: 1px solid #ccc !important;
                background: transparent !important;
                padding: 0 !important;
                height: auto !important;
                font-size: 11px !important;
                min-height: 0 !important;
                box-shadow: none !important;
                margin-bottom: 2px !important;
            }

            /* Hide dropdown arrows */
            select {
                appearance: none !important;
                -webkit-appearance: none !important;
                background-image: none !important;
            }

            .form-label {
                font-size: 9px !important;
                color: #666 !important;
                margin-bottom: 0 !important;
                text-transform: uppercase;
                font-weight: bold;
            }

            .section-title {
                font-size: 12px !important;
                margin-top: 8px !important;
                margin-bottom: 4px !important;
                padding-bottom: 2px !important;
                border-bottom: 1px solid #000 !important;
            }

            /* Toggle Buttons as Text tags */
            .toggle-btn.active {
                display: inline-block !important;
                background: none !important;
                color: black !important;
                border: 1px solid black !important;
                padding: 1px 6px !important;
                font-size: 10px !important;
                border-radius: 4px;
                margin-right: 4px;
            }

            /* Storage Inputs Hidden */
            #storage-calc-inputs {
                display: none !important;
            }

            /* Print Sig Fallback */
            #sig-empty-state {
                display: block !important;
                border: none !important;
                border-bottom: 1px solid black !important;
                height: 30px !important;
                margin-bottom: 2px !important;
            }

            #sig-empty-state span {
                display: none !important;
            }

            #sig-empty-state::after {
                content: "Customer Signature";
                color: black;
                font-size: 8px;
                display: block;
                margin-top: 32px;
                text-transform: uppercase;
                font-weight: bold;
            }

            /* Images */
            img {
                max-height: 40px !important;
            }
        }
    </style>
</head>

<body class="antialiased flex flex-col min-h-screen">
    <!-- Navigation -->
    <nav class="main-nav sticky top-0 z-40 p-4 w-full print:hidden flex-shrink-0">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <!-- LEFT: Logo & Global Navigation -->
            <div class="flex items-center gap-4 lg:gap-8">
                <!-- Mobile Sidebar Toggle -->
                <button onclick="toggleSidebar()"
                    class="lg:hidden text-white hover:bg-white/10 p-2 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M4 6h16M4 12h16M4 18h7" />
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                    </svg>
                </button>
                <a href="../../index.html" class="flex-shrink-0">
                    <img src="../../treadztntLogo.png" alt="Treadz" class="h-10 w-auto">
                </a>

                <!-- Vertical Divider -->
                <div class="hidden md:block h-6 w-px bg-white/20"></div>

                <!-- Global Nav Items -->
                <div class="hidden md:flex items-center gap-1">
                    <a href="../../index.html"
                        class="btn btn-secondary text-gray-300 hover:text-white hover:bg-white/10 font-medium py-2 px-4 rounded-lg transition-all">Inventory</a>
                    <a href="../index.html"
                        class="btn btn-secondary active font-semibold py-2 px-4 rounded-lg">Towing</a>
                    <a href="../../quote/index.html"
                        class="btn btn-secondary text-gray-300 hover:text-white hover:bg-white/10 font-medium py-2 px-4 rounded-lg transition-all">Quote</a>
                    <a href="../../receipt/index.html"
                        class="btn btn-secondary text-gray-300 hover:text-white hover:bg-white/10 font-medium py-2 px-4 rounded-lg transition-all">Receipts</a>
                </div>
            </div>

            <!-- RIGHT: Actions -->
            <div class="flex items-center gap-2">
                <a href="../index.html" class="btn btn-secondary text-sm font-medium py-2 px-3 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                    Back to Calculator
                </a>
                <button onclick="printTowTicket()"
                    class="btn bg-gray-800 hover:bg-black text-white py-2 px-4 rounded-lg flex items-center gap-2 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 6 2 18 2 18 9"></polyline>
                        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                        <rect x="6" y="14" width="12" height="8"></rect>
                    </svg>
                    <span class="hidden sm:inline">Print</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col lg:flex-row h-full overflow-hidden relative">

        <!-- HISTORY SIDEBAR -->
        <aside id="history-panel"
            class="w-full sm:w-80 lg:w-80 bg-white border-r border-gray-200 flex flex-col shadow-lg z-30 flex-shrink-0 transition-transform duration-300 absolute lg:relative h-full lg:transform-none transform -translate-x-full print:hidden">
            <div class="p-4 border-b border-gray-200 bg-gray-50 sticky top-0 z-10">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Tow History
                    </h3>
                    <button onclick="toggleSidebar()" class="lg:hidden text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="flex gap-2 mb-2">
                    <button onclick="resetTicket()"
                        class="w-full btn btn-sm bg-blue-600 text-white hover:bg-blue-700">New Ticket</button>
                </div>
                <input type="text" placeholder="Search..." oninput="renderHistory(this.value)"
                    class="form-input text-xs">
            </div>
            <div id="history-list" class="flex-grow overflow-y-auto p-2 space-y-2 bg-gray-50"></div>
        </aside>

        <!-- TICKET SECTION -->
        <section
            class="flex-grow overflow-y-auto bg-gray-100 p-4 pb-24 print:p-0 print:overflow-visible flex justify-center w-full">

            <!-- TICKET PAPER -->
            <div id="ticket-body" class="ticket-page glass-panel rounded-2xl p-6 md:p-8 animate-[fadeIn_0.5s_ease-out]">

                <!-- TICKET HEADER -->
                <div class="text-center mb-6 pb-4 border-b-2 border-gray-900 relative">
                    <div class="flex justify-center mb-3">
                        <img src="../../treadztntLogo.png" alt="Treadz" class="h-14 w-auto grayscale contrast-125">
                    </div>
                    <div class="text-xs font-serif leading-tight text-gray-800">
                        <div class="font-bold text-sm tracking-wide">TIRE & TOWING</div>
                        <div>409 Main Street E.</div>
                        <div>Mt. Carmel, TN 37645</div>
                        <div class="font-bold mt-1 text-sm">423-357-4551</div>
                    </div>
                    <div class="absolute top-2 left-0 text-xl font-bold font-serif text-red-600 param-ticket-id">
                        <!-- ID injected via JS -->
                    </div>
                    <div class="absolute top-2 right-0 flex flex-col items-end">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Date</span>
                        <input type="text" id="tt-date"
                            class="text-right text-xs font-bold bg-transparent border-none w-24 p-0">
                    </div>
                </div>

                <!-- 1. CUSTOMER INFO -->
                <div class="mb-6">
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-blue-600">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        CUSTOMER DETIALS
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="form-label">Bill To</label>
                            <input type="text" id="tt-bill-to" class="form-input">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="col-span-2">
                                <label class="form-label">Address</label>
                                <div class="relative">
                                    <input type="text" id="tt-address" class="form-input"
                                        placeholder="Start typing address..." autocomplete="off">
                                    <ul id="address-suggestions"
                                        class="absolute left-0 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-50 hidden max-h-60 overflow-y-auto top-full mt-1">
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="form-label">Phone Number</label>
                            <input type="text" id="tt-phone" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- 2. VEHICLE INFO -->
                <div class="mb-6">
                    <div class="section-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-blue-600">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                        </svg>
                        VEHICLE INFORMATION
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="col-span-2">
                            <label class="form-label">Pickup Location</label>
                            <div class="relative">
                                <input type="text" id="tt-location" class="form-input"
                                    placeholder="Start typing location..." autocomplete="off">
                                <ul id="location-suggestions"
                                    class="absolute left-0 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-50 hidden max-h-60 overflow-y-auto top-full mt-1">
                                </ul>
                            </div>
                        </div>
                        <div class="col-span-2">
                            <label class="form-label">Delivered To</label>
                            <div class="relative">
                                <input type="text" id="tt-delivered" class="form-input"
                                    placeholder="Start typing location..." autocomplete="off">
                                <ul id="delivered-suggestions"
                                    class="absolute left-0 w-full bg-white border border-gray-300 rounded-lg shadow-lg z-50 hidden max-h-60 overflow-y-auto top-full mt-1">
                                </ul>
                            </div>
                        </div>
                        <div class="col-span-2 grid grid-cols-2 gap-2">
                            <div>
                                <label class="form-label">Make</label>
                                <select id="tt-make" class="form-input appearance-none" onchange="updateMakeModel()">
                                    <option value="">Select Make</option>
                                    <option value="Acura">Acura</option>
                                    <option value="Audi">Audi</option>
                                    <option value="BMW">BMW</option>
                                    <option value="Buick">Buick</option>
                                    <option value="Cadillac">Cadillac</option>
                                    <option value="Chevrolet">Chevrolet</option>
                                    <option value="Chrysler">Chrysler</option>
                                    <option value="Dodge">Dodge</option>
                                    <option value="Ford">Ford</option>
                                    <option value="GMC">GMC</option>
                                    <option value="Honda">Honda</option>
                                    <option value="Hyundai">Hyundai</option>
                                    <option value="Infiniti">Infiniti</option>
                                    <option value="Jeep">Jeep</option>
                                    <option value="Kia">Kia</option>
                                    <option value="Lexus">Lexus</option>
                                    <option value="Lincoln">Lincoln</option>
                                    <option value="Mazda">Mazda</option>
                                    <option value="Mercedes-Benz">Mercedes-Benz</option>
                                    <option value="Mercury">Mercury</option>
                                    <option value="Mini">Mini</option>
                                    <option value="Mitsubishi">Mitsubishi</option>
                                    <option value="Nissan">Nissan</option>
                                    <option value="Pontiac">Pontiac</option>
                                    <option value="Ram">Ram</option>
                                    <option value="Subaru">Subaru</option>
                                    <option value="Tesla">Tesla</option>
                                    <option value="Toyota">Toyota</option>
                                    <option value="Volkswagen">Volkswagen</option>
                                    <option value="Volvo">Volvo</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Model</label>
                                <input type="text" id="tt-model" class="form-input" placeholder="Model"
                                    list="model-list" oninput="updateMakeModel()">
                                <datalist id="model-list"></datalist>
                            </div>
                            <input type="hidden" id="tt-make-model">
                        </div>
                        <div>
                            <label class="form-label">Tag Number</label>
                            <input type="text" id="tt-tag" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">Color</label>
                            <select id="tt-color" class="form-input appearance-none">
                                <option value="">Select...</option>
                                <option value="Black">Black</option>
                                <option value="White">White</option>
                                <option value="Silver">Silver</option>
                                <option value="Gray">Gray</option>
                                <option value="Red">Red</option>
                                <option value="Blue">Blue</option>
                                <option value="Brown">Brown</option>
                                <option value="Green">Green</option>
                                <option value="Beige">Beige</option>
                                <option value="Gold">Gold</option>
                                <option value="Orange">Orange</option>
                                <option value="Yellow">Yellow</option>
                                <option value="Purple">Purple</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Mileage</label>
                            <input type="number" id="tt-mileage" class="form-input">
                        </div>
                        <div>
                            <label class="form-label">VIN #</label>
                            <input type="text" id="tt-vin" class="form-input font-mono tracking-wider text-xs">
                        </div>
                    </div>
                </div>

                <!-- 3. DAMAGE & AGENCY -->
                <div class="mb-6 bg-gray-50/50 p-4 rounded-xl border border-gray-100 no-print-bg">
                    <!-- Agency Toggles -->
                    <div class="mb-4">
                        <label class="form-label mb-2">AGENCY / POLICE</label>
                        <div class="grid grid-cols-4 gap-2">
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-group="agency"
                                data-value="Hawkins">Hawkins</button>
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-group="agency"
                                data-value="KPD">KPD</button>
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-group="agency"
                                data-value="THP">THP</button>
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-group="agency"
                                data-value="Other">Other</button>
                        </div>
                        <input type="text" id="other-agency-input" class="form-input mt-2 hidden"
                            placeholder="Specify Agency...">
                    </div>

                    <!-- Damage Toggles -->
                    <div>
                        <label class="form-label mb-2">VEHICLE DAMAGE</label>
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-value="FRT">Front (FRT)</button>
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-value="REAR">Rear</button>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-value="LF">LF</button>
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-value="RF">RF</button>
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-value="RR">RR</button>
                            <button class="toggle-btn" onclick="toggleBtn(this)" data-value="LR">LR</button>
                        </div>
                    </div>
                </div>

                <!-- 4. FEES & CHARGES -->
                <div class="mb-4 print:mb-2">
                    <div
                        class="section-title flex items-center gap-2 text-lg font-bold text-gray-800 border-b border-gray-200 pb-2 mb-4 print:text-sm print:mb-2 print:pb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="text-blue-600 print:hidden">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        FEES & CHARGES
                    </div>

                    <div
                        class="space-y-2 text-sm print:grid print:grid-cols-2 print:gap-x-8 print:gap-y-1 print:space-y-0">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Base Tow</span>
                            <input type="number" id="tt-fee-base" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Winch Fees</span>
                            <input type="number" id="tt-fee-winch" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Clean-Up</span>
                            <input type="number" id="tt-fee-clean" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">VTS/ Admin Fee</span>
                            <input type="number" id="tt-fee-admin" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Additional Labor</span>
                            <input type="number" id="tt-fee-labor" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Mileage Charges</span>
                            <input type="number" id="tt-fee-mileage" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Gate Fee(s)</span>
                            <input type="number" id="tt-fee-gate" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Misc. Fees</span>
                            <input type="number" id="tt-fee-misc" inputmode="decimal"
                                class="text-right font-bold w-24 bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500"
                                onchange="calcTicketTotal()">
                        </div>
                    </div>

                </div>

                <!-- Storage Calc -->
                <div
                    class="mt-4 p-3 bg-blue-50 border border-blue-100 rounded-lg no-print-bg print:mt-2 print:p-0 print:border-none">
                    <div id="storage-calc-inputs">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-blue-800 uppercase">Storage Calculator</span>
                        </div>
                        <div class="flex justify-between items-center text-sm w-full">
                            <div class="grid grid-cols-3 gap-2 w-full">
                                <button class="toggle-btn" onclick="toggleBtn(this)" data-group="store-rate"
                                    data-value="35">$35</button>
                                <button class="toggle-btn" onclick="toggleBtn(this)" data-group="store-rate"
                                    data-value="40">$40</button>
                                <button class="toggle-btn active" onclick="toggleBtn(this)" data-group="store-rate"
                                    data-value="45">$45</button>
                            </div>
                        </div>

                        <!-- Date Selection for Storage -->
                        <div class="mt-3 grid grid-cols-2 gap-3 mb-2">
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">In Date/Time</label>
                                <input type="datetime-local" id="tt-store-start" class="form-input text-xs p-1"
                                    onchange="updateStorageDays()">
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold text-gray-500">Released Date/Time</label>
                                <div class="flex items-center gap-1">
                                    <input type="datetime-local" id="tt-store-end" class="form-input text-xs p-1"
                                        onchange="updateStorageDays()">
                                    <button onclick="setReleasedToNow()"
                                        class="btn btn-sm btn-ghost p-1 text-blue-600 border border-blue-200 rounded hover:bg-blue-50"
                                        title="Set Release Time to Now">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End Storage Inputs Wrapper -->

                    <!-- Storage Result (Always Visible) -->
                    <div class="mt-2 text-sm border-t border-blue-200 pt-2 print:border-none print:pt-0">
                    </div>
                </div>

                <div class="flex justify-end items-center gap-2">
                    <span class="text-sm font-bold text-gray-700">Billable Days:</span>
                    <div class="flex items-center gap-1">
                        <input type="number" id="tt-store-days"
                            class="w-16 text-center font-bold bg-white border border-gray-300 rounded p-1"
                            onchange="calcTicketTotal()" placeholder="0">
                    </div>
                </div>
            </div>

            <!-- TOTALS -->
            <div class="mt-6 pt-4 border-t-2 border-gray-200">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-sm font-medium text-gray-500">Tow Total</span>
                    <span id="display-tow-total" class="font-bold text-gray-800">$0.00</span>
                </div>
                <div class="flex justify-between items-end mb-1">
                    <span class="text-sm font-medium text-gray-500">Storage Total</span>
                    <span id="display-store-subtotal" class="font-bold text-gray-800">$0.00</span>
                </div>
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-medium text-gray-400">Storage Tax (3.5%)</span>
                    <span id="display-store-tax" class="font-bold text-gray-600">$0.00</span>
                    <input type="hidden" id="tt-total-storage">
                </div>
                <div class="flex justify-between items-end mt-4 pt-4 border-t border-gray-200">
                    <span class="text-lg font-black text-gray-900">TOTAL DUE</span>
                    <input type="text" id="tt-total-due"
                        class="text-right font-black text-2xl bg-transparent border-none text-blue-600 w-40" readonly>
                </div>
            </div>
            </div>

            <!-- 5. FOOTER & NOTES -->
            <div>
                <label class="form-label">Notes</label>
                <textarea id="tt-notes" class="form-input h-20 resize-none mb-4"></textarea>

                <p class="text-[10px] text-gray-500 leading-tight text-justify mb-6">
                    I have removed all personal belongings from my vehicle and hold No one responsible for lost or
                    stolen items. Towing Company is not Responsible for any damages incurred while towing and/or
                    winching vehicle.
                </p>

                <!-- Signatures -->
                <div class="grid grid-cols-1 print:grid-cols-2 gap-6 items-end">
                    <div>
                        <!-- Signature State: Empty -->
                        <div id="sig-empty-state"
                            class="border-b border-black pt-8 cursor-pointer hover:bg-gray-50 transition-colors"
                            onclick="openSignaturePad()">
                            <span
                                class="text-[10px] font-bold uppercase tracking-widest text-blue-600 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                                Click to Sign Customer Signature
                            </span>
                        </div>

                        <!-- Signature State: Signing (Canvas) -->
                        <div id="sig-pad-wrapper" class="hidden border border-gray-300 rounded bg-gray-50 p-2">
                            <canvas id="sig-canvas"
                                class="w-full h-32 bg-white border border-gray-200 rounded touch-none cursor-crosshair mb-2"></canvas>
                            <div class="flex justify-between items-center">
                                <button type="button" onclick="clearSignature()"
                                    class="text-xs text-red-500 font-bold uppercase tracking-wider px-2 py-1">Clear</button>
                                <span class="text-[10px] text-gray-400">Sign Above</span>
                                <button type="button" onclick="saveSignature()"
                                    class="text-xs bg-blue-600 text-white font-bold uppercase tracking-wider px-3 py-1 rounded">Apply</button>
                            </div>
                        </div>

                        <!-- Signature State: Signed (Image) -->
                        <div id="sig-result" class="hidden border-b border-black pb-1 cursor-pointer relative group"
                            onclick="openSignaturePad()">
                            <img id="sig-image" class="h-12 object-contain" alt="Customer Signature">
                            <div
                                class="absolute inset-0 bg-white/80 hidden group-hover:flex items-center justify-center text-xs font-bold text-gray-500">
                                Click to Re-Sign
                            </div>
                            <span
                                class="text-[10px] font-bold uppercase tracking-widest text-gray-400 block mt-1">Customer
                                Signature</span>
                        </div>
                    </div>
                    <div class="flex items-end gap-2">
                        <div class="flex-grow">
                            <label class="form-label block mb-1">Driver</label>
                            <select id="tt-driver"
                                class="appearance-none bg-transparent border-b border-black rounded-none p-0 pb-1 font-bold text-gray-800 focus:ring-0 focus:border-blue-500 w-full outline-none transition-all"
                                placeholder="Select Driver" onchange="saveDriver()">
                                <option value="" class="font-sans text-base">Select Driver</option>
                                <option value="Tyler" class="font-sans text-base">Tyler</option>
                                <option value="David" class="font-sans text-base">David</option>
                                <option value="Bucky" class="font-sans text-base">Bucky</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer moved to sticky bar -->
            </div>

            </div>
            </div>

            <!-- Sticky Footer Actions -->
            <div
                class="fixed bottom-0 right-0 left-0 lg:left-80 bg-white/95 backdrop-blur border-t border-gray-200 p-4 z-20 flex justify-center print:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
                <div class="w-full max-w-3xl flex justify-between items-center gap-4">
                    <button onclick="downloadTowTicket()"
                        class="text-gray-600 hover:text-blue-800 text-sm font-bold uppercase tracking-wider flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download PDF
                    </button>

                    <button onclick="printTowTicket()"
                        class="btn btn-primary py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all text-lg font-bold flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2">
                            </path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        PRINT TICKET
                    </button>
                </div>
            </div>
        </section>
    </main>

    <script src="../../js/mobile-nav.js"></script>
    <script>
        // Init Logic
        let currentTicketId = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderHistory();

            // Initial load or new ticket
            const savedLatest = localStorage.getItem('treadz_tow_latest_id');
            if (savedLatest) {
                // Optionally load latest? Or start new?
                // Let's check query param or load latest
                loadTicket(savedLatest);
            } else {
                resetTicket(); // Start visible new logic
            }

            initStorageDates();
            populateFromStorage();
        });

        // --- HISTORY & STORAGE ---
        function getHistory() {
            try { return JSON.parse(localStorage.getItem('treadzTowHistoryV1')) || []; }
            catch { return []; }
        }

        function saveTicket() {
            const id = document.querySelector('.param-ticket-id').innerText;
            if (!id) return;

            const history = getHistory();

            // Gather Data
            const ticketData = {
                id: id,
                date: document.getElementById('tt-date').value,
                billTo: document.getElementById('tt-bill-to').value,
                vehicle: (document.getElementById('tt-year')?.value || '') + ' ' + (document.getElementById('tt-make').value || '') + ' ' + (document.getElementById('tt-model').value || ''),
                vin: document.getElementById('tt-vin').value,
                total: document.getElementById('tt-total-due').value,
                timestamp: new Date().toISOString(),
                // Save all fields (simplified for this example, essentially saving whole state requires mapping all IDs)
                // For a robust system, we should map every ID.
                // Sticking to minimal "Reload" data or full state?
                // I will save the "snapshot" for history list, and full HTML or JSON for restore?
                // JSON is better. I'll save the key fields.
                fields: {
                    billTo: document.getElementById('tt-bill-to').value,
                    address: document.getElementById('tt-address').value,
                    phone: document.getElementById('tt-phone').value,
                    location: document.getElementById('tt-location').value,
                    delivered: document.getElementById('tt-delivered').value,
                    make: document.getElementById('tt-make').value,
                    model: document.getElementById('tt-model').value,
                    tag: document.getElementById('tt-tag').value,
                    color: document.getElementById('tt-color').value,
                    mileage: document.getElementById('tt-mileage').value,
                    vin: document.getElementById('tt-vin').value,
                    feeBase: document.getElementById('tt-fee-base').value,
                    feeWinch: document.getElementById('tt-fee-winch').value,
                    feeClean: document.getElementById('tt-fee-clean').value,
                    feeAdmin: document.getElementById('tt-fee-admin').value,
                    feeLabor: document.getElementById('tt-fee-labor').value,
                    feeMileage: document.getElementById('tt-fee-mileage').value,
                    feeGate: document.getElementById('tt-fee-gate').value,
                    feeMisc: document.getElementById('tt-fee-misc').value,
                    storeRate: document.querySelector('.toggle-btn[data-group="store-rate"].active')?.dataset.value || 45,
                    storeStart: document.getElementById('tt-store-start').value,
                    storeEnd: document.getElementById('tt-store-end').value,
                    storeDays: document.getElementById('tt-store-days').value,
                    notes: document.getElementById('tt-notes').value,
                    driver: document.getElementById('tt-driver').value
                }
            };

            // Upsert
            const index = history.findIndex(t => t.id === id);
            if (index >= 0) {
                history[index] = ticketData; // Update
            } else {
                history.unshift(ticketData); // Add new
            }

            // Limit and Save
            if (history.length > 50) history.pop();
            localStorage.setItem('treadzTowHistoryV1', JSON.stringify(history));
            localStorage.setItem('treadz_tow_latest_id', id);

            renderHistory();
        }

        function loadTicket(id) {
            const history = getHistory();
            const ticket = history.find(t => t.id === id);
            if (!ticket) return;

            // Restore UI
            document.querySelector('.param-ticket-id').innerText = ticket.id;
            document.getElementById('tt-date').value = ticket.date;

            // Restore Fields
            const f = ticket.fields;
            if (f) {
                document.getElementById('tt-bill-to').value = f.billTo || '';
                document.getElementById('tt-address').value = f.address || '';
                document.getElementById('tt-phone').value = f.phone || '';
                document.getElementById('tt-location').value = f.location || '';
                document.getElementById('tt-delivered').value = f.delivered || '';
                document.getElementById('tt-make').value = f.make || '';
                document.getElementById('tt-model').value = f.model || '';
                document.getElementById('tt-tag').value = f.tag || '';
                document.getElementById('tt-color').value = f.color || '';
                document.getElementById('tt-mileage').value = f.mileage || '';
                document.getElementById('tt-vin').value = f.vin || '';

                document.getElementById('tt-fee-base').value = f.feeBase || '';
                document.getElementById('tt-fee-winch').value = f.feeWinch || '';
                document.getElementById('tt-fee-clean').value = f.feeClean || '';
                document.getElementById('tt-fee-admin').value = f.feeAdmin || '';
                document.getElementById('tt-fee-labor').value = f.feeLabor || '';
                document.getElementById('tt-fee-mileage').value = f.feeMileage || '';
                document.getElementById('tt-fee-gate').value = f.feeGate || '';
                document.getElementById('tt-fee-misc').value = f.feeMisc || '';

                document.getElementById('tt-store-start').value = f.storeStart || '';
                document.getElementById('tt-store-end').value = f.storeEnd || '';
                document.getElementById('tt-store-days').value = f.storeDays || '';

                document.getElementById('tt-notes').value = f.notes || '';
                if (f.driver) document.getElementById('tt-driver').value = f.driver;

                // Toggle Rate
                const rate = f.storeRate || 45;
                const rateBtns = document.querySelectorAll('.toggle-btn[data-group="store-rate"]');
                rateBtns.forEach(b => {
                    b.classList.remove('active');
                    if (b.dataset.value == rate) b.classList.add('active');
                });
            }

            currentTicketId = id;
            calcTicketTotal();
        }

        function resetTicket() {
            // Generate New ID
            const id = Math.floor(Math.random() * 9000) + 1000;
            document.querySelector('.param-ticket-id').innerText = id;
            document.getElementById('tt-date').value = new Date().toLocaleDateString();

            // Clear inputs
            document.querySelectorAll('.form-input, input:not([type="radio"]):not([type="checkbox"]), select, textarea').forEach(i => {
                // specific checks to avoid clearing date or id if they were selected
                if (i.id !== 'tt-date' && !i.classList.contains('param-ticket-id')) i.value = '';
            });
            document.getElementById('tt-store-days').value = 0;

            // Reset Agency Toggles
            document.querySelectorAll('.toggle-btn[data-group="agency"]').forEach(b => {
                b.classList.remove('active');
                if (b.innerText.includes('Hawkins')) b.classList.add('active'); // Default
            });
            const otherInput = document.getElementById('other-agency-input');
            if (otherInput) otherInput.classList.add('hidden');

            // Reset Store Rate (Default 45)
            document.querySelectorAll('.toggle-btn[data-group="store-rate"]').forEach(b => {
                b.classList.remove('active');
                if (b.dataset.value == '45') b.classList.add('active');
            });

            // Restore driver pref
            const savedDriver = localStorage.getItem('treadz_tow_driver');
            if (savedDriver) {
                document.getElementById('tt-driver').value = savedDriver;
                // Update visuals
                if (typeof saveDriver === 'function') saveDriver();
            }

            // Clear Signatures
            if (typeof clearSignature === 'function') {
                clearSignature();
                const sigImg = document.getElementById('sig-image');
                const sigRes = document.getElementById('sig-result');
                const sigEmpty = document.getElementById('sig-empty-state');
                if (sigImg) sigImg.src = '';
                if (sigRes) sigRes.classList.add('hidden');
                if (sigEmpty) sigEmpty.classList.remove('hidden');
            }

            initStorageDates();
            calcTicketTotal();
        }

        function renderHistory(query = '') {
            const list = document.getElementById('history-list');
            list.innerHTML = '';

            const history = getHistory().filter(t => {
                if (!query) return true;
                const txt = (t.id + t.billTo + t.vehicle).toLowerCase();
                return txt.includes(query.toLowerCase());
            });

            history.forEach(t => {
                const div = document.createElement('div');
                div.className = "p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md cursor-pointer transition-all";
                div.onclick = () => loadTicket(t.id);
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <span class="font-bold text-gray-800 text-sm">#${t.id}</span>
                        <span class="text-xs text-gray-500">${t.date}</span>
                    </div>
                    <div class="text-xs font-bold text-gray-700 truncate mt-1">${t.billTo || 'Unknown Customer'}</div>
                    <div class="text-xs text-gray-500 truncate">${t.vehicle || 'Vehicle Info'}</div>
                    <div class="mt-2 flex justify-between items-end border-t border-gray-100 pt-1">
                        <span class="font-bold text-blue-600 text-xs">${t.total || '$0.00'}</span>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('history-panel');
            sidebar.classList.toggle('-translate-x-full');
        }

        // Auto Save Listener
        document.getElementById('ticket-body').addEventListener('input', debounce(() => {
            saveTicket();
        }, 1000));



        // Toggle Button Logic
        function toggleBtn(btn) {
            // Check if it's a radio-style group (like agencies)
            const group = btn.dataset.group;
            if (group) {
                // Deselect others in group
                document.querySelectorAll(`.toggle-btn[data-group="${group}"]`).forEach(b => {
                    if (b !== btn) b.classList.remove('active');
                });
            }

            btn.classList.toggle('active');

            // Handle "Other" input visibility
            if (btn.dataset.value === 'Other') {
                const input = document.getElementById('other-agency-input');
                if (btn.classList.contains('active')) {
                    input.classList.remove('hidden');
                    input.focus();
                } else {
                    input.classList.add('hidden');
                }
            } else if (group === 'agency') {
                // Hide "Other" input if switching to another agency
                document.getElementById('other-agency-input').classList.add('hidden');
            }

            // Agency Price Logic
            if (group === 'agency' && btn.classList.contains('active')) {
                const val = btn.dataset.value;
                const baseInput = document.getElementById('tt-fee-base');
                const adminInput = document.getElementById('tt-fee-admin');

                if (val === 'Hawkins' || val === 'KPD') {
                    baseInput.value = 225;
                    adminInput.value = 175;
                } else if (val === 'THP') {
                    baseInput.value = 375;
                    adminInput.value = 175;
                }
                // Trigger calc
                calcTicketTotal();
            }

            // Storage Rate Logic
            if (group === 'store-rate') {
                calcTicketTotal();
            }
        }

        function updateStorageDays() {
            const startVal = document.getElementById('tt-store-start').value;
            const endVal = document.getElementById('tt-store-end').value;

            if (startVal) {
                const start = new Date(startVal);
                // If end date is empty, assume "Now" (Ongoing) but don't auto-fill input unless clicked
                const end = endVal ? new Date(endVal) : new Date();

                // Diff in milliseconds
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                document.getElementById('tt-store-days').value = diffDays > 0 ? diffDays : 0;
                calcTicketTotal();
            }
        }

        function setReleasedToNow() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
            document.getElementById('tt-store-end').value = localISOTime;
            updateStorageDays();
        }

        function initStorageDates() {
            const now = new Date();

            // Format for datetime-local: YYYY-MM-DDTHH:mm
            const toLocalISO = (date) => {
                const offset = date.getTimezoneOffset() * 60000; // offset in milliseconds
                const localISOTime = (new Date(date - offset)).toISOString().slice(0, 16);
                return localISOTime;
            };

            // Leave End Date empty to imply "Ongoing" (auto-calcs to now)
            document.getElementById('tt-store-end').value = "";
            document.getElementById('tt-store-start').value = toLocalISO(now);
        }

        // Try to read query params or local storage from calculator if we want to be fancy
        function populateFromStorage() {
            // For now just basic defaults
        }

        function calcTicketTotal() {
            // Sum Fees
            const feeIds = ['tt-fee-base', 'tt-fee-winch', 'tt-fee-clean', 'tt-fee-admin', 'tt-fee-labor', 'tt-fee-mileage', 'tt-fee-gate', 'tt-fee-misc'];

            let towTotal = 0;
            feeIds.forEach(id => {
                towTotal += parseFloat(document.getElementById(id).value) || 0;
            });

            document.getElementById('display-tow-total').innerText = '$' + towTotal.toFixed(2);


            // Storage
            let storeRate = 0;
            const activeRateBtn = document.querySelector('.toggle-btn[data-group="store-rate"].active');
            if (activeRateBtn) {
                storeRate = parseFloat(activeRateBtn.dataset.value);
            }

            const days = parseFloat(document.getElementById('tt-store-days').value) || 0;
            const storeSubtotal = storeRate * days;
            const storeTax = storeSubtotal * 0.035;
            const storeTotal = storeSubtotal + storeTax;

            document.getElementById('display-store-subtotal').innerText = '$' + storeSubtotal.toFixed(2);
            document.getElementById('display-store-tax').innerText = '$' + storeTax.toFixed(2);
            document.getElementById('tt-total-storage').value = storeTotal.toFixed(2);

            const total = towTotal + storeTotal;
            document.getElementById('tt-total-due').value = '$' + total.toFixed(2);
        }

        function printTowTicket() {
            saveTicket();
            window.print();
        }

        function downloadTowTicket() {
            const element = document.getElementById('ticket-body');
            const id = document.querySelector('.param-ticket-id').innerText;

            const opt = {
                margin: 0,
                filename: `Treadz_TowTicket_${id}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'in', format: [4.5, 11], orientation: 'portrait' }
            };

            // Temporary styles for PDF generation if needed
            html2pdf().set(opt).from(element).save();
        }

        // --- Autocomplete Logic ---
        function updateMakeModel() {
            const make = document.getElementById('tt-make').value;
            const model = document.getElementById('tt-model').value;
            document.getElementById('tt-make-model').value = (make + ' ' + model).trim();
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function fetchSuggestions(text) {
            const url = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/suggest?text=${encodeURIComponent(text)}&f=json&maxSuggestions=5`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.suggestions || [];
            } catch (e) {
                console.error("Autocomplete error:", e);
                return [];
            }
        }

        function setupAutocomplete(inputId, containerId) {
            const input = document.getElementById(inputId);
            const container = document.getElementById(containerId);

            const handleInput = debounce(async (e) => {
                const text = e.target.value;
                if (!text || text.length < 3) {
                    container.classList.add('hidden');
                    return;
                }
                const suggestions = await fetchSuggestions(text);

                container.innerHTML = '';
                if (suggestions.length > 0) {
                    suggestions.forEach(s => {
                        const li = document.createElement('li');
                        li.className = "px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm text-gray-700 border-b last:border-0 border-gray-100";
                        li.innerText = s.text;
                        li.onclick = () => {
                            input.value = s.text;
                            container.classList.add('hidden');
                        };
                        container.appendChild(li);
                    });
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            }, 300);

            input.addEventListener('input', handleInput);

            // Close on click outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !container.contains(e.target)) {
                    container.classList.add('hidden');
                }
            });
        }

        // Initialize Autocomplete
        setupAutocomplete('tt-address', 'address-suggestions');
        setupAutocomplete('tt-location', 'location-suggestions');
        setupAutocomplete('tt-delivered', 'delivered-suggestions');

        // Car Models Data
        const carModels = {
            'Acura': ['MDX', 'RDX', 'TLX', 'ILX', 'Integra'],
            'Audi': ['A3', 'A4', 'A6', 'Q3', 'Q5', 'Q7', 'Q8'],
            'BMW': ['3 Series', '5 Series', 'X3', 'X5', 'X7', 'M3', 'M4'],
            'Buick': ['Encore', 'Enclave', 'Envision'],
            'Cadillac': ['Escalade', 'XT5', 'XT6', 'CT4', 'CT5'],
            'Chevrolet': ['Silverado', 'Equinox', 'Malibu', 'Tahoe', 'Suburban', 'Traverse', 'Colorado', 'Blazer', 'Camaro', 'Corvette'],
            'Chrysler': ['300', 'Pacifica', 'Voyager'],
            'Dodge': ['Ram 1500', 'Charger', 'Challenger', 'Durango', 'Grand Caravan'],
            'Ford': ['F-150', 'F-250', 'Explorer', 'Escape', 'Edge', 'Expedition', 'Mustang', 'Bronco', 'Ranger', 'Maverick'],
            'GMC': ['Sierra', 'Terrain', 'Acadia', 'Yukon', 'Canyon'],
            'Honda': ['Civic', 'Accord', 'CR-V', 'Pilot', 'Odyssey', 'HR-V', 'Passport', 'Ridgeline'],
            'Hyundai': ['Elantra', 'Sonata', 'Tucson', 'Santa Fe', 'Palisade', 'Kona'],
            'Infiniti': ['Q50', 'QX60', 'QX80', 'QX50'],
            'Jeep': ['Wrangler', 'Grand Cherokee', 'Cherokee', 'Compass', 'Renegade', 'Gladiator'],
            'Kia': ['Forte', 'Optima', 'K5', 'Sportage', 'Sorento', 'Telluride', 'Soul'],
            'Lexus': ['RX', 'NX', 'ES', 'IS', 'GX', 'LX'],
            'Lincoln': ['Navigator', 'Aviator', 'Corsair', 'Nautilus'],
            'Mazda': ['CX-5', 'CX-30', 'CX-9', 'Mazda3', 'Miata'],
            'Mercedes-Benz': ['C-Class', 'E-Class', 'S-Class', 'GLC', 'GLE', 'GLS', 'G-Class'],
            'Mercury': ['Grand Marquis', 'Mountaineer', 'Mariner'],
            'Mini': ['Cooper', 'Countryman', 'Clubman'],
            'Mitsubishi': ['Outlander', 'Eclipse Cross', 'Mirage'],
            'Nissan': ['Altima', 'Rogue', 'Sentra', 'Maxima', 'Murano', 'Pathfinder', 'Frontier', 'Titan'],
            'Pontiac': ['Grand Prix', 'G6', 'Vibe'],
            'Ram': ['1500', '2500', '3500'],
            'Subaru': ['Outback', 'Forester', 'Crosstrek', 'Impreza', 'Ascent'],
            'Tesla': ['Model 3', 'Model Y', 'Model S', 'Model X', 'Cybertruck'],
            'Toyota': ['Camry', 'Corolla', 'RAV4', 'Highlander', 'Tacoma', 'Tundra', '4Runner', 'Prius', 'Sienna'],
            'Volkswagen': ['Jetta', 'Passat', 'Tiguan', 'Atlas', 'Golf'],
            'Volvo': ['XC90', 'XC60', 'XC40', 'S60', 'S90']
        };

        // Listen for Make changes to populate Model list
        document.getElementById('tt-make').addEventListener('change', function () {
            const make = this.value;
            const dataList = document.getElementById('model-list');
            const modelInput = document.getElementById('tt-model');

            dataList.innerHTML = ''; // Clear existing
            modelInput.value = ''; // Clear model input on make change

            if (make && carModels[make]) {
                carModels[make].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    dataList.appendChild(option);
                });
            }
            updateMakeModel();
        });

        // Driver Persistence
        function saveDriver() {
            const driverSelect = document.getElementById('tt-driver');
            const driver = driverSelect.value;
            localStorage.setItem('treadz_tow_driver', driver);

            // Toggle Signature Font
            if (driver) {
                driverSelect.classList.add('font-signature', 'text-2xl', 'text-blue-900');
                driverSelect.classList.remove('font-bold', 'text-gray-800');
            } else {
                driverSelect.classList.remove('font-signature', 'text-2xl', 'text-blue-900');
                driverSelect.classList.add('font-bold', 'text-gray-800');
            }
        }

        // Load Driver Preference on Init
        const savedDriver = localStorage.getItem('treadz_tow_driver');
        if (savedDriver) {
            const driverSelect = document.getElementById('tt-driver');
            if (driverSelect) {
                driverSelect.value = savedDriver;
                // Trigger visual update
                saveDriver();
            }
        }

        // --- Signature Pad Logic ---
        const sigCanvas = document.getElementById('sig-canvas');
        const sigCtx = sigCanvas.getContext('2d');
        let isSigning = false;

        // Resize canvas to correct resolution
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            sigCanvas.width = sigCanvas.offsetWidth * ratio;
            sigCanvas.height = sigCanvas.offsetHeight * ratio;
            sigCtx.scale(ratio, ratio);
            sigCtx.lineWidth = 2; // Fixed line width
            sigCtx.lineCap = 'round';
            sigCtx.strokeStyle = '#000';
        }

        function openSignaturePad() {
            document.getElementById('sig-empty-state').classList.add('hidden');
            document.getElementById('sig-result').classList.add('hidden');
            document.getElementById('sig-pad-wrapper').classList.remove('hidden');

            // Wait for display change to effect layout, then resize
            setTimeout(resizeCanvas, 10);
        }

        function clearSignature() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            sigCtx.clearRect(0, 0, sigCanvas.width / ratio, sigCanvas.height / ratio);
        }

        function saveSignature() {
            // Check if empty? (optional)

            const dataUrl = sigCanvas.toDataURL('image/png');
            document.getElementById('sig-image').src = dataUrl;

            document.getElementById('sig-pad-wrapper').classList.add('hidden');
            document.getElementById('sig-result').classList.remove('hidden');
        }

        // Drawing Event Listeners
        function getPos(e) {
            const rect = sigCanvas.getBoundingClientRect();
            // Handle touch or mouse
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startSign(e) {
            isSigning = true;
            // Allow default for mouse, prevent for touch to stop scroll
            if (e.type === 'touchstart') e.preventDefault();

            const pos = getPos(e);
            sigCtx.beginPath();
            sigCtx.moveTo(pos.x, pos.y);
        }

        function moveSign(e) {
            if (!isSigning) return;
            if (e.type === 'touchmove') e.preventDefault();

            const pos = getPos(e);
            sigCtx.lineTo(pos.x, pos.y);
            sigCtx.stroke();
        }

        function endSign(e) {
            isSigning = false;
        }

        // Attach listeners
        sigCanvas.addEventListener('mousedown', startSign);
        sigCanvas.addEventListener('touchstart', startSign, { passive: false });

        sigCanvas.addEventListener('mousemove', moveSign);
        sigCanvas.addEventListener('touchmove', moveSign, { passive: false });

        document.addEventListener('mouseup', endSign);
        document.addEventListener('touchend', endSign);

    </script>
</body>

</html>