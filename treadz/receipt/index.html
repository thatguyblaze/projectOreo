<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treadz - Receipt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* The Paper Receipt Look */
        .paper-receipt {
            font-family: "Times New Roman", Times, serif;
            color: black;
            background: white;
            position: relative;
        }

        .paper-receipt input {
            font-family: inherit;
            color: inherit;
        }

        .paper-receipt input::placeholder {
            color: #ccc;
            font-style: italic;
        }

        /* Table Styling */
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid black;
        }

        .receipt-table th {
            border-right: 2px solid black;
            border-bottom: 2px solid black;
            padding: 4px;
            text-transform: uppercase;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }

        .receipt-table td {
            border-right: 2px solid black;
            border-bottom: 1px solid black;
            padding: 4px;
            font-size: 16px;
            height: 32px;
            /* Fixed height for rows */
            vertical-align: middle;
        }

        .receipt-table tr:last-child td {
            border-bottom: none;
        }

        .receipt-table td.no-border-right {
            border-right: none;
        }

        /* Totals Box */
        .totals-box {
            border-collapse: collapse;
            width: 100%;
        }

        .totals-box td {
            border: 1px solid black;
            padding: 4px 8px;
        }

        .totals-box .label {
            font-weight: bold;
            text-transform: uppercase;
            font-size: 12px;
            text-align: right;
            border-right: 2px solid black !important;
            width: 90px;
        }

        .totals-box .amount {
            font-weight: bold;
            text-align: right;
            font-size: 16px;
        }

        /* Screen only override for main layout */
        @media screen {
            #receipt-container {
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            }
        }

        /* Print Override */
        @media print {
            @page {
                margin: 0.25in;
                size: letter;
            }

            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Hide UI scaffolding */
            .main-nav,
            #history-panel,
            #upsell-panel,
            .screen-only,
            button,
            .print-hidden,
            .print\:hidden {
                display: none !important;
            }

            #app,
            main,
            section {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                background: white !important;
            }

            #receipt-container {
                box-shadow: none !important;
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                min-height: 0 !important;
                background: white !important;
            }

            /* Clean up inputs for print */
            input {
                border: none !important;
                background: transparent !important;
                width: auto !important;
                padding: 0 !important;
            }

            input::placeholder {
                color: transparent !important;
            }

            /* Hide spinner on number inputs */
            input[type=number]::-webkit-inner-spin-button,
            input[type=number]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .receipt-table,
            .receipt-table td,
            .receipt-table th,
            .totals-box td {
                border-color: black !important;
            }

            /* Specific fix for gray backgrounds in print */
            .bg-gray-50,
            .bg-gray-100,
            .bg-gray-200,
            .bg-gray-900 {
                background-color: transparent !important;
            }

            /* Ensure Card Preview is hidden */
            #card-total-preview-container {
                display: none !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="antialiased h-screen flex flex-col overflow-hidden bg-gray-100">
    <div id="app" class="flex-grow flex flex-col h-full">
        <!-- Navigation -->
        <nav class="main-nav sticky top-0 z-40 p-4 w-full print:hidden flex-shrink-0 bg-gray-900 text-white shadow-lg">
            <div class="max-w-full mx-auto flex items-center justify-between px-4">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="3" y1="12" x2="21" y2="12"></line>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <line x1="3" y1="18" x2="21" y2="18"></line>
                        </svg>
                    </button>
                    <a href="../index.html" class="flex items-center gap-4 group">
                        <img src="../treadztntLogo.png" alt="Treadz Logo" class="h-10 w-auto bg-white rounded-md p-0.5">
                    </a>
                    <span class="text-xl font-bold tracking-tight text-white hidden sm:block">RECEIPTS</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="reset()"
                        class="btn px-4 py-2 text-sm text-gray-300 hover:text-white transition-colors">
                        New Receipt
                    </button>
                    <a href="../quote/index.html"
                        class="btn btn-secondary py-2 px-4 flex items-center gap-2 hover:bg-gray-100 hover:text-gray-900 transition-colors text-sm rounded-lg border-transparent text-white bg-transparent">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                            <line x1="8" y1="6" x2="16" y2="6"></line>
                            <line x1="16" y1="14" x2="16" y2="14"></line>
                            <line x1="8" y1="14" x2="8" y2="14"></line>
                            <line x1="12" y1="14" x2="12" y2="14"></line>
                            <line x1="16" y1="18" x2="16" y2="18"></line>
                            <line x1="8" y1="18" x2="8" y2="18"></line>
                            <line x1="12" y1="18" x2="12" y2="18"></line>
                        </svg>
                        Quote Calculator
                    </a>
                    <a href="../index.html"
                        class="btn btn-secondary py-2 px-4 flex items-center gap-2 hover:bg-gray-100 hover:text-gray-900 transition-colors text-sm rounded-lg border-transparent text-white bg-transparent">
                        Inventory
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main Workspace -->
        <main class="flex-grow flex flex-col lg:flex-row h-full overflow-hidden">

            <!-- LEFT PANEL: History -->
            <aside id="history-panel"
                class="w-full lg:w-80 bg-white border-r border-gray-200 flex flex-col shadow-lg z-20 flex-shrink-0 transition-all duration-300 absolute lg:relative h-full lg:transform-none transform -translate-x-full">
                <div class="p-4 border-b border-gray-200 bg-gray-50 sticky top-0 z-10">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="text-blue-600">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Recent Receipts
                        </h3>
                        <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-gray-800">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input type="text" id="history-search" placeholder="Search..."
                            oninput="renderHistory(this.value)"
                            class="w-full pl-9 pr-3 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500/50 outline-none">
                    </div>
                </div>
                <div id="history-list" class="flex-grow overflow-y-auto p-2 space-y-2 bg-gray-50"></div>
            </aside>

            <!-- CENTER PANEL: Receipt Paper -->
            <section class="flex-grow overflow-y-auto bg-gray-200 p-4 sm:p-8 flex flex-col items-center">

                <!-- THE PAPER RECEIPT CONTAINER -->
                <div id="receipt-container" class="paper-receipt w-full max-w-2xl bg-white p-8 sm:p-12 mb-8"
                    style="min-height: 800px;">

                    <!-- HEADER -->
                    <div class="flex justify-between items-start mb-6">
                        <!-- Left Logo/Address -->
                        <div class="flex flex-col w-1/2">
                            <img src="../treadztntLogo.png" class="h-16 w-auto object-contain self-start mb-2"
                                alt="Treadz">
                            <div class="pl-2 pt-1 text-lg leading-tight space-y-1">
                                <div>409 Main Street E.</div>
                                <div>Mt. Carmel, TN 37645</div>
                            </div>
                        </div>
                        <!-- Right Info -->
                        <div class="text-right w-1/2">
                            <div class="text-4xl font-bold tracking-widest mb-2" id="receipt-id-display">--</div>
                            <div class="text-2xl font-bold">423-357-4551</div>
                        </div>
                    </div>

                    <!-- DATE -->
                    <div class="flex items-end mb-6 text-xl">
                        <span class="mr-2 font-serif">Date:</span>
                        <div class="flex-grow border-b-2 border-black px-2 font-bold" id="receipt-date"></div>
                    </div>

                    <!-- CUSTOMER INFO LINES -->
                    <div class="space-y-4 mb-6">
                        <input type="text" id="cust-name-input"
                            class="w-full text-2xl font-bold border-b-2 border-black outline-none bg-transparent uppercase"
                            placeholder="CUSTOMER NAME">
                        <input type="text" id="cust-vehicle-input"
                            class="w-full text-2xl font-bold border-b-2 border-black outline-none bg-transparent uppercase"
                            placeholder="VEHICLE INFO">
                    </div>

                    <!-- DISCLAIMER -->
                    <div class="mb-4">
                        <p class="text-lg underline decoration-1 text-black font-serif">*Re-Torque lugs after 150 miles.
                        </p>
                    </div>

                    <!-- TABLE -->
                    <div class="mb-0">
                        <table class="receipt-table">
                            <thead>
                                <tr>
                                    <th style="width: 50px;">QTY</th>
                                    <th>DESCRIPTION</th>
                                    <th style="width: 100px;">UNIT PRICE</th>
                                    <th style="width: 100px; border-right: none;">AMOUNT</th>
                                </tr>
                            </thead>
                            <tbody id="line-items-body">
                                <!-- Primary Input Row -->
                                <tr>
                                    <td class="p-0"><input type="number" id="qty-input" value="4"
                                            class="w-full h-full text-center font-bold outline-none bg-transparent"
                                            min="1"></td>
                                    <td class="p-0"><input type="text" id="desc-input" placeholder="TIRE SIZE / BRAND"
                                            class="w-full h-full px-2 font-bold outline-none bg-transparent uppercase">
                                    </td>
                                    <td class="p-0 relative">
                                        <input type="number" id="price-input" placeholder="0.00"
                                            class="w-full h-full pr-2 text-right font-bold outline-none bg-transparent"
                                            step="0.01">
                                    </td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2"
                                        id="line-total-display">$0.00</td>
                                </tr>
                                <!-- Fees (Auto Filled) -->
                                <tr id="row-state-fee">
                                    <td class="text-center align-middle" id="fee-state-qty"></td>
                                    <td class="uppercase text-sm align-middle" id="fee-state-desc"></td>
                                    <td class="text-right align-middle" id="fee-state-price"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2"
                                        id="fee-state-total"></td>
                                </tr>
                                <tr id="row-disp-fee">
                                    <td class="text-center align-middle" id="fee-disp-qty"></td>
                                    <td class="uppercase text-sm align-middle" id="fee-disp-desc"></td>
                                    <td class="text-right align-middle" id="fee-disp-price"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2"
                                        id="fee-disp-total"></td>
                                </tr>

                                <!-- Dynamic Services Rows -->
                                <!-- Rotation -->
                                <tr id="row-srv-rotation" class="hidden">
                                    <td class="p-0"><input type="number" id="qty-rotation" value="1"
                                            class="w-full h-full text-center outline-none bg-transparent"
                                            oninput="calculate()"></td>
                                    <td class="uppercase text-sm align-middle pl-1">TIRE ROTATION</td>
                                    <td class="p-0"><input type="number" id="price-rotation" value="50.00"
                                            class="w-full h-full text-right pr-2 outline-none bg-transparent"
                                            step="0.01" oninput="calculate()"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2"
                                        id="total-rotation">$50.00</td>
                                </tr>

                                <!-- Balance -->
                                <tr id="row-srv-balance" class="hidden">
                                    <td class="p-0"><input type="number" id="qty-balance" value="1"
                                            class="w-full h-full text-center outline-none bg-transparent"
                                            oninput="calculate()"></td>
                                    <td class="uppercase text-sm align-middle pl-1">TIRE BALANCE</td>
                                    <td class="p-0"><input type="number" id="price-balance" value="50.00"
                                            class="w-full h-full text-right pr-2 outline-none bg-transparent"
                                            step="0.01" oninput="calculate()"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2"
                                        id="total-balance">$50.00</td>
                                </tr>

                                <!-- Stem (Still Incl or changed? User didn't specify price, default 0 or allow edit) -->
                                <tr id="row-srv-stem" class="hidden">
                                    <td class="p-0"><input type="number" id="qty-stem" value="4"
                                            class="w-full h-full text-center outline-none bg-transparent"
                                            oninput="calculate()"></td>
                                    <td class="uppercase text-sm align-middle pl-1">VALVE STEMS (NEW)</td>
                                    <td class="p-0"><input type="number" id="price-stem" value="0.00"
                                            class="w-full h-full text-right pr-2 outline-none bg-transparent"
                                            step="0.01" oninput="calculate()"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2" id="total-stem">
                                        $0.00</td>
                                </tr>

                                <!-- Sensor Check -> New TPMS Sensors -->
                                <tr id="row-srv-sensor" class="hidden">
                                    <td class="p-0"><input type="number" id="qty-sensor" value="4"
                                            class="w-full h-full text-center outline-none bg-transparent"
                                            oninput="calculate()"></td>
                                    <td class="uppercase text-sm align-middle pl-1">NEW TPMS SENSORS</td>
                                    <td class="p-0"><input type="number" id="price-sensor" value="59.99"
                                            class="w-full h-full text-right pr-2 outline-none bg-transparent"
                                            step="0.01" oninput="calculate()"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2"
                                        id="total-sensor">$239.96</td>
                                </tr>

                                <!-- Patch -->
                                <tr id="row-srv-patch" class="hidden">
                                    <td class="p-0"><input type="number" id="qty-patch" value="1"
                                            class="w-full h-full text-center outline-none bg-transparent"
                                            oninput="calculate()"></td>
                                    <td class="uppercase text-sm align-middle pl-1">TIRE PATCH</td>
                                    <td class="p-0"><input type="number" id="price-patch" value="20.00"
                                            class="w-full h-full text-right pr-2 outline-none bg-transparent"
                                            step="0.01" oninput="calculate()"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2" id="total-patch">
                                        $20.00</td>
                                </tr>

                                <!-- Plug -->
                                <tr id="row-srv-plug" class="hidden">
                                    <td class="p-0"><input type="number" id="qty-plug" value="1"
                                            class="w-full h-full text-center outline-none bg-transparent"
                                            oninput="calculate()"></td>
                                    <td class="uppercase text-sm align-middle pl-1">TIRE PLUG</td>
                                    <td class="p-0"><input type="number" id="price-plug" value="10.00"
                                            class="w-full h-full text-right pr-2 outline-none bg-transparent"
                                            step="0.01" oninput="calculate()"></td>
                                    <td class="no-border-right text-right font-bold align-middle pr-2" id="total-plug">
                                        $10.00</td>
                                </tr>

                                <!-- Filler Empty Rows -->
                                <tr>
                                    <td>&nbsp;</td>
                                    <td></td>
                                    <td></td>
                                    <td class="no-border-right"></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td></td>
                                    <td></td>
                                    <td class="no-border-right"></td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td></td>
                                    <td></td>
                                    <td class="no-border-right"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- FOOTER -->
                    <div class="flex border-2 border-t-0 border-black">
                        <!-- Message -->
                        <div class="flex-grow flex items-end justify-center p-6 text-center">
                            <h2 class="font-bold text-2xl uppercase font-serif max-w-[250px] leading-tight mb-2">THANK
                                YOU FOR YOUR BUSINESS!</h2>
                        </div>
                        <!-- Totals -->
                        <div class="w-72 border-l-2 border-black">
                            <table class="totals-box border-none">
                                <tr>
                                    <td class="label border-t-0 border-l-0 border-b-2">SUBTOTAL</td>
                                    <td class="amount border-t-0 border-r-0 border-b-2" id="subtotal-final">$0.00</td>
                                </tr>
                                <tr>
                                    <td class="label border-l-0 border-b-2">TAX</td>
                                    <td class="amount border-r-0 border-b-2" id="tax-final">$0.00</td>
                                </tr>
                                <tr>
                                    <td class="label border-l-0 border-b-0">TOTAL</td>
                                    <td class="amount border-r-0 border-b-0 text-2xl" id="total-final">$0.00</td>
                                </tr>
                            </table>
                            <!-- Card Logic Hidden Calculation -->
                            <div id="card-total-preview-container"
                                class="border-t-2 border-black p-1 text-right text-xs bg-gray-50 print:hidden text-gray-500">
                                Card Total (+3.5%): <span id="card-total-preview" class="font-bold">$0.00</span>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- SPACER FOR BUTTONS OVERLAP -->
                <div class="h-24"></div>

                <!-- BUTTONS STICKY FOOTER -->
                <div
                    class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur border-t border-gray-200 p-4 print:hidden z-50 flex justify-center gap-4">
                    <div class="w-full max-w-2xl flex gap-4">
                        <button onclick="reset()"
                            class="btn px-6 py-4 rounded-xl text-gray-500 hover:text-red-500 font-bold bg-white border border-gray-200 shadow-sm">
                            Reset
                        </button>
                        <button onclick="handlePrint()"
                            class="flex-1 btn btn-primary py-4 rounded-xl text-xl shadow-xl flex items-center justify-center gap-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2">
                                </path>
                                <rect width="12" height="8" x="6" y="14"></rect>
                            </svg>
                            PRINT RECEIPT
                        </button>
                    </div>
                </div>

            </section>

            <!-- RIGHT PANEL: Recommended Services (Checklist) -->
            <aside id="upsell-panel"
                class="w-full lg:w-72 bg-white border-l border-gray-200 shadow-xl z-20 flex-shrink-0 flex flex-col hidden lg:flex">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="font-bold text-lg text-gray-800 font-sans">Services Performed</h3>
                    <p class="text-xs text-gray-500 mt-1 font-sans">Check to add line items.</p>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto flex-grow font-sans pb-24">
                    <div class="space-y-3">
                        <label
                            class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="srv-rotation" class="mt-1 w-5 h-5 text-blue-600 rounded"
                                onchange="toggleService('srv-rotation', 'row-srv-rotation')">
                            <div><span class="block font-semibold text-gray-700">Rotation</span> <span
                                    class="text-xs text-gray-400">Default: $50</span></div>
                        </label>
                        <label
                            class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="srv-balance" class="mt-1 w-5 h-5 text-blue-600 rounded"
                                onchange="toggleService('srv-balance', 'row-srv-balance')">
                            <div><span class="block font-semibold text-gray-700">Balance</span> <span
                                    class="text-xs text-gray-400">Default: $50</span></div>
                        </label>
                        <label
                            class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="srv-stem" class="mt-1 w-5 h-5 text-blue-600 rounded"
                                onchange="toggleService('srv-stem', 'row-srv-stem')">
                            <div><span class="block font-semibold text-gray-700">Tire Stems</span> <span
                                    class="text-xs text-gray-400">Default: Free</span></div>
                        </label>
                        <label
                            class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="srv-sensor" class="mt-1 w-5 h-5 text-blue-600 rounded"
                                onchange="toggleService('srv-sensor', 'row-srv-sensor')">
                            <div><span class="block font-semibold text-gray-700">New TPMS Sensors</span> <span
                                    class="text-xs text-gray-400">Default: $59.99</span></div>
                        </label>
                        <hr class="border-gray-100">
                        <label
                            class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="srv-patch" class="mt-1 w-5 h-5 text-blue-600 rounded"
                                onchange="toggleService('srv-patch', 'row-srv-patch')">
                            <div><span class="block font-semibold text-gray-700">Tire Patch</span> <span
                                    class="text-xs text-gray-400">Default: $20.00</span></div>
                        </label>
                        <label
                            class="flex items-start gap-3 p-3 rounded-lg border border-gray-100 hover:bg-gray-50 cursor-pointer">
                            <input type="checkbox" id="srv-plug" class="mt-1 w-5 h-5 text-blue-600 rounded"
                                onchange="toggleService('srv-plug', 'row-srv-plug')">
                            <div><span class="block font-semibold text-gray-700">Tire Plug</span> <span
                                    class="text-xs text-gray-400">Default: $10.00</span></div>
                        </label>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <script>
        const STATE_FEE_PER_TIRE = 1.35;
        const DISPOSAL_FEE_PER_TIRE = 4.00;
        const TAX_RATE = 0.0975;
        const CARD_FEE_RATE = 0.035;

        // Elements
        const qtyInput = document.getElementById('qty-input');
        const descInput = document.getElementById('desc-input');
        const priceInput = document.getElementById('price-input');

        const custNameInput = document.getElementById('cust-name-input');
        const custVehicleInput = document.getElementById('cust-vehicle-input');
        const dateDisplay = document.getElementById('receipt-date');
        const idDisplay = document.getElementById('receipt-id-display');

        // Fee Rows
        const feeStateQty = document.getElementById('fee-state-qty');
        const feeStateDesc = document.getElementById('fee-state-desc');
        const feeStatePrice = document.getElementById('fee-state-price');
        const feeStateTotal = document.getElementById('fee-state-total');

        const feeDispQty = document.getElementById('fee-disp-qty');
        const feeDispDesc = document.getElementById('fee-disp-desc');
        const feeDispPrice = document.getElementById('fee-disp-price');
        const feeDispTotal = document.getElementById('fee-disp-total');

        // Totals
        const subtotalFinal = document.getElementById('subtotal-final');
        const taxFinal = document.getElementById('tax-final');
        const totalFinal = document.getElementById('total-final');
        const cardTotalPreview = document.getElementById('card-total-preview');

        // Init
        dateDisplay.textContent = new Date().toLocaleDateString();

        // Number System: Sequential ID
        function getNextReceiptId() {
            // Get last generated ID or default 1000
            const last = parseInt(localStorage.getItem('treadzLastReceiptId')) || 1000;
            return last + 1;
        }

        if (idDisplay.textContent === '--' || idDisplay.textContent === '') {
            idDisplay.textContent = getNextReceiptId();
        }

        function toggleService(cbId, rowId) {
            const cb = document.getElementById(cbId);
            const row = document.getElementById(rowId);
            if (cb.checked) {
                row.classList.remove('hidden');
            } else {
                row.classList.add('hidden');
            }
            calculate();
        }

        // --- CALCULATION LOGIC ---
        // Basic rounding helper for currency math
        function round2(num) {
            return Math.round((num + Number.EPSILON) * 100) / 100;
        }

        function calculate() {
            // 1. Primary Line Item
            const qty = parseInt(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const lineTotal = round2(qty * price);
            document.getElementById('line-total-display').textContent = formatMoney(lineTotal);

            let currentSubtotal = lineTotal;

            // 2. Fees (Only if primary input active)
            if (qty > 0 && (descInput.value.length > 0 || price > 0)) {
                // State Fee
                const stateTotal = round2(qty * STATE_FEE_PER_TIRE);
                feeStateQty.textContent = qty;
                feeStateDesc.textContent = 'STATE TIRE FEE';
                feeStatePrice.textContent = formatMoney(STATE_FEE_PER_TIRE);
                feeStateTotal.textContent = formatMoney(stateTotal);

                // Disposal Fee
                const dispTotal = round2(qty * DISPOSAL_FEE_PER_TIRE);
                feeDispQty.textContent = qty;
                feeDispDesc.textContent = 'TIRE DISPOSAL';
                feeDispPrice.textContent = formatMoney(DISPOSAL_FEE_PER_TIRE);
                feeDispTotal.textContent = formatMoney(dispTotal);

                currentSubtotal = round2(currentSubtotal + stateTotal + dispTotal);
            } else {
                clearFees();
            }

            // 3. Helper to sum upsell row
            const sumRow = (prefix) => {
                const cb = document.getElementById('srv-' + prefix);
                if (cb && cb.checked) {
                    const q = parseInt(document.getElementById('qty-' + prefix).value) || 0;
                    const p = parseFloat(document.getElementById('price-' + prefix).value) || 0;
                    const t = round2(q * p);
                    document.getElementById('total-' + prefix).textContent = formatMoney(t);
                    return t;
                }
                return 0;
            };

            currentSubtotal = round2(currentSubtotal + sumRow('rotation'));
            currentSubtotal = round2(currentSubtotal + sumRow('balance'));
            currentSubtotal = round2(currentSubtotal + sumRow('stem'));
            currentSubtotal = round2(currentSubtotal + sumRow('sensor'));
            currentSubtotal = round2(currentSubtotal + sumRow('patch'));
            currentSubtotal = round2(currentSubtotal + sumRow('plug'));

            // 4. Totals
            const tax = round2(currentSubtotal * TAX_RATE);
            const total = round2(currentSubtotal + tax);

            // Card total: Total + 3.5%
            const cardTotal = round2(total + (total * CARD_FEE_RATE));

            subtotalFinal.textContent = formatMoney(currentSubtotal);
            taxFinal.textContent = formatMoney(tax);
            totalFinal.textContent = formatMoney(total);
            cardTotalPreview.textContent = formatMoney(cardTotal);
        }

        function clearFees() {
            feeStateQty.textContent = ''; feeStateDesc.textContent = ''; feeStatePrice.textContent = ''; feeStateTotal.textContent = '';
            feeDispQty.textContent = ''; feeDispDesc.textContent = ''; feeDispPrice.textContent = ''; feeDispTotal.textContent = '';
        }

        function formatMoney(amount) {
            return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // --- HISTORY LOGIC ---
        function getHistory() { return JSON.parse(localStorage.getItem('treadzQuoteHistoryV1')) || []; }

        function saveQuote() {
            const history = getHistory();
            const quote = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                displayId: idDisplay.textContent,
                customer: custNameInput.value.trim() || 'Walk-In',
                vehicle: custVehicleInput.value.trim(),
                tireInfo: descInput.value.trim(),
                pricePerTire: parseFloat(priceInput.value) || 0,
                qty: parseInt(qtyInput.value) || 0,
                total: totalFinal.textContent,
                // Save states
                upsells: {
                    rotation: document.getElementById('srv-rotation').checked,
                    balance: document.getElementById('srv-balance').checked,
                    stem: document.getElementById('srv-stem').checked,
                    sensor: document.getElementById('srv-sensor').checked,
                    patch: document.getElementById('srv-patch').checked,
                    plug: document.getElementById('srv-plug').checked
                }
            };
            // Ignore complexity of saving individual edited prices in history for now, just the basics + total

            // Dedupe
            const isDuplicate = history.some(item =>
                item.customer === quote.customer &&
                item.vehicle === quote.vehicle &&
                item.tireInfo === quote.tireInfo &&
                item.total === quote.total
            );
            if (isDuplicate) return;

            history.unshift(quote);
            if (history.length > 50) history.pop();
            localStorage.setItem('treadzQuoteHistoryV1', JSON.stringify(history));
            renderHistory();
        }

        function handlePrint() {
            // Commit ID if it's new
            const currentId = parseInt(idDisplay.textContent);
            const lastSaved = parseInt(localStorage.getItem('treadzLastReceiptId')) || 1000;

            // Only increment global counter if we are printing a *new* ID (higher than last saved)
            if (currentId > lastSaved) {
                localStorage.setItem('treadzLastReceiptId', currentId);
            }

            saveQuote();
            window.print();
        }

        function reset() {
            qtyInput.value = 4;
            descInput.value = '';
            priceInput.value = '';
            custNameInput.value = '';
            custVehicleInput.value = '';

            // Uncheck all services
            ['rotation', 'balance', 'stem', 'sensor', 'patch', 'plug'].forEach(id => {
                const el = document.getElementById('srv-' + id);
                if (el) {
                    el.checked = false;
                    toggleService('srv-' + id, 'row-srv-' + id);
                }
            });

            idDisplay.textContent = getNextReceiptId();
            calculate();
        }

        function renderHistory(filterText = '') {
            const history = getHistory();
            const container = document.getElementById('history-list');

            if (!container) return; // Guard

            const filteredHistory = history.filter(item => {
                const searchStr = filterText.toLowerCase();
                return (
                    item.customer.toLowerCase().includes(searchStr) ||
                    (item.vehicle && item.vehicle.toLowerCase().includes(searchStr)) ||
                    (item.tireInfo && item.tireInfo.toLowerCase().includes(searchStr)) ||
                    item.total.includes(searchStr)
                );
            });

            container.innerHTML = filteredHistory.map(item => `
                <div onclick='loadQuote(${JSON.stringify(item)})' class="bg-white p-3 rounded border border-gray-200 shadow-sm cursor-pointer hover:border-blue-500 transition-all">
                    <div class="flex justify-between items-start mb-1">
                        <div class="font-bold text-gray-800 text-sm truncate pr-2 w-2/3">${item.customer}</div>
                        <div class="text-xs font-mono text-gray-500">${new Date(item.timestamp).toLocaleDateString()}</div>
                    </div>
                    <div class="text-xs text-gray-600 truncate mb-1">${item.tireInfo || 'Item'}</div>
                    <div class="flex justify-between items-center mt-1">
                        <div class="font-bold text-blue-600 text-sm">${item.total}</div>
                        <div class="text-xs text-gray-400">#${item.displayId || '---'}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadQuote(item) {
            custNameInput.value = item.customer;
            custVehicleInput.value = item.vehicle;
            descInput.value = item.tireInfo;
            priceInput.value = item.pricePerTire;
            qtyInput.value = item.qty;
            idDisplay.textContent = item.displayId || getNextReceiptId();

            if (item.upsells) {
                // Restore upsells
                Object.keys(item.upsells).forEach(k => {
                    const cb = document.getElementById('srv-' + k);
                    if (cb) {
                        cb.checked = item.upsells[k];
                        toggleService('srv-' + k, 'row-srv-' + k);
                    }
                });
            } else {
                // Reset upsells if legacy data
                ['rotation', 'balance', 'stem', 'sensor', 'patch', 'plug'].forEach(id => {
                    const el = document.getElementById('srv-' + id);
                    if (el) {
                        el.checked = false;
                        toggleService('srv-' + id, 'row-srv-' + id);
                    }
                });
            }

            calculate();
            toggleSidebar(); // Close on mobile if open
        }

        function toggleSidebar() {
            const p = document.getElementById('history-panel');
            p.classList.toggle('-translate-x-full');
            p.classList.toggle('absolute');
            p.classList.toggle('fixed'); // Ensure it overlays on mobile
        }

        // Setup
        ['qty-input', 'descInput', 'price-input', 'cust-name-input', 'cust-vehicle-input'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', calculate);
        });

        calculate();
        renderHistory();
    </script>
</body>

</html>