<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Hub - Your Personal Finance Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #000000;
            --bg-secondary: #1c1c1e;
            --bg-tertiary: #2c2c2e;
            --bg-hero: #111111;
            --bg-modal: rgba(28, 28, 30, 0.95); /* Slightly more opaque for better readability */
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #636366;
            --border-color: #38383a; /* Softer border */
            --border-light: #4a4a4c;
            --accent-primary: #0a84ff; /* Apple Blue */
            --accent-green: #30d158; /* Apple Green - Paychecks, Positive Insights */
            --accent-red: #ff453a; /* Apple Red - Bills, Negative Insights */
            --accent-yellow: #ffd60a; 
            --accent-purple: #bf5af2; 
            --accent-teal: #64d2ff; 
            --accent-orange: #ff9500; /* Holidays, Savings Goal Progress */
            --accent-pink: #ff2d55;

            --accent-bill-icon: var(--accent-red);
            --accent-paycheck-icon: var(--accent-green);
            --accent-birthday-icon: var(--accent-purple);
            --accent-holiday-icon: var(--accent-orange);

            --font-family-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family-sans);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .apple-card {
            background-color: var(--bg-secondary);
            border-radius: 1rem; 
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 18px rgba(0,0,0,0.15); /* Slightly more pronounced shadow */
        }

        .apple-input {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color); 
            color: var(--text-primary);
            border-radius: 0.5rem; 
            padding: 0.75rem 1rem;
            font-size: 1rem;
            width: 100%;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .apple-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
        }
        .apple-input::placeholder { color: var(--text-tertiary); }
        select.apple-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%238E8E93' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.1em 1.1em;
            padding-right: 2.5rem;
        }
        input[type="date"].apple-input { color-scheme: dark; }
        input[type="date"].apple-input::-webkit-calendar-picker-indicator {
             filter: invert(0.8) brightness(0.8); 
             cursor: pointer;
        }

        .apple-button {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            border-radius: 0.625rem; 
            transition: background-color 0.2s ease, transform 0.1s ease, filter 0.2s ease;
            font-weight: 600; padding: 0.75rem 1.5rem;
            border: none; cursor: pointer; font-size: 1rem; text-align: center;
        }
        .apple-button-primary { background-color: var(--accent-primary); color: var(--text-primary); }
        .apple-button-primary:hover { filter: brightness(1.15); }
        .apple-button-primary:active { transform: scale(0.97); filter: brightness(0.9); }
        .apple-button-secondary { background-color: var(--bg-tertiary); color: var(--accent-primary); }
        .apple-button-secondary:hover { filter: brightness(1.2); }
        .apple-button-secondary:active { transform: scale(0.97); filter: brightness(0.9); }

        /* Hero Section Styles */
        #heroSection {
            background-color: var(--bg-hero);
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.03) 1px, transparent 0);
            background-size: 20px 20px;
            min-height: 80vh; display: flex; align-items: center; justify-content: center;
            text-align: center; padding: 4rem 1rem; border-bottom: 1px solid var(--border-color);
        }
        .hero-title { font-size: 3rem; font-weight: 800; color: var(--text-primary); line-height: 1.2; margin-bottom: 1rem; }
        @media (min-width: 768px) { .hero-title { font-size: 4.5rem; } }
        .hero-subtitle { font-size: 1.25rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto 2rem auto; line-height: 1.6; }
        .hero-button { padding: 0.875rem 2rem; font-size: 1.125rem; }

        /* Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-header-cell, .calendar-day-cell { text-align: center; padding: 0.5rem 0.25rem; font-size: 0.875rem; }
        .calendar-header-cell { color: var(--text-secondary); font-weight: 500; }
        .calendar-day-cell {
            background-color: var(--bg-tertiary); border-radius: 0.5rem; min-height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding: 0.5rem; cursor: pointer; transition: background-color 0.2s; position: relative;
        }
        .calendar-day-cell:hover { background-color: #3a3a3c; }
        .calendar-day-cell.today { background-color: var(--accent-primary); color: var(--text-primary); font-weight: 700; }
        .calendar-day-cell.today .day-number { color: var(--text-primary) !important; }
        .calendar-day-cell.other-month { color: var(--text-tertiary); opacity: 0.5; pointer-events: none; }
        .calendar-day-cell.other-month .day-number { color: var(--text-tertiary) !important; }
        .day-number { font-size: 0.875rem; margin-bottom: 0.25rem; z-index: 1; }
        
        .event-name-display { /* For Holiday, Birthday names on calendar */
            font-size: 0.65rem; margin-top: 2px; line-height: 1.1; font-weight: 500;
            overflow: hidden; text-overflow: ellipsis; display: -webkit-box;
            -webkit-line-clamp: 2; -webkit-box-orient: vertical; max-height: 2.2em;
        }
        .holiday-name-display { color: var(--accent-holiday-icon); }
        .birthday-name-display { color: var(--accent-birthday-icon); }

        .calendar-day-cell.holiday-cell { border: 1px solid var(--accent-holiday-icon); }
        .calendar-day-cell.birthday-cell { border: 1px solid var(--accent-birthday-icon); }
        .calendar-day-cell.holiday-cell.today { border-color: var(--accent-holiday-icon); }
        .calendar-day-cell.birthday-cell.today { border-color: var(--accent-birthday-icon); }

        .item-indicator-container {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-end;
            gap: 3px; margin-top: auto; padding-bottom: 2px; width: 100%; min-height: 20px;
        }
        .calendar-icon { width: 12px; height: 12px; margin: 0px; }

        /* Modal Styles (General & Day Details) */
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.75); /* Darker backdrop */
            display: flex; align-items: center; justify-content: center; z-index: 50;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--bg-modal); backdrop-filter: blur(12px) saturate(180%); /* Enhanced blur */
            padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto; transform: scale(0.95);
            transition: transform 0.3s ease; border: 1px solid var(--border-light);
        }
        .modal-backdrop.active .modal-content { transform: scale(1); }

        /* Day Details Modal Specifics */
        #dayDetailsModalContent .day-details-item {
            display: flex; align-items: center; padding: 0.6rem 0;
            border-bottom: 1px solid var(--border-color); font-size: 0.875rem;
        }
        #dayDetailsModalContent .day-details-item:last-child { border-bottom: none; }
        #dayDetailsModalContent .day-details-item-icon { margin-right: 0.75rem; flex-shrink: 0; width: 1.25rem; height: 1.25rem;}
        #dayDetailsModalContent .day-details-item-desc { flex-grow: 1; }
        #dayDetailsModalContent .day-details-item-amount { font-weight: 500; }
        #dayDetailsModalContent .day-details-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end;}
        .day-details-add-btn {
            position: absolute; bottom: 1rem; right: 1rem;
            background-color: var(--accent-primary); color: white;
            width: 3rem; height: 3rem; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
         .day-details-add-btn svg { width: 1.5rem; height: 1.5rem; }
         .day-details-item-clickable { cursor: pointer; }
         .day-details-item-clickable:hover { background-color: rgba(255,255,255,0.05); }


        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 4px;}
        ::-webkit-scrollbar-thumb { background: var(--text-tertiary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }

        /* Category Badges */
        .category-badge-list {
            display: inline-flex; align-items: center; gap: 0.3rem; 
            padding: 0.2rem 0.5rem; border-radius: 0.5rem; 
            font-size: 0.75rem; font-weight: 500; line-height: 1;
            border: 1px solid transparent; 
        }
        .category-badge-list svg { width: 12px; height: 12px; }

        /* Summary & Insight Cards */
        .summary-card, .insight-card { /* Shared style for consistency */
            background-color: var(--bg-secondary); padding: 1rem; border-radius: 0.75rem;
        }
        .summary-card-title, .insight-card-title { font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .summary-card-value { font-size: 1.75rem; font-weight: 600; }
        .insight-card-content { font-size: 0.95rem; color: var(--text-primary); margin-top: 0.5rem; }
        .text-positive { color: var(--accent-green); }
        .text-negative { color: var(--accent-red); }

        /* Transaction List Item */
        .transaction-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 0.25rem; border-bottom: 1px solid var(--border-color);
            transition: background-color 0.15s ease;
        }
        .transaction-list-item:last-child { border-bottom: none; }
        .transaction-list-item:hover { background-color: var(--bg-tertiary); }
        .transaction-delete-button { background: none; border: none; color: var(--accent-red); padding: 0.25rem; cursor: pointer; opacity: 0.7; }
        .transaction-delete-button:hover { opacity: 1; }
        .transaction-delete-button svg { width: 1.1rem; height: 1.1rem; }
        .btn-icon { width: 1.25em; height: 1.25em; }

        /* Savings Goal Styles */
        .savings-goal-item { padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        .savings-goal-item:last-child { border-bottom: none; }
        .savings-goal-progress-bar-bg { background-color: var(--bg-tertiary); border-radius: 0.25rem; height: 8px; overflow: hidden; }
        .savings-goal-progress-bar-fg { background-color: var(--accent-orange); height: 100%; border-radius: 0.25rem; transition: width 0.3s ease; }
        .add-to-goal-btn { font-size: 0.75rem !important; padding: 0.25rem 0.5rem !important; }

        /* Financial Literacy Section */
        .literacy-section details { margin-bottom: 1rem; }
        .literacy-section summary {
            font-size: 1.125rem; font-weight: 600; color: var(--text-primary);
            padding: 0.75rem; background-color: var(--bg-tertiary); border-radius: 0.5rem;
            cursor: pointer; list-style: none; /* Remove default arrow in some browsers */
            display: flex; justify-content: space-between; align-items: center;
        }
        .literacy-section summary::-webkit-details-marker { display: none; } /* Chrome/Safari */
        .literacy-section summary::after { /* Custom arrow */
            content: '+'; font-size: 1.5rem; color: var(--accent-primary);
            transition: transform 0.2s ease;
        }
        .literacy-section details[open] summary::after { transform: rotate(45deg); }
        .literacy-section .literacy-content {
            padding: 1rem; background-color: var(--bg-secondary); border-radius: 0 0 0.5rem 0.5rem;
            border: 1px solid var(--border-color); border-top: none;
            font-size: 0.95rem; line-height: 1.6; color: var(--text-secondary);
        }
        .literacy-section .literacy-content p { margin-bottom: 0.75rem; }


    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-black/80 backdrop-blur-lg sticky top-0 z-40 border-b border-[var(--border-color)]">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <a href="#heroSection" class="flex items-center gap-2">
                <svg class="h-7 w-auto text-[var(--accent-primary)]" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-8.5l4-4L12 11.09l1.5-1.59L18 11.5l-6 6-6.5-6.5z"/>
                </svg>
                <span class="font-semibold text-xl text-white">Finance Hub</span>
            </a>
            <button id="addTransactionBtnHeader" class="apple-button apple-button-primary !py-2 !px-4 !text-sm">
                <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                Add Transaction
            </button>
        </nav>
    </header>

    <section id="heroSection">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="hero-title">Visualize Your Finances.</h1>
            <p class="hero-subtitle">
                Track your expenses and income effortlessly with an intuitive calendar view. 
                Stay on top of your financial health, inspired by simplicity and clarity.
            </p>
            <button id="getStartedBtn" class="apple-button apple-button-primary hero-button">
                Get Started
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 ml-1"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" /></svg>
            </button>
        </div>
    </section>

    <main id="mainContent" class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <section id="calendarViewSection" class="lg:col-span-2 apple-card">
                <div class="flex items-center justify-between mb-6">
                    <button id="prevMonthBtn" class="apple-button apple-button-secondary !p-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
                    </button>
                    <h2 id="currentMonthYear" class="text-xl font-semibold text-center">Month Year</h2>
                    <button id="nextMonthBtn" class="apple-button apple-button-secondary !p-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
                    </button>
                </div>
                <div id="calendarHeaders" class="calendar-grid mb-1"></div>
                <div id="calendarGrid" class="calendar-grid"></div>
                <p id="calendar-placeholder" class="text-center text-[var(--text-secondary)] italic mt-4 text-sm hidden">No financial items in this month.</p>
            </section>

            <aside class="space-y-6">
                <div class="grid grid-cols-1 gap-4">
                    <div class="summary-card">
                        <h3 class="summary-card-title">Month Net</h3>
                        <div id="dashboard-summary-net" class="summary-card-value">$0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3 class="summary-card-title">Month Income</h3>
                        <div id="dashboard-summary-income" class="summary-card-value text-positive">$0.00</div>
                    </div>
                    <div class="summary-card">
                        <h3 class="summary-card-title">Month Spending</h3>
                        <div id="dashboard-summary-expenses" class="summary-card-value text-negative">$0.00</div>
                    </div>
                </div>
                
                <div class="apple-card">
                    <h3 class="text-lg font-semibold mb-3">Income</h3>
                    <form id="income-form" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="weekly-income" class="text-sm text-[var(--text-secondary)] mb-1 block">Weekly Amount</label>
                                <input type="number" id="weekly-income" class="apple-input" step="0.01" placeholder="e.g., 500">
                            </div>
                            <div>
                                <label for="payday" class="text-sm text-[var(--text-secondary)] mb-1 block">Payday</label>
                                <select id="payday" class="apple-input">
                                    <option value="" disabled selected>Select Day</option>
                                    <option value="0">Sunday</option><option value="1">Monday</option><option value="2">Tuesday</option>
                                    <option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option>
                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="apple-button apple-button-secondary w-full">Save Income</button>
                    </form>
                    <div class="mt-3 text-center text-xs text-[var(--text-secondary)]">
                        Current: <strong id="display-income" class="text-[var(--accent-primary)]">$0.00</strong> weekly, paid <strong id="display-payday" class="text-[var(--accent-primary)]">N/A</strong>
                    </div>
                </div>

                <div class="apple-card">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">Recent Expenses</h3>
                        <select id="filter-category-sidebar" class="apple-input !text-xs !py-1 !w-auto"></select>
                    </div>
                    <ul id="expense-list-sidebar" class="space-y-1 max-h-60 overflow-y-auto text-sm"></ul>
                </div>
                <div class="apple-card" id="recurring-bills-sidebar-card">
                    <h3 class="text-lg font-semibold mb-3">Upcoming Bills</h3>
                    <ul id="recurring-list-sidebar" class="space-y-1 max-h-60 overflow-y-auto text-sm"></ul>
                </div>
                <div class="apple-card" id="savings-goals-card">
                    <h3 class="text-lg font-semibold mb-3">Savings Goals</h3>
                    <form id="add-goal-form" class="grid grid-cols-3 gap-2 mb-4 items-end">
                        <div class="col-span-2">
                            <label for="goal-name" class="text-xs text-[var(--text-secondary)] mb-1 block">Goal Name</label>
                            <input type="text" id="goal-name" class="apple-input !text-sm !py-1.5" placeholder="e.g., Vacation">
                        </div>
                        <div>
                            <label for="goal-target" class="text-xs text-[var(--text-secondary)] mb-1 block">Target ($)</label>
                            <input type="number" id="goal-target" class="apple-input !text-sm !py-1.5" placeholder="1000" step="10">
                        </div>
                        <button type="submit" class="apple-button apple-button-secondary col-span-3 !text-sm !py-1.5 mt-1">Add Goal</button>
                    </form>
                    <ul id="savings-goals-list" class="space-y-3">
                        <li class="text-center text-xs text-[var(--text-secondary)]">No savings goals yet.</li>
                    </ul>
                </div>
                <div class="insight-card" id="financial-insights-card">
                    <h3 class="insight-card-title text-lg font-semibold">Financial Insights</h3>
                    <div id="insight-content" class="insight-card-content text-sm space-y-2">
                        <p class="text-[var(--text-secondary)]">Insights will appear here once you have more data.</p>
                    </div>
                </div>
            </aside>
        </div>

        <section id="financialLiteracySection" class="apple-card mt-8 literacy-section">
            <h2 class="text-2xl font-semibold mb-6 text-center">Boost Your Financial Knowledge</h2>
            <details>
                <summary>The Importance of Budgeting</summary>
                <div class="literacy-content">
                    <p>Creating a budget is the cornerstone of good financial health. It helps you understand where your money is going, identify areas where you can save, and plan for future expenses and goals. Start by tracking your income and all your expenses for a month. Then, categorize your spending and set realistic limits for each category.</p>
                    <p><strong>Tip:</strong> Use the 50/30/20 rule as a guideline: 50% of your income for needs (housing, food, transport), 30% for wants (entertainment, dining out), and 20% for savings and debt repayment.</p>
                </div>
            </details>
            <details>
                <summary>Understanding Savings vs. Investing</summary>
                <div class="literacy-content">
                    <p><strong>Saving</strong> typically involves putting money aside in a safe, easily accessible place like a savings account. It's ideal for short-term goals and emergency funds. The returns are usually low but so is the risk.</p>
                    <p><strong>Investing</strong> involves using your money to buy assets (like stocks, bonds, or real estate) with the expectation that they will generate income or appreciate in value over time. Investing generally carries more risk than saving but offers the potential for higher returns, making it suitable for long-term goals like retirement.</p>
                </div>
            </details>
            <details>
                <summary>Managing Debt Effectively</summary>
                <div class="literacy-content">
                    <p>Not all debt is bad (e.g., a mortgage can be an investment), but high-interest debt (like credit card debt) can quickly become a burden. Prioritize paying off debts with the highest interest rates first (the "avalanche" method). Alternatively, paying off the smallest debts first for psychological wins (the "snowball" method) can also be effective.</p>
                    <p><strong>Tip:</strong> Avoid taking on new debt while you're paying off existing debt. Consider balance transfers or debt consolidation if it makes financial sense.</p>
                </div>
            </details>
             <details>
                <summary>Building Good Credit</summary>
                <div class="literacy-content">
                    <p>A good credit score is crucial for accessing loans, mortgages, and even some rental agreements at favorable terms. Key factors that influence your credit score include:</p>
                    <ul>
                        <li><strong>Payment History:</strong> Always pay your bills on time.</li>
                        <li><strong>Amounts Owed (Credit Utilization):</strong> Try to keep your credit card balances low relative to your credit limits (ideally below 30%).</li>
                        <li><strong>Length of Credit History:</strong> A longer credit history is generally better.</li>
                        <li><strong>New Credit:</strong> Avoid opening too many new credit accounts in a short period.</li>
                        <li><strong>Credit Mix:</strong> Having a mix of different types of credit (e.g., credit cards, installment loans) can be beneficial.</li>
                    </ul>
                </div>
            </details>
        </section>
    </main>

    <footer class="mt-auto py-6 border-t border-[var(--border-color)]">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 text-center text-xs text-[var(--text-secondary)]">
            &copy; <span id="footer-year"></span> Finance Hub. All data stored locally.
        </div>
    </footer>

    <div id="dayDetailsModal" class="modal-backdrop">
        <div id="dayDetailsModalContent" class="modal-content relative">
            <div class="flex justify-between items-center mb-4">
                <h2 id="dayDetailsModalTitle" class="text-xl font-semibold">Day Details</h2>
                <button id="closeDayDetailsModalBtn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div id="dayDetailsList" class="max-h-96 overflow-y-auto pr-2">
                </div>
             <button id="dayDetailsAddBtn" title="Add new item for this day" class="day-details-add-btn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
            </button>
        </div>
    </div>


    <div id="transactionModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-xl font-semibold">Add Transaction</h2>
                <button id="closeModalBtn" class="text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="mb-4 flex border-b border-[var(--border-color)]">
                <button id="tab-expense" data-form="expense-form-modal" class="modal-tab-button active flex-1 py-2 px-4 text-center font-medium border-b-2 border-[var(--accent-primary)] text-[var(--accent-primary)]">Expense</button>
                <button id="tab-bill" data-form="recurring-form-modal" class="modal-tab-button flex-1 py-2 px-4 text-center font-medium border-b-2 border-transparent text-[var(--text-secondary)] hover:text-[var(--text-primary)]">Bill</button>
            </div>
            <div id="global-error-modal" class="hidden bg-red-500/10 text-red-400 border border-red-500/30 p-3 rounded-md text-sm mb-4"></div>
            <form id="expense-form-modal" class="space-y-4">
                <input type="hidden" id="expense-id-modal">
                <div>
                    <label for="expense-desc-modal" class="text-sm text-[var(--text-secondary)] mb-1 block">Description</label>
                    <input type="text" id="expense-desc-modal" class="apple-input" placeholder="e.g., Groceries, Coffee" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label for="expense-category-modal" class="text-sm text-[var(--text-secondary)] mb-1 block">Category</label>
                        <select id="expense-category-modal" class="apple-input" required></select>
                    </div>
                    <div>
                        <label for="expense-amount-modal" class="text-sm text-[var(--text-secondary)] mb-1 block">Amount ($)</label>
                        <input type="number" id="expense-amount-modal" class="apple-input" step="0.01" placeholder="0.00" required>
                    </div>
                    <div>
                        <label for="expense-date-modal" class="text-sm text-[var(--text-secondary)] mb-1 block">Date</label>
                        <input type="date" id="expense-date-modal" class="apple-input" required>
                    </div>
                </div>
                <div class="pt-2 flex justify-end gap-3">
                    <button type="button" id="cancelModalBtn" class="apple-button apple-button-secondary">Cancel</button>
                    <button type="submit" class="apple-button apple-button-primary">Save Expense</button>
                </div>
            </form>
            <form id="recurring-form-modal" class="space-y-4 hidden">
                <input type="hidden" id="recurring-id-modal">
                <div>
                    <label for="recurring-desc-modal" class="text-sm text-[var(--text-secondary)] mb-1 block">Description</label>
                    <input type="text" id="recurring-desc-modal" class="apple-input" placeholder="e.g., Rent, Netflix" required>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="recurring-amount-modal" class="text-sm text-[var(--text-secondary)] mb-1 block">Amount ($)</label>
                        <input type="number" id="recurring-amount-modal" class="apple-input" step="0.01" placeholder="0.00" required>
                    </div>
                    <div>
                        <label for="recurring-day-modal" class="text-sm text-[var(--text-secondary)] mb-1 block">Day Due (1-31)</label>
                        <input type="number" id="recurring-day-modal" class="apple-input" min="1" max="31" placeholder="e.g., 15" required>
                    </div>
                </div>
                 <div class="pt-2 flex justify-end gap-3">
                    <button type="button" id="cancelModalBtnRecurring" class="apple-button apple-button-secondary">Cancel</button>
                    <button type="submit" class="apple-button apple-button-primary">Save Bill</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    // --- Constants, State, Utilities, Persistence ---
    const LOCAL_STORAGE_KEY = 'financeHubApple_v4'; // Incremented version
    const CATEGORY_DETAILS = { // For expenses
        'Food': { color: 'var(--accent-yellow)', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path d="M12.018 3.207 8.055 2.012A3.001 3.001 0 0 0 4.803 7.17a3.001 3.001 0 0 0 2.63 2.805l3.963 1.196A3.001 3.001 0 0 0 15.197 6.03a3.001 3.001 0 0 0-3.179-2.823ZM9.244 12.012l-.002-.002-.002-.002a1.5 1.5 0 0 0-2.088 1.994l.002.002.002.002L10.5 17.25l3.344-3.244a1.5 1.5 0 0 0-2.088-1.994l-.002.002Z" /></svg>` },
        'Transport': { color: 'var(--accent-teal)', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path fill-rule="evenodd" d="M6.622 4.062A9.502 9.502 0 0 0 3.5 10.5c0 1.463.33 2.84.917 4.065a.75.75 0 0 1-1.215.87 11 11 0 1 1 13.595 0 .75.75 0 0 1-1.214-.87A9.503 9.503 0 0 0 16.5 10.5c0-1.463-.33-2.84-.917-4.065a.75.75 0 0 1 1.214-.87 11.003 11.003 0 0 1-13.595 0 .75.75 0 0 1 1.214.87ZM10 13.25a.75.75 0 0 0 .75-.75V8.75a.75.75 0 0 0-1.5 0v3.75a.75.75 0 0 0 .75.75Z" clip-rule="evenodd" /></svg>` },
        'Housing': { color: 'var(--accent-purple)', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l7 7A1 1 0 0 1 17 11h-1v6a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-6H3a1 1 0 0 1-.707-1.707l7-7Z" clip-rule="evenodd" /></svg>` },
        'Utilities': { color: 'var(--accent-orange)', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path d="M11.983 3.004a1 1 0 0 0-1.415-1.415L3.3 8.855a1 1 0 0 0 0 1.414l7.268 7.269a1 1 0 0 0 1.415-1.415L5.414 10l6.57-6.996Z" /><path d="m13.222 6.344 2.468-2.468a.75.75 0 0 1 1.061 0l.353.353a.75.75 0 0 1 0 1.06L14.282 8.12l-1.06-1.061Z" /><path d="m16.531 9.656-2.469 2.469a.75.75 0 0 1-1.06 0l-.354-.354a.75.75 0 0 1 0-1.06L15.47 7.88l1.061 1.06Z" /></svg>` }, // Changed color to orange
        'Entertainment': { color: 'var(--accent-pink)', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path d="M6.28 5.22a.75.75 0 0 0-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 1 0 1.06 1.06L10 11.06l3.72 3.72a.75.75 0 1 0 1.06-1.06L11.06 10l3.72-3.72a.75.75 0 0 0-1.06-1.06L10 8.94 6.28 5.22Z" /></svg>` }, // Changed to pink
        'Shopping': { color: '#ff80ed', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path fill-rule="evenodd" d="M10.237 4.22A2.25 2.25 0 0 0 8.5 3.25H7.25a.75.75 0 0 0 0 1.5h1.25a.75.75 0 0 1 .75.75v.128a3.738 3.738 0 0 0-2.438 1.242l-.08.088a3.75 3.75 0 0 0 .08 5.212l.092.09a3.75 3.75 0 0 0 5.212-.08l.088-.08a3.738 3.738 0 0 0 1.242-2.438V5.5a.75.75 0 0 1 .75-.75h1.25a.75.75 0 0 0 0-1.5h-1.25a2.25 2.25 0 0 0-1.963-1.03ZM10 11.25a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clip-rule="evenodd" /></svg>` },
        'Health': { color: 'var(--accent-red)', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm.75-11.25a.75.75 0 0 0-1.5 0v2.5h-2.5a.75.75 0 0 0 0 1.5h2.5v2.5a.75.75 0 0 0 1.5 0v-2.5h2.5a.75.75 0 0 0 0-1.5h-2.5v-2.5Z" clip-rule="evenodd" /></svg>` },
        'Personal': { color: '#a0a0a5', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.23 1.23 0 0 0 .41 1.412A9.957 9.957 0 0 0 10 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 0 0-13.074.003Z" /></svg>` },
        'Debt': { color: '#ff6b2e', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path fill-rule="evenodd" d="M1 10a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H1.75A.75.75 0 0 1 1 10Z" clip-rule="evenodd" /></svg>` },
        'Other': { color: 'var(--text-tertiary)', icon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon"><path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-7-4a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM9 9a.75.75 0 0 0 0 1.5h.253a.25.25 0 0 1 .244.304l-.459 2.066A1.75 1.75 0 0 0 10.747 15H11a.75.75 0 0 0 0-1.5h-.253a.25.25 0 0 1-.244-.304l.459-2.066A1.75 1.75 0 0 0 9.253 9H9Z" clip-rule="evenodd" /></svg>` }
    };
    const EXPENSE_CATEGORIES = Object.keys(CATEGORY_DETAILS);
    
    const BILL_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon" style="color: var(--accent-bill-icon);"><path d="M3.505 2.365A4.5 4.5 0 0 1 7.75 1.5h4.5a4.5 4.5 0 0 1 4.245.865L18.5 3.75a.5.5 0 0 1 .5.5v11.5a.5.5 0 0 1-.5.5h-17a.5.5 0 0 1-.5-.5V4.25a.5.5 0 0 1 .5-.5l2.005-1.385ZM7.5 3a2.5 2.5 0 0 0-2.359.501L3.5 4.754V15.5h13V4.754l-1.641-1.253A2.5 2.5 0 0 0 12.5 3h-5Z" /><path d="M12.5 8.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z" /><path d="M7.5 8.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z" /><path d="M12.5 11.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z" /><path d="M7.5 11.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5Z" /></svg>`;
    const PAYCHECK_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon" style="color: var(--accent-paycheck-icon);"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm1.91-6.776A.75.75 0 0 0 11.25 11h-2.5a.75.75 0 0 0 0 1.5h.098a1.607 1.607 0 0 1 .02 0l.09.006a2.005 2.005 0 0 1 1.606 1.037c.36.648.584 1.352.584 2.081a.75.75 0 0 0 .75.75c.414 0 .75-.336.75-.75 0-1.119-.386-2.172-1.03-3.048Zm-3.74-4.446a.75.75 0 0 0-1.06-1.06L6.049 6.775A3.505 3.505 0 0 0 8.75 6a.75.75 0 0 0 0-1.5A5.006 5.006 0 0 0 4.25 8.5a.75.75 0 0 0 .75.75c.414 0 .75-.336.75-.75a3.502 3.502 0 0 1 2.728-3.427Z" clip-rule="evenodd" /></svg>`;
    const BIRTHDAY_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon" style="color: var(--accent-birthday-icon);"><path d="M10 4a2 2 0 1 0-4 0 2 2 0 0 0 4 0Z" /><path fill-rule="evenodd" d="M8 1a1.5 1.5 0 0 0-1.447 1.035L4.273 7.5H2.5A1.5 1.5 0 0 0 1 9v3.5A1.5 1.5 0 0 0 2.5 14h15a1.5 1.5 0 0 0 1.5-1.5V9a1.5 1.5 0 0 0-1.5-1.5h-1.773l-2.28-5.465A1.5 1.5 0 0 0 12 1H8Zm0 1.5h4l2.053 4.928A1.5 1.5 0 0 0 15.447 9H14.5a.5.5 0 0 1 0-1h.447L13 5.5H7l-1.947 2.5H5.5a.5.5 0 0 1 0 1h-.947a1.5 1.5 0 0 0 1.394-1.572L8 2.5Z" clip-rule="evenodd" /><path d="M3.5 10.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1h-13Z" /></svg>`;
    const HOLIDAY_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="calendar-icon" style="color: var(--accent-holiday-icon);"><path fill-rule="evenodd" d="M9.422 2.22a.75.75 0 0 1 1.156 0l1.348 1.753c.1.13.25.214.416.237l2.14.295a.75.75 0 0 1 .416 1.28l-1.58 1.483a.753.753 0 0 0-.22.515l.41 2.094a.75.75 0 0 1-1.096.796l-1.882-1.03a.75.75 0 0 0-.702 0l-1.882 1.03a.75.75 0 0 1-1.096-.796l.41-2.094a.753.753 0 0 0-.22-.515L2.08 5.885a.75.75 0 0 1 .416-1.28l2.14-.295a.75.75 0 0 0 .416-.237l1.348-1.753Zm0 11.058a.75.75 0 0 1 1.156 0l1.348 1.753c.1.13.25.214.416.237l2.14.295a.75.75 0 0 1 .416 1.28l-1.58 1.483a.753.753 0 0 0-.22.515l.41 2.094a.75.75 0 0 1-1.096.796l-1.882-1.03a.75.75 0 0 0-.702 0l-1.882 1.03a.75.75 0 0 1-1.096-.796l.41-2.094a.753.753 0 0 0-.22-.515L2.08 17.165a.75.75 0 0 1 .416-1.28l2.14-.295a.75.75 0 0 0 .416-.237l1.348-1.753Z" clip-rule="evenodd" /></svg>`;


    const HOLIDAYS_2025 = { 
        "2025-01-01": "New Year's Day", "2025-01-20": "MLK Jr. Day", 
        "2025-02-17": "Washington's Birthday", "2025-05-26": "Memorial Day",
        "2025-06-19": "Juneteenth", "2025-07-04": "Independence Day",
        "2025-09-01": "Labor Day", "2025-10-13": "Columbus Day",
        "2025-11-11": "Veterans Day", "2025-11-27": "Thanksgiving Day",
        "2025-12-25": "Christmas Day"
    };
    const USER_BIRTHDAY = { month: 3, day: 11, name: "Your Birthday!" }; // April 11th

    const elements = {
        getStartedBtn: document.getElementById('getStartedBtn'), mainContent: document.getElementById('mainContent'),
        calendarGrid: document.getElementById('calendarGrid'), calendarHeaders: document.getElementById('calendarHeaders'),
        currentMonthYearDisplay: document.getElementById('currentMonthYear'), prevMonthBtn: document.getElementById('prevMonthBtn'),
        nextMonthBtn: document.getElementById('nextMonthBtn'), calendarPlaceholder: document.getElementById('calendar-placeholder'),
        
        dayDetailsModal: document.getElementById('dayDetailsModal'), 
        dayDetailsModalTitle: document.getElementById('dayDetailsModalTitle'),
        dayDetailsList: document.getElementById('dayDetailsList'),
        closeDayDetailsModalBtn: document.getElementById('closeDayDetailsModalBtn'),
        dayDetailsAddBtn: document.getElementById('dayDetailsAddBtn'),

        transactionModal: document.getElementById('transactionModal'), modalTitle: document.getElementById('modalTitle'),
        addTransactionBtnHeader: document.getElementById('addTransactionBtnHeader'), closeModalBtn: document.getElementById('closeModalBtn'),
        cancelModalBtn: document.getElementById('cancelModalBtn'), cancelModalBtnRecurring: document.getElementById('cancelModalBtnRecurring'),
        globalErrorModal: document.getElementById('global-error-modal'), tabExpense: document.getElementById('tab-expense'),
        tabBill: document.getElementById('tab-bill'), expenseFormModal: document.getElementById('expense-form-modal'),
        expenseIdModal: document.getElementById('expense-id-modal'), expenseDescInputModal: document.getElementById('expense-desc-modal'),
        expenseCategorySelectModal: document.getElementById('expense-category-modal'), expenseAmountInputModal: document.getElementById('expense-amount-modal'),
        expenseDateInputModal: document.getElementById('expense-date-modal'), recurringFormModal: document.getElementById('recurring-form-modal'),
        recurringIdModal: document.getElementById('recurring-id-modal'), recurringDescInputModal: document.getElementById('recurring-desc-modal'),
        recurringAmountInputModal: document.getElementById('recurring-amount-modal'), recurringDayInputModal: document.getElementById('recurring-day-modal'),
        incomeForm: document.getElementById('income-form'), weeklyIncomeInput: document.getElementById('weekly-income'),
        paydaySelect: document.getElementById('payday'), displayIncome: document.getElementById('display-income'),
        displayPayday: document.getElementById('display-payday'), expenseListSidebar: document.getElementById('expense-list-sidebar'),
        filterCategorySelectSidebar: document.getElementById('filter-category-sidebar'), recurringListSidebar: document.getElementById('recurring-list-sidebar'),
        dashboardSummaryIncome: document.getElementById('dashboard-summary-income'), dashboardSummaryExpenses: document.getElementById('dashboard-summary-expenses'),
        dashboardSummaryNet: document.getElementById('dashboard-summary-net'), footerYear: document.getElementById('footer-year'),

        addGoalForm: document.getElementById('add-goal-form'), goalNameInput: document.getElementById('goal-name'),
        goalTargetInput: document.getElementById('goal-target'), savingsGoalsList: document.getElementById('savings-goals-list'),
        insightContent: document.getElementById('insight-content'),
    };

    let state = {
        weeklyIncome: null, paydayOfWeek: null, expenses: [], recurringCharges: [], 
        savingsGoals: [], // { id, name, targetAmount, currentAmount }
        currentCalendarDate: new Date(), editingExpenseId: null, editingRecurringId: null, 
        currentFilterCategorySidebar: 'all',
        selectedDateForDayDetails: null, // To store date for Day Details modal
    };
    
    if (state.expenses.length === 0 && state.recurringCharges.length === 0 && state.savingsGoals.length === 0) {
        const todayForCalendar = new Date();
        state.currentCalendarDate = new Date(todayForCalendar.getFullYear() === 2025 ? 2025 : todayForCalendar.getFullYear(), 0, 1);
    }

    // --- Utility Functions ---
    function formatCurrency(amount) { if (amount == null || isNaN(amount)) return '$0.00'; return Number(amount).toLocaleString('en-US', { style: 'currency', currency: 'USD' }); }
    function getDayName(dayIndex) { const d = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; const i = parseInt(dayIndex, 10); return (i >= 0 && i <= 6) ? d[i] : 'N/A'; }
    function displayModalError(message, modalElement = elements.globalErrorModal) {
        if (modalElement) {
            modalElement.textContent = message;
            modalElement.classList.remove('hidden');
            setTimeout(() => { modalElement.classList.add('hidden'); }, 4000);
        } else { alert(message); }
    }

    // --- Data Persistence ---
    function saveData() { try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state)); } catch (e) { displayModalError("Save failed. LocalStorage might be full or disabled."); } }
    function loadData() {
        try {
            const d = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (d) {
                const parsed = JSON.parse(d);
                parsed.expenses = (parsed.expenses || []).map(exp => ({ ...exp, date: exp.date ? new Date(exp.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0] }));
                parsed.savingsGoals = parsed.savingsGoals || [];
                if (parsed.currentCalendarDate) { parsed.currentCalendarDate = new Date(parsed.currentCalendarDate); } 
                else { const todayForCalendar = new Date(); parsed.currentCalendarDate = new Date(todayForCalendar.getFullYear() === 2025 ? 2025 : todayForCalendar.getFullYear(), 0, 1); }
                state = { ...state, ...parsed };
            }
        } catch (e) { console.error("Load fail:", e); displayModalError("Could not load saved data."); localStorage.removeItem(LOCAL_STORAGE_KEY); }
    }

    // --- Calendar Logic ---
    function renderCalendar() {
        elements.calendarGrid.innerHTML = ''; elements.calendarHeaders.innerHTML = ''; 
        const today = new Date(); today.setHours(0,0,0,0); 
        const year = state.currentCalendarDate.getFullYear(); const month = state.currentCalendarDate.getMonth();
        elements.currentMonthYearDisplay.textContent = `${state.currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => { const h = document.createElement('div'); h.classList.add('calendar-header-cell'); h.textContent = day; elements.calendarHeaders.appendChild(h); });
        let itemsInMonth = false;
        for (let i = 0; i < firstDayOfMonth; i++) { const p = document.createElement('div'); p.classList.add('calendar-day-cell', 'other-month'); elements.calendarGrid.appendChild(p); }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div'); dayCell.classList.add('calendar-day-cell');
            const currentDate = new Date(year, month, day); currentDate.setHours(0,0,0,0); 
            const currentDateStr = currentDate.toISOString().split('T')[0];
            if (currentDate.getTime() === today.getTime()) { dayCell.classList.add('today'); }
            const dayNumSpan = document.createElement('span'); dayNumSpan.classList.add('day-number'); dayNumSpan.textContent = day; dayCell.appendChild(dayNumSpan);
            const itemIndicatorContainer = document.createElement('div'); itemIndicatorContainer.classList.add('item-indicator-container');
            let dayHasItems = false;

            // Holidays
            if (year === 2025 && HOLIDAYS_2025[currentDateStr]) {
                dayCell.classList.add('holiday-cell');
                const nameSpan = document.createElement('span'); nameSpan.classList.add('event-name-display', 'holiday-name-display'); nameSpan.textContent = HOLIDAYS_2025[currentDateStr]; dayCell.appendChild(nameSpan);
                const iconDiv = document.createElement('div'); iconDiv.innerHTML = HOLIDAY_ICON_SVG; itemIndicatorContainer.appendChild(iconDiv.firstChild);
                dayHasItems = true;
            }
            // Birthday
            if (currentDate.getMonth() === USER_BIRTHDAY.month && currentDate.getDate() === USER_BIRTHDAY.day) {
                dayCell.classList.add('birthday-cell');
                const nameSpan = document.createElement('span'); nameSpan.classList.add('event-name-display', 'birthday-name-display'); nameSpan.textContent = USER_BIRTHDAY.name; dayCell.appendChild(nameSpan);
                const iconDiv = document.createElement('div'); iconDiv.innerHTML = BIRTHDAY_ICON_SVG; itemIndicatorContainer.appendChild(iconDiv.firstChild);
                dayHasItems = true;
            }
            // Expenses
            const expensesForDay = state.expenses.filter(e => { const ed = new Date(e.date+'T00:00:00'); return ed.getTime() === currentDate.getTime(); });
            expensesForDay.forEach(exp => {
                dayHasItems = true;
                const catDet = CATEGORY_DETAILS[exp.category] || CATEGORY_DETAILS['Other'];
                const ind = document.createElement('div'); ind.innerHTML = catDet.icon;
                const svg = ind.querySelector('svg'); if (svg) { let c = catDet.color; if (c.startsWith('var(')) c = getComputedStyle(document.documentElement).getPropertyValue(c.substring(4,c.length-1)).trim(); svg.style.color = c; }
                itemIndicatorContainer.appendChild(ind.firstChild);
            });
            // Bills
            const billsForDay = state.recurringCharges.filter(b => b.dayDue === day);
            billsForDay.forEach(() => { dayHasItems = true; const iconDiv = document.createElement('div'); iconDiv.innerHTML = BILL_ICON_SVG; itemIndicatorContainer.appendChild(iconDiv.firstChild); });
            // Paychecks
            if (state.weeklyIncome && state.paydayOfWeek !== null && currentDate.getDay() === state.paydayOfWeek) {
                dayHasItems = true; const iconDiv = document.createElement('div'); iconDiv.innerHTML = PAYCHECK_ICON_SVG; itemIndicatorContainer.appendChild(iconDiv.firstChild);
            }
            if (dayHasItems) itemsInMonth = true;
            if (itemIndicatorContainer.hasChildNodes()) dayCell.appendChild(itemIndicatorContainer);
            dayCell.addEventListener('click', () => openDayDetailsModal(currentDateStr));
            elements.calendarGrid.appendChild(dayCell);
        }
        elements.calendarPlaceholder.classList.toggle('hidden', itemsInMonth);
        const totalCells = firstDayOfMonth + daysInMonth; const remainingCells = (7-(totalCells % 7))%7;
        for (let i=0; i<remainingCells; i++) { const n = document.createElement('div'); n.classList.add('calendar-day-cell','other-month'); elements.calendarGrid.appendChild(n); }
    }

    // --- Day Details Modal ---
    function openDayDetailsModal(dateStr) {
        state.selectedDateForDayDetails = dateStr;
        const dateObj = new Date(dateStr + 'T00:00:00'); // Ensure local interpretation
        elements.dayDetailsModalTitle.textContent = `Details for ${dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
        elements.dayDetailsList.innerHTML = ''; // Clear previous items
        let itemsFound = false;

        // Display Holiday
        if (dateObj.getFullYear() === 2025 && HOLIDAYS_2025[dateStr]) {
            const holidayItem = createDayDetailItem(HOLIDAYS_2025[dateStr], '', HOLIDAY_ICON_SVG, 'var(--accent-holiday-icon)');
            elements.dayDetailsList.appendChild(holidayItem);
            itemsFound = true;
        }
        // Display Birthday
        if (dateObj.getMonth() === USER_BIRTHDAY.month && dateObj.getDate() === USER_BIRTHDAY.day) {
            const birthdayItem = createDayDetailItem(USER_BIRTHDAY.name, '', BIRTHDAY_ICON_SVG, 'var(--accent-birthday-icon)');
            elements.dayDetailsList.appendChild(birthdayItem);
            itemsFound = true;
        }
        // Display Paycheck
        if (state.weeklyIncome && state.paydayOfWeek !== null && dateObj.getDay() === state.paydayOfWeek) {
            const paycheckItem = createDayDetailItem('Paycheck Received', formatCurrency(state.weeklyIncome), PAYCHECK_ICON_SVG, 'var(--accent-paycheck-icon)');
            elements.dayDetailsList.appendChild(paycheckItem);
            itemsFound = true;
        }
        // Display Expenses
        state.expenses.filter(exp => exp.date === dateStr).forEach(exp => {
            const catDet = CATEGORY_DETAILS[exp.category] || CATEGORY_DETAILS['Other'];
            const expenseItem = createDayDetailItem(exp.desc, formatCurrency(exp.amount), catDet.icon, catDet.color, 'expense', exp.id);
            elements.dayDetailsList.appendChild(expenseItem);
            itemsFound = true;
        });
        // Display Bills Due
        state.recurringCharges.filter(bill => bill.dayDue === dateObj.getDate()).forEach(bill => {
            const billItem = createDayDetailItem(bill.desc, formatCurrency(bill.amount) + " (Bill)", BILL_ICON_SVG, 'var(--accent-bill-icon)', 'recurring', bill.id);
            elements.dayDetailsList.appendChild(billItem);
            itemsFound = true;
        });

        if (!itemsFound) {
            elements.dayDetailsList.innerHTML = `<p class="text-center text-[var(--text-secondary)] p-4">Nothing scheduled for this day.</p>`;
        }
        elements.dayDetailsModal.classList.add('active');
    }

    function createDayDetailItem(description, amountText, iconSvgStr, iconColorVar, itemType = null, itemId = null) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'day-details-item';
        if (itemType && itemId) { // Make editable items clickable
            itemDiv.classList.add('day-details-item-clickable');
            itemDiv.addEventListener('click', () => {
                closeDayDetailsModal(); // Close day details before opening transaction modal
                if (itemType === 'expense') openTransactionModal(state.selectedDateForDayDetails, itemId, null);
                if (itemType === 'recurring') openTransactionModal(state.selectedDateForDayDetails, null, itemId);
            });
        }

        let iconColor = iconColorVar.startsWith('var(') ? getComputedStyle(document.documentElement).getPropertyValue(iconColorVar.substring(4, iconColorVar.length - 1)).trim() : iconColorVar;
        
        // Create a temporary div to parse the SVG and apply color
        const tempIconDiv = document.createElement('div');
        tempIconDiv.innerHTML = iconSvgStr;
        const svgElement = tempIconDiv.querySelector('svg');
        if(svgElement) {
            svgElement.style.color = iconColor; // Apply color directly
            svgElement.classList.add('day-details-item-icon'); // Add class for sizing
        }

        itemDiv.innerHTML = `
            ${svgElement ? svgElement.outerHTML : '<div class="day-details-item-icon"></div>'}
            <span class="day-details-item-desc">${description}</span>
            <span class="day-details-item-amount">${amountText}</span>
        `;
        return itemDiv;
    }

    function closeDayDetailsModal() { elements.dayDetailsModal.classList.remove('active'); }

    // --- Transaction Modal Logic (Add/Edit) ---
    function openTransactionModal(date = null, expenseId = null, recurringId = null) {
        elements.transactionModal.classList.add('active');
        elements.modalTitle.textContent = 'Add Transaction';
        elements.globalErrorModal.classList.add('hidden'); 
        elements.expenseFormModal.reset(); elements.recurringFormModal.reset();
        state.editingExpenseId = null; state.editingRecurringId = null;
        elements.expenseIdModal.value = ''; elements.recurringIdModal.value = '';
        elements.expenseDateInputModal.value = date ? date : new Date().toISOString().split('T')[0];

        if (expenseId) { 
            const exp = state.expenses.find(e => e.id === expenseId);
            if (exp) {
                elements.modalTitle.textContent = 'Edit Expense'; state.editingExpenseId = expenseId;
                elements.expenseIdModal.value = exp.id; elements.expenseDescInputModal.value = exp.desc;
                elements.expenseCategorySelectModal.value = exp.category; elements.expenseAmountInputModal.value = exp.amount;
                elements.expenseDateInputModal.value = exp.date; 
                switchModalForm('expense');
            }
        } else if (recurringId) { 
             const bill = state.recurringCharges.find(b => b.id === recurringId);
            if (bill) {
                elements.modalTitle.textContent = 'Edit Bill'; state.editingRecurringId = recurringId;
                elements.recurringIdModal.value = bill.id; elements.recurringDescInputModal.value = bill.desc;
                elements.recurringAmountInputModal.value = bill.amount; elements.recurringDayInputModal.value = bill.dayDue;
                switchModalForm('bill');
            }
        } else { switchModalForm('expense'); }
    }
    function closeModal() { elements.transactionModal.classList.remove('active'); state.editingExpenseId = null; state.editingRecurringId = null;}
    function switchModalForm(formType) {
        const isExpense = formType === 'expense';
        ['tabExpense', 'tabBill'].forEach(tabId => {
            const tab = elements[tabId];
            const isActive = (tabId === 'tab-expense' && isExpense) || (tabId === 'tab-bill' && !isExpense);
            tab.classList.toggle('active', isActive);
            tab.classList.toggle('border-[var(--accent-primary)]', isActive);
            tab.classList.toggle('text-[var(--accent-primary)]', isActive);
            tab.classList.toggle('text-[var(--text-secondary)]', !isActive);
            tab.classList.toggle('border-transparent', !isActive);
        });
        elements.expenseFormModal.classList.toggle('hidden', !isExpense);
        elements.recurringFormModal.classList.toggle('hidden', isExpense);
        if (isExpense && !state.editingExpenseId) elements.modalTitle.textContent = 'Add Expense';
        if (!isExpense && !state.editingRecurringId) elements.modalTitle.textContent = 'Add Bill';
    }

    // --- Form Handlers ---
    function handleExpenseSubmitModal(event) {
        event.preventDefault();
        const id = elements.expenseIdModal.value || Date.now().toString() + Math.random().toString(36).substring(2, 9);
        const desc = elements.expenseDescInputModal.value.trim(); const category = elements.expenseCategorySelectModal.value;
        const amount = parseFloat(elements.expenseAmountInputModal.value); const date = elements.expenseDateInputModal.value; 
        if (!desc || !category || isNaN(amount) || amount <= 0 || !date) { displayModalError("Please fill all expense fields correctly."); return; }
        const newExpense = { id, desc, category, amount, date };
        if (state.editingExpenseId) { state.expenses = state.expenses.map(exp => exp.id === state.editingExpenseId ? newExpense : exp); } 
        else { state.expenses.push(newExpense); }
        saveData(); renderAll(); closeModal();
    }
    function handleRecurringSubmitModal(event) {
        event.preventDefault();
        const id = elements.recurringIdModal.value || Date.now().toString() + Math.random().toString(36).substring(2,9);
        const desc = elements.recurringDescInputModal.value.trim(); const amount = parseFloat(elements.recurringAmountInputModal.value);
        const dayDue = parseInt(elements.recurringDayInputModal.value, 10);
        if (!desc || isNaN(amount) || amount <= 0 || isNaN(dayDue) || dayDue < 1 || dayDue > 31) { displayModalError("Please fill all bill fields correctly."); return; }
        const newBill = { id, desc, amount, dayDue };
        if (state.editingRecurringId) { state.recurringCharges = state.recurringCharges.map(b => b.id === state.editingRecurringId ? newBill : b); } 
        else { state.recurringCharges.push(newBill); }
        saveData(); renderAll(); closeModal();
    }
    function handleIncomeSubmit(event) {
        event.preventDefault();
        const weeklyAmount = parseFloat(elements.weeklyIncomeInput.value); const payday = elements.paydaySelect.value;
        if (isNaN(weeklyAmount) || weeklyAmount < 0) { displayModalError("Invalid income amount."); return; }
        if (payday === "" || payday === null) { displayModalError("Please select a payday."); return; }
        state.weeklyIncome = weeklyAmount; state.paydayOfWeek = parseInt(payday, 10);
        saveData(); renderIncomeDisplay(); renderMonthlySummary(); renderCalendar();
    }
    function handleAddGoalSubmit(event) {
        event.preventDefault();
        const name = elements.goalNameInput.value.trim();
        const targetAmount = parseFloat(elements.goalTargetInput.value);
        if (!name || isNaN(targetAmount) || targetAmount <= 0) {
            displayModalError("Please enter a valid goal name and target amount.", elements.savingsGoalsList.querySelector('.text-xs') || undefined); // Show error near form
            return;
        }
        const newGoal = { id: Date.now().toString(), name, targetAmount, currentAmount: 0 };
        state.savingsGoals.push(newGoal);
        saveData(); renderSavingsGoals();
        elements.addGoalForm.reset();
    }
    function handleAddToGoal(goalId, amount) {
        const goal = state.savingsGoals.find(g => g.id === goalId);
        if (goal && !isNaN(amount) && amount > 0) {
            goal.currentAmount = Math.min(goal.targetAmount, (goal.currentAmount || 0) + amount);
            saveData(); renderSavingsGoals();
        } else if (goal && (isNaN(amount) || amount <=0)) {
            alert("Please enter a valid positive amount to add.");
        }
    }
    function handleDeleteGoal(goalId) {
        if (confirm("Are you sure you want to delete this savings goal?")) {
            state.savingsGoals = state.savingsGoals.filter(g => g.id !== goalId);
            saveData(); renderSavingsGoals();
        }
    }


    // --- Rendering Sidebar Lists & Summaries ---
    function renderIncomeDisplay() {
        elements.displayIncome.textContent = formatCurrency(state.weeklyIncome);
        elements.displayPayday.textContent = getDayName(state.paydayOfWeek);
        elements.weeklyIncomeInput.value = state.weeklyIncome ?? '';
        elements.paydaySelect.value = state.paydayOfWeek ?? '';
    }
    function renderExpensesSidebar() {
        elements.expenseListSidebar.innerHTML = '';
        const filteredExpenses = state.expenses.filter(exp => state.currentFilterCategorySidebar === 'all' || exp.category === state.currentFilterCategorySidebar)
                                .sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 15); 
        if (filteredExpenses.length === 0) { elements.expenseListSidebar.innerHTML = `<li class="text-[var(--text-secondary)] italic p-2 text-center">No expenses match filter.</li>`; return; }
        filteredExpenses.forEach(exp => {
            const li = document.createElement('li'); li.classList.add('transaction-list-item');
            const catDet = CATEGORY_DETAILS[exp.category] || CATEGORY_DETAILS['Other'];
            const getColor = (c) => c.startsWith('var(') ? getComputedStyle(document.documentElement).getPropertyValue(c.substring(4,c.length-1)).trim() : c;
            const actualColor = getColor(catDet.color);
            li.innerHTML = `
                <div class="flex-grow mr-2">
                    <span class="font-medium text-[var(--text-primary)] block text-sm">${exp.desc}</span>
                    <div class="text-xs text-[var(--text-secondary)] flex items-center gap-2 mt-0.5">
                        <span>${formatCurrency(exp.amount)}</span>
                        <span>${new Date(exp.date + 'T00:00:00').toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>
                        <span class="category-badge-list" style="background-color: ${actualColor}26; color: ${actualColor}; border-color: ${actualColor}4D;">
                           ${catDet.icon} ${exp.category}</span></div></div>
                <div class="flex-shrink-0 flex gap-1">
                    <button data-id="${exp.id}" data-type="expense" class="transaction-edit-button text-[var(--accent-primary)] opacity-70 hover:opacity-100 p-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343Z" /></svg></button>
                    <button data-id="${exp.id}" data-type="expense" class="transaction-delete-button"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button></div>`;
            elements.expenseListSidebar.appendChild(li);
        });
    }
    function renderRecurringBillsSidebar() {
        elements.recurringListSidebar.innerHTML = '';
        const sortedBills = [...state.recurringCharges].sort((a,b) => a.dayDue - b.dayDue);
        if (sortedBills.length === 0) { elements.recurringListSidebar.innerHTML = `<li class="text-[var(--text-secondary)] italic p-2 text-center">No bills added.</li>`; return; }
        sortedBills.forEach(bill => {
            const li = document.createElement('li'); li.classList.add('transaction-list-item');
            li.innerHTML = `
                <div class="flex-grow mr-2"><span class="font-medium text-[var(--text-primary)] block text-sm">${bill.desc}</span>
                    <span class="text-xs text-[var(--text-secondary)]">Due Day: ${bill.dayDue} (${formatCurrency(bill.amount)})</span></div>
                <div class="flex-shrink-0 flex gap-1">
                     <button data-id="${bill.id}" data-type="recurring" class="transaction-edit-button text-[var(--accent-primary)] opacity-70 hover:opacity-100 p-1"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343Z" /></svg></button>
                    <button data-id="${bill.id}" data-type="recurring" class="transaction-delete-button"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg></button></div>`;
            elements.recurringListSidebar.appendChild(li);
        });
    }
    function renderSavingsGoals() {
        elements.savingsGoalsList.innerHTML = '';
        if (state.savingsGoals.length === 0) { elements.savingsGoalsList.innerHTML = `<li class="text-center text-xs text-[var(--text-secondary)]">No savings goals yet.</li>`; return; }
        state.savingsGoals.forEach(goal => {
            const li = document.createElement('li'); li.classList.add('savings-goal-item');
            const percentage = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
            li.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="font-medium text-sm">${goal.name}</span>
                    <span class="text-xs text-[var(--text-secondary)]">${formatCurrency(goal.currentAmount)} / ${formatCurrency(goal.targetAmount)}</span>
                </div>
                <div class="savings-goal-progress-bar-bg mb-2"><div class="savings-goal-progress-bar-fg" style="width: ${percentage.toFixed(2)}%;"></div></div>
                <div class="flex justify-end items-center gap-2">
                    <input type="number" class="apple-input !text-xs !py-1 !w-20 add-to-goal-amount-input" placeholder="Amt" data-goal-id="${goal.id}" step="10">
                    <button class="apple-button apple-button-secondary add-to-goal-btn" data-goal-id="${goal.id}">Add</button>
                    <button class="transaction-delete-button delete-goal-btn" data-goal-id="${goal.id}" title="Delete Goal">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>
                    </button>
                </div>`;
            elements.savingsGoalsList.appendChild(li);
        });
        // Re-attach event listeners for new "Add to Goal" and "Delete Goal" buttons
        document.querySelectorAll('.add-to-goal-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const goalId = e.target.dataset.goalId;
                const amountInput = document.querySelector(`.add-to-goal-amount-input[data-goal-id="${goalId}"]`);
                if (amountInput) {
                    handleAddToGoal(goalId, parseFloat(amountInput.value));
                    amountInput.value = ''; // Clear input after adding
                }
            });
        });
        document.querySelectorAll('.delete-goal-btn').forEach(button => {
            button.addEventListener('click', (e) => handleDeleteGoal(e.currentTarget.dataset.goalId));
        });
    }
    function renderFinancialInsights() {
        elements.insightContent.innerHTML = ''; // Clear previous insights
        let insightsGenerated = 0;

        // Insight 1: Savings Rate (if income is set)
        if (state.weeklyIncome && state.paydayOfWeek !== null) {
            const currentMonth = state.currentCalendarDate.getMonth();
            const currentYear = state.currentCalendarDate.getFullYear();
            let paydaysInMonth = 0;
            const daysInCurrentMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let day = 1; day <= daysInCurrentMonth; day++) {
                if (new Date(currentYear, currentMonth, day).getDay() === state.paydayOfWeek) paydaysInMonth++;
            }
            const monthlyIncome = state.weeklyIncome * paydaysInMonth;
            const monthlyExpensesTotal = state.expenses.filter(exp => { const d=new Date(exp.date+'T00:00:00'); return d.getMonth()===currentMonth && d.getFullYear()===currentYear; }).reduce((s,e)=>s+e.amount,0);
            const monthlyRecurringTotal = state.recurringCharges.reduce((s,c)=>s+c.amount,0);
            const totalSpending = monthlyExpensesTotal + monthlyRecurringTotal;
            const netSavings = monthlyIncome - totalSpending;

            if (monthlyIncome > 0) {
                const savingsRate = (netSavings / monthlyIncome) * 100;
                const p = document.createElement('p');
                p.innerHTML = `This month's estimated savings rate: <strong class="${savingsRate >= 0 ? 'text-positive' : 'text-negative'}">${savingsRate.toFixed(1)}%</strong>`;
                elements.insightContent.appendChild(p);
                insightsGenerated++;
            }
        }

        // Insight 2: Spending vs Last Month (if enough data)
        const currentMonthExpenses = state.expenses.filter(exp => { const d=new Date(exp.date+'T00:00:00'); return d.getMonth()===state.currentCalendarDate.getMonth() && d.getFullYear()===state.currentCalendarDate.getFullYear(); }).reduce((s,e)=>s+e.amount,0);
        const lastMonthDate = new Date(state.currentCalendarDate); lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
        const lastMonthExpenses = state.expenses.filter(exp => { const d=new Date(exp.date+'T00:00:00'); return d.getMonth()===lastMonthDate.getMonth() && d.getFullYear()===lastMonthDate.getFullYear(); }).reduce((s,e)=>s+e.amount,0);

        if (currentMonthExpenses > 0 && lastMonthExpenses > 0) {
            const diff = currentMonthExpenses - lastMonthExpenses;
            const percentageDiff = (diff / lastMonthExpenses) * 100;
            const p = document.createElement('p');
            p.innerHTML = `Spending this month (${formatCurrency(currentMonthExpenses)}) is <strong class="${percentageDiff >= 0 ? 'text-negative' : 'text-positive'}">${Math.abs(percentageDiff).toFixed(0)}% ${percentageDiff >= 0 ? 'higher' : 'lower'}</strong> than last month (${formatCurrency(lastMonthExpenses)}).`;
            elements.insightContent.appendChild(p);
            insightsGenerated++;
        }
        
        if (insightsGenerated === 0) {
            elements.insightContent.innerHTML = `<p class="text-[var(--text-secondary)]">Add more income and expense data to see insights.</p>`;
        }
    }
    function renderMonthlySummary() {
        const currentMonth = state.currentCalendarDate.getMonth(); const currentYear = state.currentCalendarDate.getFullYear();
        let monthlyIncome = 0;
        if (state.weeklyIncome && state.paydayOfWeek !== null) {
            let paydaysInMonth = 0; const daysInCurrentMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let day = 1; day <= daysInCurrentMonth; day++) { if (new Date(currentYear, currentMonth, day).getDay() === state.paydayOfWeek) paydaysInMonth++; }
            monthlyIncome = state.weeklyIncome * paydaysInMonth;
        }
        const monthlyExpensesTotal = state.expenses.filter(exp => { const d=new Date(exp.date+'T00:00:00'); return d.getMonth()===currentMonth && d.getFullYear()===currentYear; }).reduce((s,e)=>s+e.amount,0);
        const monthlyRecurringTotal = state.recurringCharges.reduce((s,c)=>s+c.amount,0);
        const totalSpending = monthlyExpensesTotal + monthlyRecurringTotal; const net = monthlyIncome - totalSpending;
        elements.dashboardSummaryIncome.textContent = formatCurrency(monthlyIncome);
        elements.dashboardSummaryExpenses.textContent = formatCurrency(totalSpending);
        elements.dashboardSummaryNet.textContent = formatCurrency(net);
        elements.dashboardSummaryNet.classList.remove('text-positive', 'text-negative', 'text-white');
        if (net > 0) elements.dashboardSummaryNet.classList.add('text-positive');
        else if (net < 0) elements.dashboardSummaryNet.classList.add('text-negative');
        else elements.dashboardSummaryNet.classList.add('text-white'); 
    }
    function populateCategoryFilters() {
        elements.expenseCategorySelectModal.innerHTML = '<option value="" disabled selected>Select Category</option>';
        EXPENSE_CATEGORIES.forEach(cat => { const o=document.createElement('option'); o.value=cat; o.textContent=cat; elements.expenseCategorySelectModal.appendChild(o); });
        elements.filterCategorySelectSidebar.innerHTML = '<option value="all">All Categories</option>';
        EXPENSE_CATEGORIES.forEach(cat => { const o=document.createElement('option'); o.value=cat; o.textContent=cat; elements.filterCategorySelectSidebar.appendChild(o); });
        elements.filterCategorySelectSidebar.value = state.currentFilterCategorySidebar;
    }
    
    // --- Event Handlers for Deletion/Editing from Sidebar ---
    function handleDeleteClickSidebar(event) {
        const button = event.target.closest('.transaction-delete-button'); if (!button) return;
        const id = button.dataset.id; const type = button.dataset.type; if (!id || !type) return;
        if (confirm(`Are you sure you want to delete this ${type}?`)) {
            if (type === 'expense') { state.expenses = state.expenses.filter(item => item.id !== id); } 
            else if (type === 'recurring') { state.recurringCharges = state.recurringCharges.filter(item => item.id !== id); }
            saveData(); renderAll();
        }
    }
    function handleEditClickSidebar(event) {
        const button = event.target.closest('.transaction-edit-button'); if (!button) return;
        const id = button.dataset.id; const type = button.dataset.type;
        if (type === 'expense') { openTransactionModal(null, id, null); } 
        else if (type === 'recurring') { openTransactionModal(null, null, id); }
    }

    // --- Initialization ---
    function renderAll() {
        renderCalendar(); renderIncomeDisplay(); renderExpensesSidebar(); renderRecurringBillsSidebar();
        renderMonthlySummary(); populateCategoryFilters(); renderSavingsGoals(); renderFinancialInsights();
    }
    function initializeApp() {
        elements.footerYear.textContent = new Date().getFullYear(); loadData(); renderAll(); 
        elements.getStartedBtn.addEventListener('click', () => elements.mainContent.scrollIntoView({ behavior: 'smooth' }));
        elements.prevMonthBtn.addEventListener('click', () => { state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() - 1); saveData(); renderAll(); });
        elements.nextMonthBtn.addEventListener('click', () => { state.currentCalendarDate.setMonth(state.currentCalendarDate.getMonth() + 1); saveData(); renderAll(); });
        
        elements.addTransactionBtnHeader.addEventListener('click', () => openTransactionModal(state.selectedDateForDayDetails || new Date().toISOString().split('T')[0] )); // Pass current day details date or today
        elements.closeModalBtn.addEventListener('click', closeModal);
        elements.cancelModalBtn.addEventListener('click', closeModal);
        elements.cancelModalBtnRecurring.addEventListener('click', closeModal);
        elements.tabExpense.addEventListener('click', () => switchModalForm('expense'));
        elements.tabBill.addEventListener('click', () => switchModalForm('bill'));
        elements.expenseFormModal.addEventListener('submit', handleExpenseSubmitModal);
        elements.recurringFormModal.addEventListener('submit', handleRecurringSubmitModal);
        elements.incomeForm.addEventListener('submit', handleIncomeSubmit);
        elements.addGoalForm.addEventListener('submit', handleAddGoalSubmit);

        elements.filterCategorySelectSidebar.addEventListener('change', (e) => { state.currentFilterCategorySidebar = e.target.value; renderExpensesSidebar(); });
        elements.expenseListSidebar.addEventListener('click', (event) => { handleDeleteClickSidebar(event); handleEditClickSidebar(event); });
        elements.recurringListSidebar.addEventListener('click', (event) => { handleDeleteClickSidebar(event); handleEditClickSidebar(event); });
        
        elements.transactionModal.addEventListener('click', (e) => { if (e.target === elements.transactionModal) closeModal(); });
        elements.dayDetailsModal.addEventListener('click', (e) => { if (e.target === elements.dayDetailsModal) closeDayDetailsModal(); });
        elements.closeDayDetailsModalBtn.addEventListener('click', closeDayDetailsModal);
        elements.dayDetailsAddBtn.addEventListener('click', () => {
            const selectedDate = state.selectedDateForDayDetails || new Date().toISOString().split('T')[0];
            closeDayDetailsModal(); // Close day details first
            openTransactionModal(selectedDate); // Then open transaction modal for that date
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (elements.dayDetailsModal.classList.contains('active')) closeDayDetailsModal();
                else if (elements.transactionModal.classList.contains('active')) closeModal();
            }
        });
    }
    document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
