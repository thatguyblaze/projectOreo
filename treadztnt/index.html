<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treadz - Towing & Inventory Dashboard</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* Define CSS Variables for Theming (Light/Dark) */
        :root {
            --bg-primary-light: #f8fafc; /* slate-50 */
            --bg-primary-dark: #0f172a;  /* slate-900 */
            --bg-secondary-light: #ffffff; /* white */
            --bg-secondary-dark: #1e293b; /* slate-800 */
            --bg-accent-light: #e0f2fe; /* sky-100 */
            --bg-accent-dark: #38bdf8; /* sky-400 */
            --text-primary-light: #0f172a; /* slate-900 */
            --text-primary-dark: #f8fafc; /* slate-50 */
            --text-secondary-light: #64748b; /* slate-500 */
            --text-secondary-dark: #94a3b8; /* slate-400 */
            --text-accent-light: #0284c7; /* sky-600 */
            --text-accent-dark: #e0f2fe; /* sky-100 */
            --border-light: #e2e8f0; /* slate-200 */
            --border-dark: #334155; /* slate-700 */
            --brand-gradient: linear-gradient(to right, #3b82f6, #22d3ee); /* blue-500 to cyan-400 */
            --brand-gradient-dark: linear-gradient(to right, #60a5fa, #67e8f9); /* blue-400 to cyan-300 */
            --success-light: #10b981; /* emerald-500 */
            --success-dark: #34d399; /* emerald-400 */
            --danger-light: #ef4444; /* red-500 */
            --danger-dark: #f87171; /* red-400 */
            --warning-light: #f59e0b; /* amber-500 */
            --warning-dark: #fbbf24; /* amber-400 */
            --info-light: #3b82f6; /* blue-500 */
            --info-dark: #60a5fa; /* blue-400 */
            --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-dark: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.15);
            --shadow-lg-light: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
            --shadow-lg-dark: 0 10px 15px -3px rgba(0, 0, 0, 0.25), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
        }

        /* Base Body Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary-light);
            color: var(--text-primary-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dark body {
            background-color: var(--bg-primary-dark);
            color: var(--text-primary-dark);
        }
        main { flex-grow: 1; }
        footer { margin-top: auto; }

        /* Gradient Text Utility */
        .text-gradient {
            background: var(--brand-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .dark .text-gradient {
            background: var(--brand-gradient-dark);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Card Styling */
        .card {
            background-color: var(--bg-secondary-light);
            border-radius: 1rem; /* rounded-2xl */
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-light);
            padding: 1.5rem; /* p-6 */
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden; /* For potential internal animations/effects */
        }
        .dark .card {
            background-color: var(--bg-secondary-dark);
            border-color: var(--border-dark);
            box-shadow: var(--shadow-dark);
        }

        /* Input/Select Styling */
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            border: 1px solid var(--border-light);
            border-radius: 0.75rem; /* rounded-xl */
            background-color: var(--bg-primary-light); /* Slightly different bg */
            color: var(--text-primary-light);
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            font-size: 0.875rem; /* text-sm */
        }
        .dark .form-input, .dark .form-select {
            border-color: var(--border-dark);
            background-color: var(--bg-primary-dark);
            color: var(--text-primary-dark);
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--info-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* blue-500 focus ring */
        }
        .dark .form-input:focus, .dark .form-select:focus {
            border-color: var(--info-dark);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.4); /* blue-400 focus ring */
        }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.875rem; color: var(--text-secondary-light); }
        .dark label { color: var(--text-secondary-dark); }

        /* Button Styling */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem; /* py-3 px-5 */
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 600; /* font-semibold */
            font-size: 0.875rem; /* text-sm */
            transition: transform 0.15s ease, box-shadow 0.15s ease, background-size 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-light);
            background-size: 200% auto; /* For gradient hover */
        }
        .dark .btn { box-shadow: var(--shadow-dark); }
        .btn:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .dark .btn:focus-visible { box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg-light); background-position: right center; /* Gradient shift */ }
        .dark .btn:hover { box-shadow: var(--shadow-lg-dark); }
        .btn:active { transform: translateY(0px); box-shadow: var(--shadow-light); }
        .dark .btn:active { box-shadow: var(--shadow-dark); }

        .btn-primary {
            background-image: var(--brand-gradient);
            color: white;
        }
        .dark .btn-primary { background-image: var(--brand-gradient-dark); color: var(--text-primary-light); }

        .btn-secondary {
            background-color: var(--bg-secondary-light);
            color: var(--text-primary-light);
            border: 1px solid var(--border-light);
        }
        .btn-secondary:hover { background-color: #f1f5f9; } /* slate-100 */
        .dark .btn-secondary {
            background-color: var(--bg-secondary-dark);
            color: var(--text-primary-dark);
            border-color: var(--border-dark);
        }
        .dark .btn-secondary:hover { background-color: #334155; } /* slate-700 */

        .btn-success { background-color: var(--success-light); color: white; }
        .btn-success:hover { background-color: #059669; } /* emerald-600 */
        .dark .btn-success { background-color: var(--success-dark); color: var(--text-primary-light); }
        .dark .btn-success:hover { background-color: #10b981; } /* emerald-500 */

        .btn-danger { background-color: var(--danger-light); color: white; }
        .btn-danger:hover { background-color: #dc2626; } /* red-600 */
        .dark .btn-danger { background-color: var(--danger-dark); color: var(--text-primary-light); }
        .dark .btn-danger:hover { background-color: #ef4444; } /* red-500 */

        .btn-icon { padding: 0.625rem; /* p-2.5 */ }
        .btn svg { width: 1.125rem; height: 1.125rem; /* size-4.5 */ }
        .btn span + svg, .btn svg + span { margin-left: 0.5rem; /* ml-2 */ } /* Spacing between icon and text */

        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 52px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; /* slate-300 */ transition: .4s; border-radius: 28px; }
        .dark .slider { background-color: #475569; } /* slate-600 */
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input:checked + .slider { background-image: var(--brand-gradient); }
        .dark input:checked + .slider { background-image: var(--brand-gradient-dark); }
        input:focus-visible + .slider { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        .dark input:focus-visible + .slider { box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* Table Styling */
        .table-wrapper { overflow-x: auto; border: 1px solid var(--border-light); border-radius: 1rem; }
        .dark .table-wrapper { border-color: var(--border-dark); }
        .data-table { min-width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table th, .data-table td {
            padding: 1rem 1.25rem; /* py-4 px-5 */
            text-align: left;
            font-size: 0.875rem; /* text-sm */
            white-space: nowrap;
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.3s ease;
        }
        .dark .data-table th, .dark .data-table td { border-bottom-color: var(--border-dark); }
        .data-table th {
            font-weight: 600; /* font-semibold */
            color: var(--text-secondary-light);
            background-color: var(--bg-primary-light); /* Header background */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            position: sticky; /* Sticky header */
            top: 0;
            z-index: 10;
        }
        .dark .data-table th {
            background-color: var(--bg-primary-dark);
            color: var(--text-secondary-dark);
        }
        .data-table tbody tr:last-child td { border-bottom: none; } /* Remove border on last row */
        .data-table tbody tr { transition: background-color 0.2s ease-in-out; }
        .data-table tbody tr:hover { background-color: rgba(59, 130, 246, 0.05); } /* Subtle blue hover */
        .dark .data-table tbody tr:hover { background-color: rgba(96, 165, 250, 0.08); }

        /* Table Highlighting */
        .highlight-yellow { background-color: rgba(251, 191, 36, 0.1) !important; } /* amber-400 with opacity */
        .dark .highlight-yellow { background-color: rgba(251, 191, 36, 0.15) !important; }
        .highlight-red { background-color: rgba(248, 113, 113, 0.1) !important; } /* red-400 with opacity */
        .dark .highlight-red { background-color: rgba(248, 113, 113, 0.15) !important; }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            overflow-y: auto; height: 100%; width: 100%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 50;
        }
        .modal-content {
            background-color: var(--bg-secondary-light);
            border-radius: 1rem; /* rounded-2xl */
            box-shadow: var(--shadow-lg-light);
            width: 100%; max-width: 550px; /* Slightly wider */
            margin: 1rem;
            transform: scale(0.95) translateY(10px);
            transition: transform 0.3s ease, background-color 0.3s ease;
            padding: 1.5rem 2rem; /* p-6 md:p-8 */
        }
        .dark .modal-content { background-color: var(--bg-secondary-dark); box-shadow: var(--shadow-lg-dark); }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-backdrop.active .modal-content { transform: scale(1) translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light); }
        .dark .modal-header { border-bottom-color: var(--border-dark); }
        .modal-title { font-size: 1.25rem; font-weight: 700; /* text-xl font-bold */ color: var(--text-primary-light); }
        .dark .modal-title { color: var(--text-primary-dark); }
        .modal-body { margin-bottom: 1.5rem; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.75rem; /* space-x-3 */ padding-top: 1.5rem; border-top: 1px solid var(--border-light); }
        .dark .modal-footer { border-top-color: var(--border-dark); }

        /* Custom Dialog (for alert/confirm) */
        #customDialog { display: none; } /* Initially hidden */
        #customDialog .modal-content { max-width: 450px; }
        #dialogMessage { margin-bottom: 1.5rem; text-align: center; font-size: 1rem; color: var(--text-secondary-light); }
        .dark #dialogMessage { color: var(--text-secondary-dark); }
        #dialogButtons { display: flex; justify-content: center; gap: 1rem; border-top: none; padding-top: 0; } /* Override footer style */

        /* Chart Container */
        #towChartContainer {
            position: relative;
            height: 380px; /* Increased height */
            width: 100%;
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--border-light);
            border-radius: 1rem;
            background-color: var(--bg-primary-light);
        }
        .dark #towChartContainer {
            border-color: var(--border-dark);
            background-color: var(--bg-primary-dark);
        }

        /* Prediction Box */
        .prediction-box {
            background: var(--brand-gradient);
            padding: 2rem;
            border-radius: 1rem; /* rounded-2xl */
            margin-top: 1.5rem;
            text-align: center;
            color: white;
            box-shadow: var(--shadow-lg-light);
            position: relative;
            overflow: hidden;
        }
         .dark .prediction-box {
             background: var(--brand-gradient-dark);
             color: var(--text-primary-light);
             box-shadow: var(--shadow-lg-dark);
         }
        .prediction-box::before { /* Subtle background pattern */
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 10px 10px;
            opacity: 0.5;
            z-index: 0;
        }
        .prediction-box > * { position: relative; z-index: 1; } /* Ensure content is above pattern */
        .prediction-value {
            font-size: 3rem; /* text-5xl */
            font-weight: 800; /* font-extrabold */
            display: block;
            margin: 0.5rem 0;
            line-height: 1;
        }
        .prediction-label {
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }
        .prediction-subtext {
            font-size: 0.75rem; /* text-xs */
            opacity: 0.7;
        }

        /* Header & Footer */
        header {
            background-color: var(--bg-secondary-light);
            box-shadow: var(--shadow-light);
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 40; /* Below modal */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            border-bottom: 1px solid var(--border-light);
        }
        .dark header {
            background-color: var(--bg-secondary-dark);
            box-shadow: var(--shadow-dark);
            border-bottom-color: var(--border-dark);
        }
        footer {
            background-color: var(--bg-primary-light);
            padding: 1.5rem;
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-secondary-light);
            border-top: 1px solid var(--border-light);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        .dark footer {
            background-color: var(--bg-primary-dark);
            color: var(--text-secondary-dark);
            border-top-color: var(--border-dark);
        }

        /* SVG Icon Styling */
        svg.icon {
            display: inline-block;
            vertical-align: middle;
            width: 1.25em; /* Default size */
            height: 1.25em;
            stroke-width: 2;
            fill: none;
            stroke: currentColor;
        }
        .btn svg.icon { width: 1.125rem; height: 1.125rem; } /* Specific size for buttons */
        .header-icon { width: 1.75rem; height: 1.75rem; } /* Larger header icon */
        .card-title-icon { width: 1.25rem; height: 1.25rem; opacity: 0.8; }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .slide-in-up { animation: slideInUp 0.5s ease-out forwards; }

        /* Apply entry animations to cards */
        .animated-card {
            opacity: 0; /* Start hidden */
            animation: slideInUp 0.5s ease-out forwards;
        }
        /* Stagger animations */
        .animated-card:nth-child(1) { animation-delay: 0.1s; }
        .animated-card:nth-child(2) { animation-delay: 0.2s; }
        .animated-card:nth-child(3) { animation-delay: 0.3s; }
        /* Add more if needed */

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { appearance: none; margin: 0; }
        input[type=number] { appearance: textfield; } /* Firefox */

        /* Responsive Adjustments */
        @media (min-width: 1024px) { /* lg breakpoint */
            .lg-grid-cols-layout {
                grid-template-columns: 1fr 2fr; /* Adjust ratio if needed */
                gap: 1.5rem; /* gap-6 */
            }
        }
    </style>
</head>
<body class="dark"> <header>
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <svg class="icon header-icon text-gradient" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 17h4V5H2v12h4"/><path d="M14 17h8v-5h-8z"/><circle cx="6" cy="17" r="2"/><circle cx="18" cy="17" r="2"/></svg>
                <span class="text-xl font-bold tracking-tight">Treadz Dashboard</span>
            </div>
            <div class="flex items-center gap-4">
                <a href="tel:423-357-4551" class="text-sm font-medium text-sky-600 dark:text-sky-400 hover:underline flex items-center gap-1.5 transition-colors">
                    <svg class="icon size-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    <span>423-357-4551</span>
                </a>
                <button id="darkModeToggle" class="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-blue-500 dark:focus-visible:ring-offset-slate-800">
                    <svg id="sunIcon" class="icon size-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                    <svg id="moonIcon" class="icon size-5 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    <span class="sr-only">Toggle dark mode</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 lg:p-8 flex-grow">

        <div class="grid grid-cols-1 lg:grid-cols-layout gap-6 mb-8">
            <div class="card animated-card">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-2 text-primary-light dark:text-primary-dark">
                    <svg class="icon card-title-icon text-sky-600 dark:text-sky-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><line x1="16" x2="12" y1="14" y2="14"/><line x1="12" x2="12" y1="14" y2="18"/><line x1="12" x2="8" y1="18" y2="18"/><line x1="8" x2="8" y1="14" y2="18"/></svg>
                    Tow Pricing Calculator
                </h2>
                <form id="towCalculatorForm" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="towType">Tow Difficulty:</label>
                            <select id="towType" name="towType" class="form-select">
                                <option value="Easy" selected>Easy (+$0)</option>
                                <option value="Medium">Medium (+$25)</option>
                                <option value="Hard">Hard (+$50)</option>
                            </select>
                        </div>
                        <div>
                            <label for="distance">Distance (miles):</label>
                            <input type="number" id="distance" name="distance" min="0" step="0.1" placeholder="e.g., 15" value="15" required class="form-input">
                        </div>
                    </div>

                    <div class="flex items-center justify-between pt-2">
                        <div>
                            <label for="overtimeCheckbox" class="mb-1">Overtime Rate ($100):</label>
                            <small class="text-xs text-secondary-light dark:text-secondary-dark block">Base Rate: $85</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="overtimeCheckbox" name="overtimeCheckbox">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="pt-2">
                        <label for="calculatedTime">Estimated Time (min):</label>
                        <output id="calculatedTime" name="calculatedTime" class="block text-lg font-semibold mt-1 text-primary-light dark:text-primary-dark">0</output>
                    </div>

                    <div class="output-section border-t border-border-light dark:border-border-dark pt-5 mt-5 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center sm:text-left">
                        <div>
                            <label class="block text-xs font-medium uppercase tracking-wider text-secondary-light dark:text-secondary-dark">Est. Revenue:</label>
                            <output id="calculatedRevenue" name="calculatedRevenue" class="block text-xl font-bold text-success-light dark:text-success-dark mt-1">$0.00</output>
                        </div>
                        <div>
                            <label class="block text-xs font-medium uppercase tracking-wider text-secondary-light dark:text-secondary-dark">Fuel Cost:</label>
                            <output id="calculatedFuelCost" name="calculatedFuelCost" class="block text-xl font-bold text-warning-light dark:text-warning-dark mt-1">$0.00</output>
                            <p class="text-xs text-secondary-light dark:text-secondary-dark">(Dist / 8) * $3.50</p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium uppercase tracking-wider text-secondary-light dark:text-secondary-dark">Est. Profit:</label>
                            <output id="calculatedProfit" name="calculatedProfit" class="block text-xl font-bold text-success-light dark:text-success-dark mt-1">$0.00</output>
                            <p class="text-xs text-secondary-light dark:text-secondary-dark">(Revenue - Fuel)</p>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card animated-card">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2 text-primary-light dark:text-primary-dark">
                        <svg class="icon card-title-icon text-sky-600 dark:text-sky-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><path d="M7 17h10"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>
                        Lot Inventory
                    </h2>
                    <div class="flex items-center w-full sm:w-auto gap-3">
                        <div class="relative flex-grow sm:flex-grow-0">
                             <svg class="icon size-4 absolute left-3.5 top-1/2 transform -translate-y-1/2 text-slate-400 dark:text-slate-500 pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            <input type="search" id="searchInput" placeholder="Search make, model, plate..." class="form-input pl-10 w-full sm:w-64 !rounded-full"> </div>
                        <button id="addCarBtn" class="btn btn-primary flex-shrink-0">
                             <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                            <span>Add Car</span>
                        </button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table id="inventoryTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Date In</th>
                                <th>Owner</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Plate</th>
                                <th>Call Type</th>
                                <th>Insurance</th>
                                <th>Lot #</th>
                                <th>Days</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTbody">
                            <tr><td colspan="10" class="text-center py-10 text-secondary-light dark:text-secondary-dark">Loading inventory...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card animated-card">
             <h2 class="text-xl font-semibold mb-6 flex items-center gap-2 text-primary-light dark:text-primary-dark">
                 <svg class="icon card-title-icon text-sky-600 dark:text-sky-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
                Tow Data & Prediction
            </h2>

             <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 space-y-8">
                    <div>
                        <h3 class="text-lg font-medium mb-4 text-primary-light dark:text-primary-dark">Add Daily Tows</h3>
                        <form id="addTowDataForm" class="space-y-4">
                            <div>
                                <label for="towDate">Date:</label>
                                <input type="date" id="towDate" name="towDate" required class="form-input">
                            </div>
                            <div>
                                <label for="towCount">Number of Tows:</label>
                                <input type="number" id="towCount" name="towCount" min="0" step="1" placeholder="e.g., 5" required class="form-input">
                            </div>
                            <div>
                                <button type="submit" class="btn btn-success w-full mt-2">
                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                                    <span>Add Tow Data</span>
                                </button>
                            </div>
                        </form>
                    </div>

                    <div>
                        <h3 class="text-lg font-medium mb-4 text-primary-light dark:text-primary-dark">Recent Tow Data</h3>
                        <div class="table-wrapper max-h-96 overflow-y-auto"> <table id="towDataTable" class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Tows</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="towDataTbody">
                                    <tr><td colspan="3" class="text-center py-10 text-secondary-light dark:text-secondary-dark">Loading tow data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="md:col-span-2 space-y-8">
                    <div>
                        <h3 class="text-lg font-medium mb-4 text-primary-light dark:text-primary-dark">Monthly Tow Totals</h3>
                        <div id="towChartContainer">
                            <canvas id="towChart"></canvas>
                        </div>
                    </div>

                    <div class="prediction-box">
                        <h3 class="prediction-label">Predicted Tows</h3>
                        <p class="prediction-subtext mb-2">(Next Month)</p>
                        <output id="predictedTows" class="prediction-value">...</output>
                        <p class="prediction-subtext mt-1">(Based on avg. last 3 months)</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer>
        <p>
            © <span id="currentYear"></span> All Rights Reserved | Treadz Tire & Towing | 409 Main Street Mount Carmel, TN | treadztnt@gmail.com
        </p>
    </footer>

    <div id="addCarModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add New Car to Inventory</h3>
                <button id="closeModalBtn" class="p-2 rounded-full text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 dark:text-slate-500 transition-colors">
                    <svg class="icon size-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            <form id="addCarForm">
                <div class="modal-body space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="dateIn">Date In:</label>
                            <input type="date" id="dateIn" name="dateIn" required class="form-input">
                        </div>
                        <div>
                            <label for="ownerName">Owner Name:</label>
                            <input type="text" id="ownerName" name="ownerName" required placeholder="e.g., John Doe" class="form-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="make">Make:</label>
                            <input type="text" id="make" name="make" required placeholder="e.g., Toyota" class="form-input">
                        </div>
                        <div>
                            <label for="model">Model:</label>
                            <input type="text" id="model" name="model" required placeholder="e.g., Camry" class="form-input">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                            <label for="plateNumber">Plate Number:</label>
                            <input type="text" id="plateNumber" name="plateNumber" required placeholder="e.g., ABC-123" class="form-input">
                        </div>
                        <div>
                            <label for="callType">Call Type:</label>
                            <select id="callType" name="callType" required class="form-select">
                                <option value="" disabled selected>Select type...</option>
                                <option value="CHP">CHP</option>
                                <option value="KPD">KPD</option>
                                <option value="THP">THP</option>
                                <option value="OWNER REQ">OWNER REQ</option>
                                <option value="OTHER">OTHER</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                        <div>
                            <label class="block mb-2">Insurance:</label>
                            <div class="flex space-x-6">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="insurance" value="Yes" required class="form-radio h-4 w-4 text-sky-600 border-slate-300 dark:border-slate-600 focus:ring-sky-500"> Yes
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="insurance" value="No" required class="form-radio h-4 w-4 text-sky-600 border-slate-300 dark:border-slate-600 focus:ring-sky-500"> No
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block mb-2">Lot Number:</label>
                             <div class="flex space-x-6">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="lotNumber" value="1" required class="form-radio h-4 w-4 text-sky-600 border-slate-300 dark:border-slate-600 focus:ring-sky-500"> Lot 1
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="lotNumber" value="2" required class="form-radio h-4 w-4 text-sky-600 border-slate-300 dark:border-slate-600 focus:ring-sky-500"> Lot 2
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancelModalBtn" type="button" class="btn btn-secondary">Cancel</button>
                    <button id="saveCarBtn" type="submit" class="btn btn-primary">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        <span>Save Car</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="customDialog" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-body">
                <p id="dialogMessage"></p>
            </div>
            <div id="dialogButtons" class="modal-footer">
                </div>
        </div>
    </div>


    <script>
        // --- Global Variables & Constants ---
        const INVENTORY_STORAGE_KEY = 'treadzInventory_v3'; // Updated key
        const TOW_DATA_STORAGE_KEY = 'treadzTowData_v3'; // Updated key
        const FUEL_MPG = 8;
        const FUEL_PRICE_PER_GALLON = 3.50;
        const BASE_RATE = 85;
        const OVERTIME_RATE = 100;
        const AVG_SPEED_MPH = 41.25; // Including pickup/dropoff buffer

        let inventory = []; // Global inventory array
        let towData = []; // Global tow data array
        let towChartInstance = null; // To hold the Chart.js instance
        let isDarkMode = false; // Will be set by JS

        // --- DOM Element References ---
        // Calculator
        const towTypeSelect = document.getElementById('towType');
        const overtimeCheckbox = document.getElementById('overtimeCheckbox');
        const distanceInput = document.getElementById('distance');
        const calculatedTimeOutput = document.getElementById('calculatedTime');
        const calculatedRevenueOutput = document.getElementById('calculatedRevenue');
        const calculatedFuelCostOutput = document.getElementById('calculatedFuelCost');
        const calculatedProfitOutput = document.getElementById('calculatedProfit');
        const calculatorForm = document.getElementById('towCalculatorForm');
        // Inventory
        const addCarBtn = document.getElementById('addCarBtn');
        const addCarModal = document.getElementById('addCarModal');
        const addCarForm = document.getElementById('addCarForm');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const inventoryTbody = document.getElementById('inventoryTbody');
        const searchInput = document.getElementById('searchInput');
        // Tow Data & Prediction
        const addTowDataForm = document.getElementById('addTowDataForm');
        const towDateInput = document.getElementById('towDate');
        const towCountInput = document.getElementById('towCount');
        const towDataTbody = document.getElementById('towDataTbody');
        const towChartCanvas = document.getElementById('towChart');
        const predictedTowsOutput = document.getElementById('predictedTows');
        // Other UI
        const currentYearSpan = document.getElementById('currentYear');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        // Custom Dialog
        const customDialog = document.getElementById('customDialog');
        const dialogMessage = document.getElementById('dialogMessage');
        const dialogButtons = document.getElementById('dialogButtons');


        // --- Utility Functions ---

        /**
         * Shows a custom dialog box (modal).
         * @param {string} message - The message to display.
         * @param {Function} [confirmCallback] - Function to call if confirmed (shows Confirm/Cancel). If null, shows only an OK button.
         * @param {string} [confirmButtonClass='btn-primary'] - Class for the confirmation/OK button.
         */
        function showDialog(message, confirmCallback = null, confirmButtonClass = 'btn-primary') {
            dialogMessage.textContent = message;
            dialogButtons.innerHTML = ''; // Clear previous buttons

            if (confirmCallback) {
                // Confirmation dialog (Confirm/Cancel)
                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'btn btn-secondary';
                cancelButton.onclick = hideDialog;

                const confirmButton = document.createElement('button');
                confirmButton.textContent = 'Confirm';
                confirmButton.className = `btn ${confirmButtonClass}`; // Use specified class
                confirmButton.onclick = () => {
                    hideDialog();
                    confirmCallback();
                };

                dialogButtons.appendChild(cancelButton);
                dialogButtons.appendChild(confirmButton);
            } else {
                // Alert dialog (OK)
                const okButton = document.createElement('button');
                okButton.textContent = 'OK';
                okButton.className = `btn ${confirmButtonClass}`;
                okButton.onclick = hideDialog;
                dialogButtons.appendChild(okButton);
            }

            customDialog.style.display = 'flex';
            // Delay adding class slightly to ensure transition works
            requestAnimationFrame(() => {
                customDialog.classList.add('active');
            });
        }

        /** Hides the custom dialog box. */
        function hideDialog() {
            customDialog.classList.remove('active');
            // Wait for animation to finish before hiding
             setTimeout(() => {
                 // Check if still active before hiding, prevents issues if opened again quickly
                 if (!customDialog.classList.contains('active')) {
                     customDialog.style.display = 'none';
                 }
             }, 300); // Match animation duration
        }

        /**
         * Formats a date string (YYYY-MM-DD) or Date object for display (e.g., MM/DD/YYYY).
         * Handles potential invalid dates gracefully.
         * @param {string|Date} dateInput - The date string or object.
         * @returns {string} Formatted date or 'N/A'.
         */
        function formatDisplayDate(dateInput) {
            try {
                if (!dateInput) return 'N/A';
                // Add time component to ensure correct date interpretation regardless of local timezone
                const date = new Date(dateInput + 'T00:00:00');
                if (!isNaN(date.getTime())) {
                    // Use UTC methods to avoid timezone shifts during formatting
                    const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const day = String(date.getUTCDate()).padStart(2, '0');
                    const year = date.getUTCFullYear();
                    return `${month}/${day}/${year}`;
                }
            } catch (e) {
                console.error("Error formatting date:", dateInput, e);
            }
            return 'N/A';
        }

        /**
         * Calculates the difference in days between two dates (YYYY-MM-DD format).
         * @param {string} dateStr1 - Start date string.
         * @param {string} dateStr2 - End date string (usually today).
         * @returns {number|NaN} Difference in days or NaN if invalid.
         */
        function daysDifference(dateStr1, dateStr2) {
            try {
                if (!dateStr1 || !dateStr2 || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr1) || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr2)) { return NaN; }
                // Use UTC to avoid timezone issues in calculation
                const date1 = new Date(dateStr1 + 'T00:00:00Z');
                const date2 = new Date(dateStr2 + 'T00:00:00Z');
                if (isNaN(date1.getTime()) || isNaN(date2.getTime())) { return NaN; }
                const differenceInTime = date2.getTime() - date1.getTime();
                return Math.floor(differenceInTime / (1000 * 3600 * 24));
            } catch (error) {
                console.error("Error calculating days difference:", error);
                return NaN;
            }
        }

        // --- Dark Mode ---
        function setDarkMode(isDark) {
            isDarkMode = isDark;
            document.documentElement.classList.toggle('dark', isDarkMode);
            localStorage.setItem('treadzDarkMode', isDarkMode);
            // Toggle icons visibility
            sunIcon.classList.toggle('hidden', isDarkMode);
            moonIcon.classList.toggle('hidden', !isDarkMode);
            // Update chart if it exists
            if (towChartInstance) {
                updateChartAppearance();
                towChartInstance.update('none'); // Update without animation
            }
        }

        function toggleDarkMode() {
            setDarkMode(!isDarkMode);
        }

        function applyInitialDarkMode() {
            // Check local storage first, then system preference
            const storedMode = localStorage.getItem('treadzDarkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            setDarkMode(storedMode === 'true' || (storedMode === null && prefersDark));
        }

      // --- Calculator Logic ---
      /**
       * Calculates tow price, time, fuel cost, and profit based on form inputs.
       * Updates the output fields on the page.
       */
      function calculateAndDisplayPrice() {
          // Get raw values
          const distanceStr = distanceInput.value;
          const towTypeValue = towTypeSelect.value;
          const isOvertime = overtimeCheckbox.checked;

          // Validate distance
          const distance = parseFloat(distanceStr);
          if (isNaN(distance) || distance < 0) {
              // Optionally show an error or reset outputs
              calculatedTimeOutput.textContent = 'N/A';
              calculatedRevenueOutput.textContent = '$0.00';
              calculatedFuelCostOutput.textContent = '$0.00';
              calculatedProfitOutput.textContent = '$0.00';
              // Add visual feedback for invalid distance if needed
              distanceInput.classList.add('border-red-500', 'dark:border-red-400');
              distanceInput.classList.remove('border-border-light', 'dark:border-border-dark');
              return; // Stop calculation if distance is invalid
          } else {
               // Remove error styling if valid
               distanceInput.classList.remove('border-red-500', 'dark:border-red-400');
               distanceInput.classList.add('border-border-light', 'dark:border-border-dark');
          }


          // Determine difficulty cost
          let difficultyCost = 0;
          if (towTypeValue === 'Medium') {
              difficultyCost = 25;
          } else if (towTypeValue === 'Hard') {
              difficultyCost = 50;
          }

          // Calculate base price (hook fee)
          const basePrice = isOvertime ? OVERTIME_RATE : BASE_RATE;

          // Calculate distance cost ($4 per mile)
          const distanceCost = distance * 4;

          // Calculate total revenue
          const totalRevenue = basePrice + difficultyCost + distanceCost;

          // Calculate estimated time (in minutes)
          // Time = (Distance / Speed) * 60 minutes/hour + buffer for hookup/dropoff
          const travelTimeMinutes = distance > 0 ? (distance / AVG_SPEED_MPH) * 60 : 0;
          const baseTimeMinutes = 20; // Base time for hookup/paperwork etc.
          const estimatedTime = Math.round(baseTimeMinutes + travelTimeMinutes);

          // Calculate fuel cost
          const fuelCost = distance > 0 ? (distance / FUEL_MPG) * FUEL_PRICE_PER_GALLON : 0;

          // Calculate estimated profit
          const estimatedProfit = totalRevenue - fuelCost;

          // Update output fields
          calculatedTimeOutput.textContent = `${estimatedTime} min`;
          calculatedRevenueOutput.textContent = `$${totalRevenue.toFixed(2)}`;
          calculatedFuelCostOutput.textContent = `$${fuelCost.toFixed(2)}`;
          calculatedProfitOutput.textContent = `$${estimatedProfit.toFixed(2)}`;
      }

      // --- Inventory Management ---

      /** Loads inventory data from local storage. */
      function loadInventory() {
          const storedInventory = localStorage.getItem(INVENTORY_STORAGE_KEY);
          inventory = storedInventory ? JSON.parse(storedInventory) : [];
          // Sort inventory by dateIn descending (newest first) by default
          inventory.sort((a, b) => new Date(b.dateIn) - new Date(a.dateIn));
      }

      /** Saves the current inventory data to local storage. */
      function saveInventory() {
          localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(inventory));
      }

      /**
       * Renders the inventory table based on the provided data array.
       * @param {Array} dataToRender - The array of inventory items to display.
       */
      function renderInventoryTable(dataToRender = inventory) {
          inventoryTbody.innerHTML = ''; // Clear existing rows

          if (dataToRender.length === 0) {
              inventoryTbody.innerHTML = `<tr><td colspan="10" class="text-center py-10 text-secondary-light dark:text-secondary-dark">No cars found matching your criteria.</td></tr>`;
              return;
          }

          const todayStr = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD

          dataToRender.forEach((car, index) => {
              const row = inventoryTbody.insertRow();
              row.dataset.id = car.id; // Store unique ID on the row

              const daysOnLot = daysDifference(car.dateIn, todayStr);
              const daysDisplay = isNaN(daysOnLot) ? 'N/A' : daysOnLot;

              // Apply highlighting based on days on lot
              row.classList.remove('highlight-yellow', 'highlight-red'); // Clear previous highlights
              if (!isNaN(daysOnLot)) {
                  if (daysOnLot >= 60) {
                      row.classList.add('highlight-red');
                  } else if (daysOnLot >= 30) {
                      row.classList.add('highlight-yellow');
                  }
              }

              row.innerHTML = `
                  <td>${formatDisplayDate(car.dateIn)}</td>
                  <td>${car.ownerName || 'N/A'}</td>
                  <td>${car.make || 'N/A'}</td>
                  <td>${car.model || 'N/A'}</td>
                  <td>${car.plateNumber || 'N/A'}</td>
                  <td>${car.callType || 'N/A'}</td>
                  <td>${car.insurance || 'N/A'}</td>
                  <td>${car.lotNumber || 'N/A'}</td>
                  <td class="font-medium ${daysOnLot >= 60 ? 'text-danger-light dark:text-danger-dark' : (daysOnLot >= 30 ? 'text-warning-light dark:text-warning-dark' : '')}">${daysDisplay}</td>
                  <td>
                      <div class="flex gap-2">
                          <button class="btn btn-secondary btn-icon edit-car-btn" title="Edit Car">
                              <svg class="icon size-4" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                          </button>
                          <button class="btn btn-danger btn-icon delete-car-btn" title="Delete Car">
                              <svg class="icon size-4" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                          </button>
                      </div>
                  </td>
              `;

              // Add event listeners directly to the buttons in this row
              row.querySelector('.edit-car-btn').addEventListener('click', () => openEditCarModal(car.id));
              row.querySelector('.delete-car-btn').addEventListener('click', () => confirmDeleteCar(car.id));
          });
      }

      /** Opens the modal to add a new car. */
      function openAddCarModal() {
          addCarForm.reset(); // Clear the form
          // Set default date to today
          document.getElementById('dateIn').value = new Date().toISOString().split('T')[0];
          addCarForm.dataset.mode = 'add'; // Set mode to 'add'
          addCarForm.dataset.editId = ''; // Clear any edit ID
          document.querySelector('#addCarModal .modal-title').textContent = 'Add New Car to Inventory';
          document.getElementById('saveCarBtn').innerHTML = `
              <svg class="icon" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
              <span>Add Car</span>`; // Change button text/icon
          addCarModal.style.display = 'flex';
          requestAnimationFrame(() => { addCarModal.classList.add('active'); });
      }

      /**
       * Opens the modal to edit an existing car, pre-filling the form.
       * @param {string} carId - The ID of the car to edit.
       */
      function openEditCarModal(carId) {
          const carToEdit = inventory.find(car => car.id === carId);
          if (!carToEdit) {
              showDialog('Error: Car not found.', null, 'btn-danger');
              return;
          }

          addCarForm.reset(); // Clear previous state
          addCarForm.dataset.mode = 'edit'; // Set mode to 'edit'
          addCarForm.dataset.editId = carId; // Store the ID of the car being edited

          // Populate form fields
          document.getElementById('dateIn').value = carToEdit.dateIn || '';
          document.getElementById('ownerName').value = carToEdit.ownerName || '';
          document.getElementById('make').value = carToEdit.make || '';
          document.getElementById('model').value = carToEdit.model || '';
          document.getElementById('plateNumber').value = carToEdit.plateNumber || '';
          document.getElementById('callType').value = carToEdit.callType || '';

          // Set radio buttons
          const insuranceRadio = document.querySelector(`input[name="insurance"][value="${carToEdit.insurance}"]`);
          if (insuranceRadio) insuranceRadio.checked = true;
          const lotNumberRadio = document.querySelector(`input[name="lotNumber"][value="${carToEdit.lotNumber}"]`);
          if (lotNumberRadio) lotNumberRadio.checked = true;

          // Update modal title and button
          document.querySelector('#addCarModal .modal-title').textContent = 'Edit Car Details';
           document.getElementById('saveCarBtn').innerHTML = `
              <svg class="icon" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              <span>Save Changes</span>`;

          addCarModal.style.display = 'flex';
          requestAnimationFrame(() => { addCarModal.classList.add('active'); });
      }


      /** Closes the Add/Edit Car modal. */
      function closeAddCarModal() {
          addCarModal.classList.remove('active');
           setTimeout(() => {
                // Check if still active before hiding
                if (!addCarModal.classList.contains('active')) {
                    addCarModal.style.display = 'none';
                    addCarForm.reset(); // Reset form on close
                }
            }, 300); // Match animation duration
      }

      /** Handles the submission of the Add/Edit Car form. */
      function handleAddCarSubmit(event) {
          event.preventDefault();
          const formData = new FormData(addCarForm);
          const mode = addCarForm.dataset.mode;
          const editId = addCarForm.dataset.editId;

          const carData = {
              dateIn: formData.get('dateIn'),
              ownerName: formData.get('ownerName').trim(),
              make: formData.get('make').trim(),
              model: formData.get('model').trim(),
              plateNumber: formData.get('plateNumber').trim().toUpperCase(), // Standardize plate
              callType: formData.get('callType'),
              insurance: formData.get('insurance'),
              lotNumber: formData.get('lotNumber'),
          };

          // Basic validation (more can be added)
          if (!carData.dateIn || !carData.ownerName || !carData.make || !carData.model || !carData.plateNumber || !carData.callType || !carData.insurance || !carData.lotNumber) {
              showDialog('Please fill in all required fields.', null, 'btn-warning');
              return;
          }

          if (mode === 'add') {
              // Add new car
              carData.id = `car_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; // Simple unique ID
              inventory.unshift(carData); // Add to the beginning of the array
          } else if (mode === 'edit' && editId) {
              // Update existing car
              const carIndex = inventory.findIndex(car => car.id === editId);
              if (carIndex !== -1) {
                  inventory[carIndex] = { ...inventory[carIndex], ...carData }; // Merge data, keeping original ID
              } else {
                  closeAddCarModal();
                  return; // Exit early
              }
          }

          saveInventory();
          renderInventoryTable(); // Re-render the table with the latest data
          closeAddCarModal();
      }

      /**
       * Shows a confirmation dialog before deleting a car.
       * @param {string} carId - The ID of the car to delete.
       */
      function confirmDeleteCar(carId) {
          const carToDelete = inventory.find(car => car.id === carId);
          if (!carToDelete) return; // Should not happen

          const message = `Are you sure you want to delete the ${carToDelete.make} ${carToDelete.model} (Plate: ${carToDelete.plateNumber})? This action cannot be undone.`;

          showDialog(message, () => {
              // This function is the confirmCallback
              inventory = inventory.filter(car => car.id !== carId);
              saveInventory();
              renderInventoryTable(); // Re-render after deletion
              showDialog('Car deleted successfully.', null, 'btn-success');
          }, 'btn-danger'); // Use red button for confirmation
      }

      /** Filters the inventory table based on the search input value. */
      function filterInventory() {
          const searchTerm = searchInput.value.toLowerCase().trim();
          if (!searchTerm) {
              renderInventoryTable(inventory); // Show all if search is empty
              return;
          }

          const filteredInventory = inventory.filter(car => {
              return (
                  car.make?.toLowerCase().includes(searchTerm) ||
                  car.model?.toLowerCase().includes(searchTerm) ||
                  car.ownerName?.toLowerCase().includes(searchTerm) ||
                  car.plateNumber?.toLowerCase().includes(searchTerm) ||
                  car.callType?.toLowerCase().includes(searchTerm) ||
                  car.lotNumber?.toString().includes(searchTerm) || // Allow searching by lot number
                  formatDisplayDate(car.dateIn)?.includes(searchTerm) // Allow searching by formatted date
              );
          });

          renderInventoryTable(filteredInventory);
      }


      // --- Tow Data & Prediction Logic ---

      /** Loads tow data from local storage. */
      function loadTowData() {
          const storedTowData = localStorage.getItem(TOW_DATA_STORAGE_KEY);
          towData = storedTowData ? JSON.parse(storedTowData) : [];
          // Ensure tow counts are numbers and sort by date descending
          towData = towData.map(item => ({ ...item, count: parseInt(item.count, 10) || 0 }))
                           .sort((a, b) => new Date(b.date) - new Date(a.date));
      }

      /** Saves the current tow data to local storage. */
      function saveTowData() {
          localStorage.setItem(TOW_DATA_STORAGE_KEY, JSON.stringify(towData));
      }

      /** Renders the tow data table. */
      function renderTowDataTable() {
          towDataTbody.innerHTML = ''; // Clear existing rows

          if (towData.length === 0) {
              towDataTbody.innerHTML = `<tr><td colspan="3" class="text-center py-10 text-secondary-light dark:text-secondary-dark">No tow data recorded yet.</td></tr>`;
              return;
          }

          // Display only the most recent entries (e.g., last 10 or 15) for brevity
          const recentTowData = towData.slice(0, 15);

          recentTowData.forEach(item => {
              const row = towDataTbody.insertRow();
              row.dataset.date = item.date; // Store date on the row

              row.innerHTML = `
                  <td>${formatDisplayDate(item.date)}</td>
                  <td class="text-center">${item.count}</td>
                  <td>
                      <button class="btn btn-danger btn-icon delete-tow-btn" title="Delete Tow Data Entry">
                         <svg class="icon size-4" xmlns="[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                      </button>
                  </td>
              `;

              // Add event listener for delete button
              row.querySelector('.delete-tow-btn').addEventListener('click', () => confirmDeleteTowData(item.date));
          });
      }

      /** Handles the submission of the Add Tow Data form. */
      function handleAddTowDataSubmit(event) {
          event.preventDefault();
          const date = towDateInput.value;
          const countStr = towCountInput.value;
          const count = parseInt(countStr, 10);

          if (!date || isNaN(count) || count < 0) {
              showDialog('Please enter a valid date and a non-negative number of tows.', null, 'btn-warning');
              return;
          }

          // Check if data for this date already exists
          const existingIndex = towData.findIndex(item => item.date === date);
          if (existingIndex !== -1) {
              // Ask user if they want to overwrite
              showDialog(`Data for ${formatDisplayDate(date)} already exists (${towData[existingIndex].count} tows). Overwrite with ${count} tows?`, () => {
                  towData[existingIndex].count = count; // Update existing entry
                  finishTowDataUpdate();
              }, 'btn-warning');
          } else {
              // Add new data
              towData.push({ date, count });
              finishTowDataUpdate();
          }
      }

      /** Completes the tow data update process after adding or confirming overwrite. */
      function finishTowDataUpdate() {
            towData.sort((a, b) => new Date(b.date) - new Date(a.date)); // Re-sort after adding/updating
            saveTowData();
            renderTowDataTable();
            updateTowChartAndPrediction(); // Update chart and prediction
            addTowDataForm.reset(); // Clear the form
            // Set date input back to today for convenience
            towDateInput.value = new Date().toISOString().split('T')[0];
      }


      /**
       * Shows a confirmation dialog before deleting a tow data entry.
       * @param {string} date - The date of the entry to delete.
       */
      function confirmDeleteTowData(date) {
          const message = `Are you sure you want to delete the tow data for ${formatDisplayDate(date)}? This action cannot be undone.`;

          showDialog(message, () => {
              towData = towData.filter(item => item.date !== date);
              saveTowData();
              renderTowDataTable();
              updateTowChartAndPrediction(); // Update chart and prediction
          }, 'btn-danger');
      }

      /** Processes tow data to get monthly totals for the chart. */
      function getMonthlyTowTotals() {
          const monthlyTotals = {}; // e.g., { '2024-01': 150, '2024-02': 180 }
          const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

          towData.forEach(item => {
              try {
                  const dateObj = new Date(item.date + 'T00:00:00'); // Ensure correct date parsing
                  if (isNaN(dateObj.getTime())) return; // Skip invalid dates

                  const year = dateObj.getUTCFullYear();
                  const month = dateObj.getUTCMonth(); // 0-indexed
                  const key = `${year}-${String(month + 1).padStart(2, '0')}`; // YYYY-MM key

                  if (!monthlyTotals[key]) {
                      monthlyTotals[key] = { total: 0, label: `${monthNames[month]} ${year}` };
                  }
                  monthlyTotals[key].total += item.count;
              } catch (e) {
                  console.error("Error processing date for chart:", item.date, e);
              }
          });

          // Sort keys chronologically and get the last 12 months
          const sortedKeys = Object.keys(monthlyTotals).sort();
          const last12Keys = sortedKeys.slice(-12);

          const labels = last12Keys.map(key => monthlyTotals[key].label);
          const data = last12Keys.map(key => monthlyTotals[key].total);

          return { labels, data, monthlyTotals, last12Keys };
      }

      /** Updates the Chart.js appearance based on dark/light mode. */
       function updateChartAppearance() {
            if (!towChartInstance) return;

            const isDark = document.documentElement.classList.contains('dark');
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const labelColor = isDark ? '#cbd5e1' : '#475569'; // slate-300 / slate-600
            const titleColor = isDark ? '#f1f5f9' : '#1e293b'; // slate-100 / slate-800

            towChartInstance.options.scales.x.grid.color = gridColor;
            towChartInstance.options.scales.y.grid.color = gridColor;
            towChartInstance.options.scales.x.ticks.color = labelColor;
            towChartInstance.options.scales.y.ticks.color = labelColor;
            towChartInstance.options.plugins.legend.labels.color = labelColor;
            towChartInstance.options.plugins.title.color = titleColor;
       }


      /** Creates or updates the tow data chart and prediction. */
      function updateTowChartAndPrediction() {
          const { labels, data, monthlyTotals, last12Keys } = getMonthlyTowTotals();

          // --- Chart Update ---
          const ctx = towChartCanvas.getContext('2d');
          const isDark = document.documentElement.classList.contains('dark');
          const gradientBg = ctx.createLinearGradient(0, 0, 0, 300);
          gradientBg.addColorStop(0, isDark ? 'rgba(96, 165, 250, 0.6)' : 'rgba(59, 130, 246, 0.7)'); // blue-400 / blue-500
          gradientBg.addColorStop(1, isDark ? 'rgba(56, 189, 248, 0.3)' : 'rgba(14, 165, 233, 0.4)'); // sky-400 / sky-500

          const borderGradient = ctx.createLinearGradient(0, 0, 0, 300);
          borderGradient.addColorStop(0, isDark ? '#60a5fa' : '#3b82f6'); // blue-400 / blue-500
          borderGradient.addColorStop(1, isDark ? '#38bdf8' : '#0ea5e9'); // sky-400 / sky-500


          const chartConfig = {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'Total Tows',
                      data: data,
                      backgroundColor: gradientBg,
                      borderColor: borderGradient,
                      borderWidth: 2,
                      borderRadius: 8, // Rounded bars
                      hoverBackgroundColor: isDark ? 'rgba(96, 165, 250, 0.8)' : 'rgba(59, 130, 246, 0.9)',
                      hoverBorderColor: isDark ? '#60a5fa' : '#3b82f6',
                      tension: 0.1 // Slight curve if type was 'line'
                  }]
              },
              options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                      legend: {
                          display: false // Keep it clean, title is enough
                      },
                      title: {
                          display: true,
                          text: 'Monthly Tow Totals (Last 12 Months)',
                          padding: { top: 10, bottom: 20 },
                          font: { size: 16, weight: '600', family: 'Inter' }
                      },
                      tooltip: {
                          backgroundColor: isDark ? '#1e293b' : '#ffffff', // slate-800 / white
                          titleColor: isDark ? '#f1f5f9' : '#1e293b', // slate-100 / slate-800
                          bodyColor: isDark ? '#cbd5e1' : '#475569', // slate-300 / slate-600
                          borderColor: isDark ? '#334155' : '#e2e8f0', // slate-700 / slate-200
                          borderWidth: 1,
                          padding: 10,
                          cornerRadius: 8,
                          usePointStyle: true,
                           callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y + ' tows';
                                    }
                                    return label;
                                }
                            }
                      }
                  },
                  scales: {
                      x: {
                          grid: { display: false }, // Hide vertical grid lines
                          ticks: { font: { size: 11, family: 'Inter' } }
                      },
                      y: {
                          beginAtZero: true,
                          grid: { drawBorder: false }, // Hide y-axis line, keep grid
                          ticks: {
                              font: { size: 11, family: 'Inter' },
                              padding: 10,
                               // Add ' tows' suffix
                               callback: function(value) {
                                   if (Number.isInteger(value)) {
                                      return value + ' '; // Add space for alignment
                                   }
                               }
                          }
                      }
                  },
                  animation: {
                      duration: 500, // Smooth animation
                      easing: 'easeOutQuad'
                  }
              }
          };

          if (towChartInstance) {
              // Update existing chart
              towChartInstance.data.labels = labels;
              towChartInstance.data.datasets[0].data = data;
              towChartInstance.data.datasets[0].backgroundColor = gradientBg;
              towChartInstance.data.datasets[0].borderColor = borderGradient;
              updateChartAppearance(); // Apply dark/light mode styles
              towChartInstance.update();
          } else {
              // Create new chart
              towChartInstance = new Chart(ctx, chartConfig);
              updateChartAppearance(); // Apply initial dark/light mode styles
          }

          // --- Prediction Update ---
          let predictedTows = 0;
          const last3Keys = last12Keys.slice(-3); // Get keys for the last 3 available months

          if (last3Keys.length > 0) {
              const last3Totals = last3Keys.map(key => monthlyTotals[key].total);
              const sumLast3 = last3Totals.reduce((sum, current) => sum + current, 0);
              predictedTows = Math.round(sumLast3 / last3Keys.length);
          } else if (data.length > 0) {
              // Fallback: average of all available data if less than 3 months exist
              const sumAll = data.reduce((sum, current) => sum + current, 0);
              predictedTows = Math.round(sumAll / data.length);
          }

          predictedTowsOutput.textContent = isNaN(predictedTows) ? 'N/A' : predictedTows;
          // Add subtle animation to prediction box value
          predictedTowsOutput.classList.remove('fade-in');
          void predictedTowsOutput.offsetWidth; // Trigger reflow
          predictedTowsOutput.classList.add('fade-in');

      }

      // --- Event Listeners ---
      function setupEventListeners() {
          // Calculator listeners
          calculatorForm.addEventListener('input', calculateAndDisplayPrice); // Recalculate on any input change

          // Inventory listeners
          addCarBtn.addEventListener('click', openAddCarModal);
          closeModalBtn.addEventListener('click', closeAddCarModal);
          cancelModalBtn.addEventListener('click', closeAddCarModal);
          addCarForm.addEventListener('submit', handleAddCarSubmit);
          searchInput.addEventListener('input', filterInventory);
           // Close modal if backdrop is clicked
           addCarModal.addEventListener('click', (event) => {
               if (event.target === addCarModal) { // Check if the click is directly on the backdrop
                   closeAddCarModal();
               }
           });
            // Close custom dialog if backdrop is clicked
            customDialog.addEventListener('click', (event) => {
               if (event.target === customDialog) {
                   hideDialog();
               }
           });

          // Tow Data listeners
          addTowDataForm.addEventListener('submit', handleAddTowDataSubmit);

          // Dark Mode listener
          darkModeToggle.addEventListener('click', toggleDarkMode);
           // Listen for system preference changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                // Only change if user hasn't manually overridden via toggle
                if (localStorage.getItem('treadzDarkMode') === null) {
                    setDarkMode(event.matches);
                }
            });

            // Prevent form submission from refreshing page (should be handled by JS)
            const allForms = document.querySelectorAll('form');
            allForms.forEach(form => {
                form.addEventListener('submit', e => {
                    // Allow specific forms if needed in future, but prevent default for now
                    // if (form.id !== 'someOtherForm') {
                    //     e.preventDefault();
                    // }
                });
            });
      }

      // --- Initialization ---
      document.addEventListener('DOMContentLoaded', () => {
          // Set current year in footer
          currentYearSpan.textContent = new Date().getFullYear();

          // Apply dark mode preference
          applyInitialDarkMode();

          // Set default date for tow data input to today
          towDateInput.value = new Date().toISOString().split('T')[0];

          // Load data
          loadInventory();
          loadTowData();

          // Initial rendering and calculations
          renderInventoryTable();
          renderTowDataTable();
          calculateAndDisplayPrice(); // Initial calculation for default values
          updateTowChartAndPrediction(); // Initial chart & prediction

          // Setup all event listeners
          setupEventListeners();

          console.log("Treadz Dashboard Initialized");
      });

    </script>
</body>
</html>
