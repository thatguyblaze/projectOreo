<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treadz Pricing Calculator, Inventory & Prediction - Staff Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        // Tailwind CSS Configuration
        tailwind.config = {
            darkMode: 'class', // Enable dark mode based on class
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'], // Set default font
                    },
                    colors: {
                        // Define custom colors (can be adjusted further)
                        'primary': {
                            light: '#4f46e5', // indigo-600
                            DEFAULT: '#4f46e5',
                            dark: '#6366f1'  // indigo-500
                        },
                        'secondary': {
                            light: '#10b981', // emerald-500
                            DEFAULT: '#10b981',
                            dark: '#34d399'  // emerald-400
                        },
                        'muted': {
                            light: '#6b7280', // gray-500
                            DEFAULT: '#6b7280',
                            dark: '#9ca3af'  // gray-400
                        },
                        'destructive': {
                            light: '#ef4444', // red-500
                            DEFAULT: '#ef4444',
                            dark: '#f87171'  // red-400
                        },
                        'background': {
                            light: '#f9fafb', // gray-50
                            DEFAULT: '#f9fafb',
                            dark: '#111827'  // gray-900
                        },
                        'foreground': {
                            light: '#1f2937', // gray-800
                            DEFAULT: '#1f2937',
                            dark: '#f3f4f6'  // gray-100
                        },
                        'card': {
                            light: '#ffffff', // white
                            DEFAULT: '#ffffff',
                            dark: '#1f2937'  // gray-800
                        },
                        'border': {
                            light: '#e5e7eb', // gray-200
                            DEFAULT: '#e5e7eb',
                            dark: '#374151'  // gray-700
                        },
                        'input': {
                            light: '#e5e7eb', // gray-200
                            DEFAULT: '#e5e7eb',
                            dark: '#374151'  // gray-700
                        },
                        'highlight-yellow': {
                            light: '#fef9c3', // yellow-100
                            DEFAULT: '#fef9c3',
                            dark: '#78350f'   // amber-900 (kept original dark highlight)
                        },
                        'highlight-red': {
                            light: '#fee2e2', // red-100
                            DEFAULT: '#fee2e2',
                            dark: '#7f1d1d'   // red-900 (kept original dark highlight)
                        },
                        'prediction-blue': {
                           light: '#eff6ff', // blue-50
                           DEFAULT: '#eff6ff',
                           dark: '#1e3a8a' // blue-900 (kept original dark)
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: theme('colors.background.dark');
            color: theme('colors.foreground.dark');
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .dark body {
            background-color: theme('colors.background.dark');
            color: theme('colors.foreground.dark');
        }
        main { flex-grow: 1; }

        /* Custom Card Styling */
        .card {
            background-color: theme('colors.card.dark');
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid theme('colors.border.dark');
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03); /* subtle shadow */
            padding: 1.5rem; /* p-6 */
        }
        .dark .card {
            background-color: theme('colors.card.dark');
            border-color: theme('colors.border.dark');
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); /* slightly stronger shadow for dark */
        }

        /* Form Element Styling */
        label {
             display: block;
             margin-bottom: 0.375rem; /* mb-1.5 */
             font-size: 0.875rem; /* text-sm */
             font-weight: 500; /* font-medium */
             color: theme('colors.foreground.dark');
        }
        .dark label {
             color: theme('colors.foreground.dark');
        }
        .input, select, output.input-style {
            display: block;
            width: 100%;
            padding: 0.625rem 0.75rem; /* py-2.5 px-3 */
            font-size: 0.875rem; /* text-sm */
            border: 1px solid theme('colors.input.dark');
            background-color: theme('colors.card.dark');
            color: theme('colors.foreground.dark');
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .dark .input, .dark select, .dark output.input-style {
            border-color: theme('colors.input.dark');
            background-color: theme('colors.gray.700'); /* Slightly different bg for inputs */
            color: theme('colors.foreground.dark');
             box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .input:focus, select:focus {
            outline: none;
            border-color: theme('colors.primary.DEFAULT');
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); /* primary focus ring */
        }
         .dark .input:focus, .dark select:focus {
             border-color: theme('colors.primary.dark');
             box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.4);
         }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Button Styling */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1rem; /* py-2.5 px-4 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid transparent;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            white-space: nowrap;
        }
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4); /* primary focus ring */
        }
        .dark .btn:focus {
             box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5);
        }
        .btn-primary {
            background-color: theme('colors.primary.DEFAULT');
            color: white;
            border-color: theme('colors.primary.DEFAULT');
        }
        .btn-primary:hover {
            background-color: #4338ca; /* darken indigo-600 */
            border-color: #4338ca;
        }
        .dark .btn-primary {
            background-color: theme('colors.primary.dark');
            border-color: theme('colors.primary.dark');
        }
        .dark .btn-primary:hover {
             background-color: #4f46e5; /* indigo-600 */
             border-color: #4f46e5;
        }
        .btn-secondary {
             background-color: theme('colors.secondary.DEFAULT');
             color: white;
             border-color: theme('colors.secondary.DEFAULT');
        }
        .btn-secondary:hover {
             background-color: #059669; /* darken emerald-500 */
             border-color: #059669;
        }
        .dark .btn-secondary {
             background-color: theme('colors.secondary.dark');
             border-color: theme('colors.secondary.dark');
        }
        .dark .btn-secondary:hover {
             background-color: #10b981; /* emerald-500 */
             border-color: #10b981;
        }
        .btn-ghost {
            background-color: transparent;
            color: theme('colors.foreground.dark');
            border: 1px solid theme('colors.border.dark');
        }
        .btn-ghost:hover {
             background-color: theme('colors.gray.100');
        }
        .dark .btn-ghost {
             color: theme('colors.foreground.dark');
             border-color: theme('colors.border.dark');
        }
        .dark .btn-ghost:hover {
             background-color: theme('colors.gray.700');
        }
        .btn-destructive-ghost {
            background-color: transparent;
            color: theme('colors.destructive.dark');
            border: none;
            padding: 0.25rem 0.5rem; /* Smaller padding for inline actions */
            font-size: 0.75rem; /* text-xs */
            font-weight: 500;
        }
        .btn-destructive-ghost:hover {
             background-color: theme('colors.red.50');
             color: theme('colors.red.600');
        }
         .dark .btn-destructive-ghost {
             color: theme('colors.destructive.dark');
         }
         .dark .btn-destructive-ghost:hover {
             background-color: rgba(239, 68, 68, 0.1); /* red-500 with alpha */
             color: theme('colors.red.400');
         }
        .btn i { /* Style for Lucide icons within buttons */
            margin-right: 0.5rem; /* space between icon and text */
            font-size: 1.1em; /* slightly larger icon */
        }
        .btn-icon-only { /* For buttons with only an icon */
             padding: 0.5rem;
        }
         .btn-icon-only i {
             margin-right: 0;
         }

        /* Output Section Styling */
        .output-section {
             margin-top: 1.5rem; /* mt-6 */
             padding-top: 1.5rem; /* pt-6 */
             border-top: 1px solid theme('colors.border.dark');
        }
        .dark .output-section {
             border-top-color: theme('colors.border.dark');
        }
        .output-label {
             display: block;
             font-size: 0.875rem; /* text-sm */
             font-weight: 500; /* font-medium */
             color: theme('colors.muted.dark');
             margin-bottom: 0.25rem; /* mb-1 */
        }
         .dark .output-label {
             color: theme('colors.muted.dark');
         }
        .output-value {
             font-size: 1.5rem; /* text-2xl */
             font-weight: 600; /* font-semibold */
             line-height: 1.2;
             display: block;
        }
        .output-note {
             font-size: 0.75rem; /* text-xs */
             color: theme('colors.muted.dark');
             margin-top: 0.25rem; /* mt-1 */
        }
        .dark .output-note {
             color: theme('colors.muted.dark');
        }
        /* Specific output colors */
        #calculatedCost { color: theme('colors.secondary.DEFAULT'); }
        .dark #calculatedCost { color: theme('colors.secondary.dark'); }
        #calculatedFuelCost { color: theme('colors.blue.600'); }
        .dark #calculatedFuelCost { color: theme('colors.blue.400'); }
        #calculatedProfit { color: theme('colors.amber.600'); }
        .dark #calculatedProfit { color: theme('colors.amber.400'); }
        #calculatedTime { /* Use muted color for calculated time output */
            color: theme('colors.muted.dark');
            font-weight: 500; /* font-medium */
            font-size: 1rem; /* text-base */
        }
        .dark #calculatedTime { color: theme('colors.muted.dark'); }

        /* --- Overtime Toggle Switch Style (Modernized) --- */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: theme('colors.gray.300'); transition: .3s; border-radius: 24px; }
        .dark .slider { background-color: theme('colors.gray.600'); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: theme('colors.primary.DEFAULT'); }
        .dark input:checked + .slider { background-color: theme('colors.primary.dark'); }
        input:focus + .slider { box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3); }
        .dark input:focus + .slider { box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.4); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- Table Styling --- */
        .table-container { overflow-x: auto; border: 1px solid theme('colors.border.dark'); border-radius: 0.5rem; /* rounded-lg */ }
        .dark .table-container { border-color: theme('colors.border.dark'); }
        .data-table { min-width: 100%; }
        .data-table thead th {
            padding: 0.75rem 1rem; /* px-4 py-3 */
            text-align: left;
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            color: theme('colors.muted.dark');
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background-color: theme('colors.gray.50');
        }
        .dark .data-table thead th {
             background-color: theme('colors.gray.700'); /* Darker header */
             color: theme('colors.muted.dark');
        }
        .data-table tbody tr { transition: background-color 0.15s ease-in-out; }
        .data-table tbody td {
            padding: 0.75rem 1rem; /* px-4 py-3 */
            font-size: 0.875rem; /* text-sm */
            color: theme('colors.foreground.dark');
            white-space: nowrap;
            border-bottom: 1px solid theme('colors.border.dark'); /* Add subtle bottom border */
        }
        .dark .data-table tbody td {
             color: theme('colors.foreground.dark');
             border-bottom-color: theme('colors.border.dark');
        }
        .data-table tbody tr:last-child td { border-bottom: none; } /* Remove border for last row */

        /* Table Row Hover */
        .data-table tbody tr:not(.highlight-yellow):not(.highlight-red):hover {
            background-color: theme('colors.gray.50');
        }
        .dark .data-table tbody tr:not(.highlight-yellow):not(.highlight-red):hover {
            background-color: theme('colors.gray.700');
        }
        /* Table Highlighting (Subtler) */
        .highlight-yellow { background-color: theme('colors.highlight-yellow.dark'); }
        .dark .highlight-yellow { background-color: theme('colors.highlight-yellow.dark'); color: #fefce8; } /* amber-50 text for dark */
        .highlight-red { background-color: theme('colors.highlight-red.dark'); }
        .dark .highlight-red { background-color: theme('colors.highlight-red.dark'); color: #fef2f2; } /* red-50 text for dark */
        /* Ensure highlights override hover */
        .data-table tbody tr.highlight-yellow:hover,
        .data-table tbody tr.highlight-red:hover {
             /* Keep highlight color on hover */
             background-color: theme('colors.highlight-yellow.dark');
        }
        .dark .data-table tbody tr.highlight-yellow:hover { background-color: theme('colors.highlight-yellow.dark'); }
        .data-table tbody tr.highlight-red:hover { background-color: theme('colors.highlight-red.dark'); }
        .dark .data-table tbody tr.highlight-red:hover { background-color: theme('colors.highlight-red.dark'); }

        /* Header and Footer styles */
        header {
            width: 100%;
            padding: 1rem 1.5rem; /* py-4 px-6 */
            background-color: theme('colors.card.dark');
            border-bottom: 1px solid theme('colors.border.dark');
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .dark header {
             background-color: theme('colors.card.dark');
             border-bottom-color: theme('colors.border.dark');
             box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        footer {
            margin-top: auto; /* Pushes footer down */
            width: 100%;
            padding: 1.5rem; /* py-6 */
            text-align: center;
            font-size: 0.875rem; /* text-sm */
            color: theme('colors.muted.dark');
            border-top: 1px solid theme('colors.border.dark');
        }
        .dark footer {
             color: theme('colors.muted.dark');
             border-top-color: theme('colors.border.dark');
        }

        /* Modal Styles & Animations */
        .modal-backdrop {
            position: fixed; inset: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent black */
            opacity: 0;
            transition: opacity 0.3s ease-out;
            z-index: 40; /* Below modal content */
            display: none; /* Hidden by default */
        }
        .modal-backdrop.active {
            opacity: 1;
            display: block;
        }
        .modal {
            position: fixed; inset: 0;
            overflow-y: auto;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem; /* Padding around modal */
            z-index: 50; /* Above backdrop */
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            pointer-events: none; /* Allow clicks through initially */
            display: none; /* Hidden by default */
        }
        .modal.active {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto; /* Enable interaction */
            display: flex;
        }
        .modal-content {
            background-color: theme('colors.card.dark');
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 36rem; /* max-w-xl */
            margin: auto;
            position: relative;
            overflow: hidden; /* Needed for potential internal scrolling */
        }
        .dark .modal-content {
            background-color: theme('colors.card.dark');
            border: 1px solid theme('colors.border.dark');
        }
        .modal-header {
            padding: 1rem 1.5rem; /* px-6 py-4 */
            border-bottom: 1px solid theme('colors.border.dark');
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dark .modal-header { border-bottom-color: theme('colors.border.dark'); }
        .modal-title { font-size: 1.125rem; /* text-lg */ font-weight: 600; }
        .modal-body { padding: 1.5rem; /* p-6 */ }
        .modal-footer {
            padding: 1rem 1.5rem; /* px-6 py-4 */
            border-top: 1px solid theme('colors.border.dark');
            background-color: theme('colors.gray.50');
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem; /* space-x-3 */
        }
        .dark .modal-footer {
            border-top-color: theme('colors.border.dark');
            background-color: theme('colors.gray.800'); /* Slightly different footer bg */
        }

        /* Chart container */
        #towChartContainer {
            position: relative;
            height: 350px; /* Increased height */
            width: 100%;
            margin-top: 1.5rem; /* mt-6 */
            padding: 1rem; /* Add some padding */
            border: 1px solid theme('colors.border.dark');
            border-radius: 0.5rem; /* rounded-lg */
            background-color: theme('colors.card.dark');
        }
        .dark #towChartContainer {
             border-color: theme('colors.border.dark');
             background-color: theme('colors.card.dark');
        }

        /* Prediction display */
        .prediction-box {
            background-color: theme('colors.prediction-blue.dark');
            border: 1px solid theme('colors.blue.200');
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
            margin-top: 1.5rem; /* mt-6 */
            text-align: center;
        }
        .dark .prediction-box {
            background-color: theme('colors.prediction-blue.dark');
            border-color: theme('colors.blue.800'); /* Darker border */
            color: theme('colors.blue.100');
        }
        .prediction-label {
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: theme('colors.blue.700');
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .dark .prediction-label { color: theme('colors.blue.200'); }
        .prediction-value {
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
            color: theme('colors.blue.600');
            line-height: 1;
        }
        .dark .prediction-value { color: theme('colors.blue.300'); }
        .prediction-note {
            font-size: 0.75rem; /* text-xs */
            color: theme('colors.blue.500');
            margin-top: 0.5rem; /* mt-2 */
        }
        .dark .prediction-note { color: theme('colors.blue.400'); }

        /* Radio button styling */
        input[type="radio"] {
             appearance: none;
             width: 1.15em;
             height: 1.15em;
             border: 2px solid theme('colors.input.dark');
             border-radius: 50%;
             margin-right: 0.35em;
             vertical-align: middle;
             transition: border 0.2s ease-in-out, background-color 0.2s ease-in-out;
             cursor: pointer;
             position: relative;
             top: -1px;
         }
         .dark input[type="radio"] {
             border-color: theme('colors.input.dark');
             background-color: theme('colors.gray.700');
         }
         input[type="radio"]:checked {
             border-color: theme('colors.primary.DEFAULT');
             background-color: theme('colors.primary.DEFAULT');
         }
         .dark input[type="radio"]:checked {
             border-color: theme('colors.primary.dark');
             background-color: theme('colors.primary.dark');
         }
         input[type="radio"]:checked::before {
             content: '';
             display: block;
             width: 0.5em;
             height: 0.5em;
             border-radius: 50%;
             background-color: white;
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
         }
         input[type="radio"]:focus {
             outline: none;
             box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
         }
         .dark input[type="radio"]:focus {
             box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.4);
         }

         /* Utility class */
         .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            vertical-align: -0.125em; /* Adjust alignment */
         }

    </style>
</head>
<body> <header>
        <div class="container mx-auto flex justify-between items-center px-4 sm:px-6 lg:px-8">
            <span class="text-xl font-semibold text-foreground-light dark:text-foreground-dark">
                <i class="lucide lucide-truck mr-2 text-primary-DEFAULT dark:text-primary-dark"></i> Treadz Towing
            </span>
            <a href="tel:423-357-4551" class="text-base font-medium text-primary-DEFAULT dark:text-primary-dark hover:underline flex items-center">
                <i class="lucide lucide-phone mr-2"></i>
                <span>423-357-4551</span>
            </a>
        </div>
    </header>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow">
        <div class="space-y-8"> <section aria-labelledby="calculator-heading" class="card">
                <h1 id="calculator-heading" class="text-xl md:text-2xl font-semibold mb-6 text-center">
                    Tow Pricing Calculator
                </h1>
                <form id="towCalculatorForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="input-group">
                        <label for="towType">Tow Difficulty:</label>
                        <select id="towType" name="towType" class="input">
                            <option value="Easy" selected>Easy (+$0)</option>
                            <option value="Medium">Medium (+$25)</option>
                            <option value="Hard">Hard (+$50)</option>
                        </select>
                    </div>
                    <div class="input-group">
                         <label for="overtimeCheckbox" class="mb-2">Rate Type:</label>
                         <div class="flex items-center space-x-3">
                             <label class="toggle-switch">
                                 <input type="checkbox" id="overtimeCheckbox" name="overtimeCheckbox">
                                 <span class="slider"></span>
                             </label>
                             <span id="rateLabel" class="text-sm text-muted-light dark:text-muted-dark">Standard ($85)</span>
                         </div>
                         <small class="text-xs text-muted-light dark:text-muted-dark block mt-1">Toggle for Overtime ($100)</small>
                    </div>
                    <div class="input-group">
                        <label for="distance">Distance (miles):</label>
                        <input type="number" id="distance" name="distance" min="0" step="0.1" placeholder="e.g., 15" value="15" required class="input">
                    </div>
                    <div class="input-group">
                        <label for="calculatedTime">Est. Time (min):</label>
                        <output id="calculatedTime" name="calculatedTime" class="input input-style text-center block">0</output>
                        <small class="text-xs text-muted-light dark:text-muted-dark block mt-1">Based on Distance</small>
                    </div>
                </form>

                <div class="output-section grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 items-start">
                     <div>
                         <span class="output-label">Estimated Cost:</span>
                         <output id="calculatedCost" name="calculatedCost" class="output-value">$0.00</output>
                     </div>
                     <div>
                         <span class="output-label">Fuel Cost:</span>
                         <output id="calculatedFuelCost" name="calculatedFuelCost" class="output-value">$0.00</output>
                         <p class="output-note">(Dist / 8 MPG) * $3.50/gal</p>
                     </div>
                     <div>
                         <span class="output-label">Est. Profit:</span>
                         <output id="calculatedProfit" name="calculatedProfit" class="output-value">$0.00</output>
                          <p class="output-note">(Cost - Fuel - Other) (Min $0)</p> </div>
                </div>
            </section>

            <section aria-labelledby="inventory-heading" class="card">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-5 gap-4">
                      <h2 id="inventory-heading" class="text-xl md:text-2xl font-semibold text-center sm:text-left">Lot Inventory</h2>
                       <div class="flex items-center w-full sm:w-auto gap-3">
                           <div class="relative flex-grow sm:flex-grow-0 sm:w-64">
                                <i class="lucide lucide-search absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-light dark:text-muted-dark pointer-events-none" style="font-size: 1.1rem;"></i>
                                <input type="search" id="searchInput" placeholder="Search inventory..." class="input pl-10"> </div>
                           <button id="addCarBtn" class="btn btn-primary flex-shrink-0">
                              <i class="lucide lucide-plus"></i>
                              <span>Add Car</span>
                          </button>
                      </div>
                 </div>
                 <div class="table-container">
                    <table id="inventoryTable" class="data-table divide-y divide-border dark:divide-border">
                         <thead>
                             <tr>
                                 <th>Date In</th>
                                 <th>Owner Name</th>
                                 <th>Make</th>
                                 <th>Model</th>
                                 <th>Plate</th>
                                 <th>Call Type</th>
                                 <th>Insurance</th>
                                 <th>Lot #</th>
                                 <th>Days</th>
                                 <th>Actions</th>
                             </tr>
                         </thead>
                         <tbody id="inventoryTbody">
                             <tr><td colspan="10" class="text-center py-6 text-muted-light dark:text-muted-dark">Loading inventory...</td></tr>
                         </tbody>
                     </table>
                 </div>
            </section>

            <section aria-labelledby="tow-data-heading" class="card">
                <h2 id="tow-data-heading" class="text-xl md:text-2xl font-semibold text-center mb-6">Tow Data & Prediction</h2>

                <form id="addTowDataForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-8 items-end">
                    <div class="input-group">
                        <label for="towDate">Date:</label>
                        <input type="date" id="towDate" name="towDate" required class="input">
                    </div>
                    <div class="input-group">
                        <label for="towCount">Number of Tows:</label>
                        <input type="number" id="towCount" name="towCount" min="0" step="1" placeholder="e.g., 5" required class="input">
                    </div>
                    <div class="input-group">
                        <button type="submit" class="btn btn-secondary w-full">
                             <i class="lucide lucide-plus-circle"></i>
                             <span>Add Tow Data</span>
                        </button>
                    </div>
                </form>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-4">
                         <h3 class="text-lg font-medium">Historical Tow Data</h3>
                         <div class="table-container">
                            <table id="towDataTable" class="data-table divide-y divide-border dark:divide-border">
                                 <thead>
                                     <tr>
                                         <th>Date</th>
                                         <th>Tows</th>
                                         <th>Actions</th>
                                     </tr>
                                 </thead>
                                 <tbody id="towDataTbody">
                                     <tr><td colspan="3" class="text-center py-6 text-muted-light dark:text-muted-dark">Loading tow data...</td></tr>
                                 </tbody>
                             </table>
                         </div>
                    </div>

                    <div class="lg:col-span-1 space-y-6">
                        <div>
                             <h3 class="text-lg font-medium mb-3">Monthly Tow Totals</h3>
                             <div id="towChartContainer">
                                 <canvas id="towChart"></canvas>
                             </div>
                        </div>
                        <div class="prediction-box">
                            <h3 class="prediction-label">Predicted Tows for Next Month:</h3>
                            <output id="predictedTows" class="prediction-value">...</output>
                            <p class="prediction-note">(Based on average of last 3 months)</p>
                        </div>
                    </div>
                </div>
            </section>

        </div> </main>

    <footer>
        <p>
            Â© <span id="currentYear"></span> Treadz Tire & Towing | 409 Main Street, Mount Carmel, TN | treadztnt@gmail.com
        </p>
        <script>document.getElementById('currentYear').textContent = new Date().getFullYear();</script>
    </footer>

    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div id="addCarModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
         <div class="modal-content">
             <div class="modal-header">
                 <h3 id="modalTitle" class="modal-title">Add New Car to Inventory</h3>
                 <button id="closeModalBtnTop" type="button" class="btn btn-ghost btn-icon-only text-muted-light dark:text-muted-dark hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Close modal">
                     <i class="lucide lucide-x"></i>
                 </button>
             </div>
             <form id="addCarForm">
                 <div class="modal-body space-y-4">
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                             <label for="dateIn">Date In:</label>
                             <input type="date" id="dateIn" name="dateIn" required class="input">
                         </div>
                         <div>
                             <label for="ownerName">Owner Name:</label>
                             <input type="text" id="ownerName" name="ownerName" required placeholder="e.g., John Doe" class="input">
                         </div>
                     </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                              <label for="make">Make:</label>
                              <input type="text" id="make" name="make" required placeholder="e.g., Toyota" class="input">
                          </div>
                          <div>
                              <label for="model">Model:</label>
                              <input type="text" id="model" name="model" required placeholder="e.g., Camry" class="input">
                          </div>
                     </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                             <label for="plateNumber">Plate Number:</label>
                             <input type="text" id="plateNumber" name="plateNumber" required placeholder="e.g., ABC-123" class="input">
                         </div>
                          <div>
                              <label for="callType">Call Type:</label>
                              <select id="callType" name="callType" required class="input">
                                  <option value="CHP">CHP</option>
                                  <option value="KPD">KPD</option>
                                  <option value="THP">THP</option>
                                  <option value="OWNER REQ">OWNER REQ</option>
                              </select>
                          </div>
                     </div>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                         <div>
                             <label class="block mb-2">Insurance:</label>
                             <div class="flex items-center space-x-4">
                                 <label class="flex items-center cursor-pointer">
                                     <input type="radio" name="insurance" value="Yes" required>
                                     <span class="ml-2 text-sm">Yes</span>
                                 </label>
                                 <label class="flex items-center cursor-pointer">
                                     <input type="radio" name="insurance" value="No" required>
                                     <span class="ml-2 text-sm">No</span>
                                 </label>
                             </div>
                         </div>
                         <div>
                              <label class="block mb-2">Lot Number:</label>
                              <div class="flex items-center space-x-4">
                                  <label class="flex items-center cursor-pointer">
                                       <input type="radio" name="lotNumber" value="1" required>
                                       <span class="ml-2 text-sm">Lot 1</span>
                                  </label>
                                  <label class="flex items-center cursor-pointer">
                                       <input type="radio" name="lotNumber" value="2" required>
                                       <span class="ml-2 text-sm">Lot 2</span>
                                  </label>
                              </div>
                         </div>
                     </div>
                 </div>
                 <div class="modal-footer">
                      <button id="closeModalBtnBottom" type="button" class="btn btn-ghost">Cancel</button>
                      <button id="saveCarBtn" type="submit" class="btn btn-primary">
                          <i class="lucide lucide-save"></i>
                          <span>Save Car</span>
                      </button>
                 </div>
             </form>
         </div>
    </div>

   <script>
    const INVENTORY_STORAGE_KEY = 'treadzInventory_v2';
    const TOW_DATA_STORAGE_KEY = 'treadzTowData_v2';
    let inventory = [];
    let towData = [];
    let towChartInstance = null;

    const towTypeSelect = document.getElementById('towType');
    const overtimeCheckbox = document.getElementById('overtimeCheckbox');
    const rateLabel = document.getElementById('rateLabel');
    const distanceInput = document.getElementById('distance');
    const calculatedTimeOutput = document.getElementById('calculatedTime');
    const calculatedCostOutput = document.getElementById('calculatedCost');
    const calculatedFuelCostOutput = document.getElementById('calculatedFuelCost');
    const calculatedProfitOutput = document.getElementById('calculatedProfit');
    const calculatorForm = document.getElementById('towCalculatorForm');
    const addCarBtn = document.getElementById('addCarBtn');
    const addCarModal = document.getElementById('addCarModal');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const addCarForm = document.getElementById('addCarForm');
    const closeModalBtnTop = document.getElementById('closeModalBtnTop');
    const closeModalBtnBottom = document.getElementById('closeModalBtnBottom');
    const inventoryTbody = document.getElementById('inventoryTbody');
    const searchInput = document.getElementById('searchInput');
    const addTowDataForm = document.getElementById('addTowDataForm');
    const towDateInput = document.getElementById('towDate');
    const towCountInput = document.getElementById('towCount');
    const towDataTbody = document.getElementById('towDataTbody');
    const towChartCanvas = document.getElementById('towChart');
    const predictedTowsOutput = document.getElementById('predictedTows');

    function formatDisplayDate(dateInput) {
        try {
            if (!dateInput) return 'N/A';
            const date = new Date(dateInput);
            if (!isNaN(date.getTime())) {
                const adjustedDate = (typeof dateInput === 'string' && dateInput.includes('-')) ? new Date(date.getTime() + date.getTimezoneOffset() * 60000) : date;
                const month = String(adjustedDate.getMonth() + 1).padStart(2, '0');
                const day = String(adjustedDate.getDate()).padStart(2, '0');
                const year = adjustedDate.getFullYear();
                if (year < 1900 || year > 2100) return 'Invalid Date';
                return `${month}/${day}/${year}`;
            }
        } catch (e) { console.error("Error formatting date:", dateInput, e); }
        return 'Invalid Date';
    }

    function daysDifference(dateStr1, dateStr2) {
        try {
            if (!dateStr1 || !dateStr2 || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr1) || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr2)) { console.warn("Invalid date format for difference calculation:", dateStr1, dateStr2); return NaN; }
            const date1 = Date.UTC(parseInt(dateStr1.substring(0, 4)), parseInt(dateStr1.substring(5, 7)) - 1, parseInt(dateStr1.substring(8, 10)));
            const date2 = Date.UTC(parseInt(dateStr2.substring(0, 4)), parseInt(dateStr2.substring(5, 7)) - 1, parseInt(dateStr2.substring(8, 10)));
            if (isNaN(date1) || isNaN(date2)) { console.warn("Could not parse dates for difference calculation:", dateStr1, dateStr2); return NaN; }
            const differenceInTime = date2 - date1;
            return Math.floor(differenceInTime / (1000 * 3600 * 24));
        } catch (error) { console.error("Error calculating days difference:", error); return NaN; }
    }

    function getTodayDateString() {
        const today = new Date(); const year = today.getFullYear(); const month = String(today.getMonth() + 1).padStart(2, '0'); const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function calculateAndDisplayPrice() {
         if (!towTypeSelect || !distanceInput || !overtimeCheckbox || !calculatedTimeOutput || !calculatedCostOutput || !calculatedFuelCostOutput || !calculatedProfitOutput || !rateLabel) return;
         const towType = towTypeSelect.value; const distance = parseFloat(distanceInput.value) || 0; const isOvertimeChecked = overtimeCheckbox.checked;
         const baseRate = isOvertimeChecked ? 100 : 85; rateLabel.textContent = isOvertimeChecked ? 'Overtime ($100)' : 'Standard ($85)';
         const travelTimeMinutes = distance === 0 ? 0 : (distance / 40) * 60; const baseTimeMinutes = 15;
         const calculatedTime = Math.round(travelTimeMinutes + baseTimeMinutes); calculatedTimeOutput.textContent = calculatedTime;
         let towTypeCharge = 0; if (towType === 'Medium') { towTypeCharge = 25; } else if (towType === 'Hard') { towTypeCharge = 50; }
         const mileageRate = 3.50; const mileageCharge = distance * mileageRate; const totalCost = baseRate + towTypeCharge + mileageCharge;
         const fuelCostPerMile = 3.50 / 8; const fuelCost = distance === 0 ? 0 : distance * fuelCostPerMile;
         const otherCostsPerMinute = 0.50; const otherCosts = calculatedTime * otherCostsPerMinute;
         const profit = totalCost - fuelCost - otherCosts; const displayProfit = Math.max(0, profit);
         calculatedCostOutput.textContent = `$${totalCost.toFixed(2)}`; calculatedFuelCostOutput.textContent = `$${fuelCost.toFixed(2)}`; calculatedProfitOutput.textContent = `$${displayProfit.toFixed(2)}`;
    }

    function createSampleInventory() {
         const sample = []; const baseDate = new Date();
         sample.push({ id: Date.now() + 1, dateIn: new Date(new Date().setDate(baseDate.getDate() - 2)).toISOString().split('T')[0], ownerName: "Alice Smith", make: "Honda", model: "Civic", plateNumber: "XYZ-789", callType: "OWNER REQ", insurance: true, lotNumber: "1" });
         sample.push({ id: Date.now() + 2, dateIn: new Date(new Date().setDate(baseDate.getDate() - 18)).toISOString().split('T')[0], ownerName: "Bob Johnson", make: "Ford", model: "F-150", plateNumber: "TRK-101", callType: "KPD", insurance: false, lotNumber: "2" });
         sample.push({ id: Date.now() + 3, dateIn: new Date(new Date().setDate(baseDate.getDate() - 35)).toISOString().split('T')[0], ownerName: "Charlie Brown", make: "Toyota", model: "RAV4", plateNumber: "SUV-4U", callType: "THP", insurance: true, lotNumber: "1" });
         return sample;
    }
     function createSampleTowData() {
         const sample = []; let date = new Date(); date.setDate(date.getDate() - 90);
         for (let i = 0; i < 90; i++) { sample.push({ id: Date.now() + 100 + i, date: date.toISOString().split('T')[0], tows: Math.floor(Math.random() * 8) + 1 }); date.setDate(date.getDate() + 1); }
         return sample;
     }

    function loadInventory() {
        try { const storedInventory = localStorage.getItem(INVENTORY_STORAGE_KEY); inventory = storedInventory ? JSON.parse(storedInventory) : createSampleInventory(); if (!Array.isArray(inventory)) inventory = [];
             inventory.sort((a, b) => { const dateA = a.dateIn ? new Date(a.dateIn) : null; const dateB = b.dateIn ? new Date(b.dateIn) : null; if (dateA && dateB) return dateB - dateA; if (dateA) return -1; if (dateB) return 1; return 0; });
        } catch (e) { console.error("Error loading or parsing inventory:", e); inventory = createSampleInventory(); localStorage.removeItem(INVENTORY_STORAGE_KEY); }
    }
    function saveInventory() { try { localStorage.setItem(INVENTORY_STORAGE_KEY, JSON.stringify(inventory)); } catch (e) { console.error("Error saving inventory:", e); } }

    function renderInventory(carsToRender = inventory) {
        if (!inventoryTbody) return; inventoryTbody.innerHTML = '';
        if (carsToRender.length === 0) { const message = searchInput.value ? 'No cars found matching your search.' : 'Inventory is currently empty.'; inventoryTbody.innerHTML = `<tr><td colspan="10" class="text-center py-6 text-muted-light dark:text-muted-dark">${message}</td></tr>`; return; }
        const todayStr = getTodayDateString();
        carsToRender.forEach(car => {
            if (!car || typeof car !== 'object') return; const daysInStorage = car.dateIn ? daysDifference(car.dateIn, todayStr) : NaN; let highlightClass = '';
            if (!isNaN(daysInStorage)) { if (daysInStorage >= 30) { highlightClass = 'highlight-red'; } else if (daysInStorage >= 17) { highlightClass = 'highlight-yellow'; } }
            const row = document.createElement('tr'); row.className = `${highlightClass}`; const getProp = (obj, prop) => obj?.[prop] ?? 'N/A'; let insuranceDisplay = 'N/A'; if (typeof car.insurance === 'boolean') { insuranceDisplay = car.insurance ? 'Yes' : 'No'; }
            row.innerHTML = `
                <td data-label="Date In">${formatDisplayDate(car.dateIn)}</td> <td data-label="Owner Name">${getProp(car, 'ownerName')}</td> <td data-label="Make">${getProp(car, 'make')}</td> <td data-label="Model">${getProp(car, 'model')}</td> <td data-label="Plate">${getProp(car, 'plateNumber')}</td> <td data-label="Call Type">${getProp(car, 'callType')}</td> <td data-label="Insurance">${insuranceDisplay}</td> <td data-label="Lot #">${getProp(car, 'lotNumber')}</td> <td data-label="Days" class="${isNaN(daysInStorage) ? 'text-destructive-light dark:text-destructive-dark' : ''}">${isNaN(daysInStorage) ? 'Error' : daysInStorage}</td>
                <td data-label="Actions"> <button data-id="${car.id}" class="remove-inventory-btn btn-destructive-ghost" title="Remove Car"> <i class="lucide lucide-trash-2 icon"></i> Remove </button> </td>`;
            inventoryTbody.appendChild(row);
        });
    }

    function filterAndRenderInventory() {
        if (!searchInput) return; const searchTerm = searchInput.value.toLowerCase().trim();
        const filteredInventory = !searchTerm ? inventory : inventory.filter(car => { const ownerMatch = car.ownerName?.toLowerCase().includes(searchTerm); const makeMatch = car.make?.toLowerCase().includes(searchTerm); const modelMatch = car.model?.toLowerCase().includes(searchTerm); const plateMatch = car.plateNumber?.toLowerCase().includes(searchTerm); return ownerMatch || makeMatch || modelMatch || plateMatch; });
        renderInventory(filteredInventory);
    }

    function showModal() {
        if (!addCarModal || !addCarForm || !modalBackdrop) return; addCarForm.reset(); document.getElementById('dateIn').value = getTodayDateString();
        modalBackdrop.style.display = 'block'; addCarModal.style.display = 'flex';
        setTimeout(() => { modalBackdrop.classList.add('active'); addCarModal.classList.add('active'); }, 10);
    }
    function hideModal() {
        if (!addCarModal || !modalBackdrop) return; modalBackdrop.classList.remove('active'); addCarModal.classList.remove('active');
         setTimeout(() => { modalBackdrop.style.display = 'none'; addCarModal.style.display = 'none'; }, 300);
    }

    function loadTowData() {
        try { const storedTowData = localStorage.getItem(TOW_DATA_STORAGE_KEY); towData = storedTowData ? JSON.parse(storedTowData) : createSampleTowData(); if (!Array.isArray(towData)) towData = []; towData.sort((a, b) => new Date(a.date) - new Date(b.date)); }
        catch (e) { console.error("Failed to load tow data:", e); towData = createSampleTowData(); localStorage.removeItem(TOW_DATA_STORAGE_KEY); }
    }
    function saveTowData() { try { towData.sort((a, b) => new Date(a.date) - new Date(b.date)); localStorage.setItem(TOW_DATA_STORAGE_KEY, JSON.stringify(towData)); } catch (e) { console.error("Failed to save tow data:", e); } }

    function renderTowDataTable() {
        if (!towDataTbody) return; towDataTbody.innerHTML = '';
        if (towData.length === 0) { towDataTbody.innerHTML = `<tr><td colspan="3" class="text-center py-6 text-muted-light dark:text-muted-dark">No tow data yet.</td></tr>`; return; }
        [...towData].reverse().forEach(data => {
            const row = document.createElement('tr'); row.className = 'text-sm tow-data-table-row';
            row.innerHTML = `
                <td data-label="Date">${formatDisplayDate(data.date) || 'N/A'}</td> <td data-label="Tows" class="text-center">${data.tows ?? 'N/A'}</td>
                <td data-label="Actions" class="text-center"> <button data-id="${data.id}" class="remove-tow-data-btn btn-destructive-ghost btn-icon-only" title="Remove Log Entry"> <i class="lucide lucide-trash-2 icon"></i> </button> </td>`;
            towDataTbody.appendChild(row);
        });
    }

    function aggregateTowsByMonth(data) {
        const monthlyTotals = {}; data.forEach(item => { try { const date = new Date(item.date + 'T00:00:00Z'); if (isNaN(date.getTime())) return; const year = date.getUTCFullYear(); const month = String(date.getUTCMonth() + 1).padStart(2, '0'); const yearMonth = `${year}-${month}`; monthlyTotals[yearMonth] = (monthlyTotals[yearMonth] || 0) + (item.tows || 0); } catch (e) { console.error("Error aggregating date:", item.date, e); } });
        const sortedMonths = Object.keys(monthlyTotals).sort(); const labels = sortedMonths.map(ym => { const [year, month] = ym.split('-'); const date = new Date(Date.UTC(year, month - 1, 1)); return date.toLocaleString('default', { month: 'short', year: 'numeric', timeZone: 'UTC' }); });
        const values = sortedMonths.map(ym => monthlyTotals[ym]); return { labels, values };
    }

    function renderTowChart() {
        if (!towChartCanvas) return; const ctx = towChartCanvas.getContext('2d'); const { labels, values } = aggregateTowsByMonth(towData);
        const isDarkMode = true; const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.1)'; const tickColor = isDarkMode ? '#9CA3AF' : '#6B7280';
        const tooltipBgColor = isDarkMode ? 'rgba(31, 41, 55, 0.9)' : '#FFFFFF'; const tooltipTitleColor = isDarkMode ? '#F3F4F6' : '#111827'; const tooltipBodyColor = isDarkMode ? '#D1D5DB' : '#374151';
        const barBgColor = 'rgba(124, 58, 237, 0.7)'; const barBorderColor = 'rgba(167, 139, 250, 0.6)';
        if (towChartInstance) { towChartInstance.destroy(); }
        towChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Total Tows', data: values, backgroundColor: barBgColor, borderColor: barBorderColor, borderWidth: 1, borderRadius: 5, borderSkipped: false }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0, color: tickColor }, grid: { color: gridColor, drawBorder: false } }, x: { ticks: { color: tickColor }, grid: { display: false, drawBorder: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBgColor, titleColor: tooltipTitleColor, bodyColor: tooltipBodyColor, padding: 10, cornerRadius: 6, displayColors: false, boxPadding: 4 } } } });
    }

    function predictNextMonthTows() {
        const { values: monthlyValues } = aggregateTowsByMonth(towData); if (monthlyValues.length < 1) { return "N/A"; }
        const lastMonths = monthlyValues.slice(-3); if (lastMonths.length === 0) return "N/A";
        const sum = lastMonths.reduce((acc, val) => acc + (val || 0), 0); const average = sum / lastMonths.length;
        return Math.round(average);
    }
    function displayPrediction() { if (!predictedTowsOutput) return; predictedTowsOutput.textContent = predictNextMonthTows(); }

    function setupEventListeners() {
        if (calculatorForm) { calculatorForm.addEventListener('input', calculateAndDisplayPrice); calculatorForm.addEventListener('change', calculateAndDisplayPrice); }
        if (addCarBtn) addCarBtn.addEventListener('click', showModal);
        if (closeModalBtnTop) closeModalBtnTop.addEventListener('click', hideModal);
        if (closeModalBtnBottom) closeModalBtnBottom.addEventListener('click', hideModal);
        if (modalBackdrop) { modalBackdrop.addEventListener('click', hideModal); }
        if (distanceInput) { distanceInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') event.preventDefault(); }); }
        if (addCarForm) { addCarForm.addEventListener('submit', handleAddCarSubmit); }
        if (inventoryTbody) { inventoryTbody.addEventListener('click', handleInventoryRemoveClick); }
        if (searchInput) { searchInput.addEventListener('input', filterAndRenderInventory); }
        if (addTowDataForm) { addTowDataForm.addEventListener('submit', handleAddTowDataSubmit); }
        if (towDataTbody) { towDataTbody.addEventListener('click', handleTowDataRemoveClick); }
        if (overtimeCheckbox) { overtimeCheckbox.addEventListener('change', calculateAndDisplayPrice); }
    }

    function handleAddCarSubmit(event) {
        event.preventDefault(); const formData = new FormData(addCarForm);
        const newCar = { id: Date.now(), dateIn: formData.get('dateIn'), ownerName: formData.get('ownerName')?.trim(), make: formData.get('make')?.trim(), model: formData.get('model')?.trim(), plateNumber: formData.get('plateNumber')?.trim(), callType: formData.get('callType'), insurance: formData.get('insurance') === 'Yes', lotNumber: formData.get('lotNumber') };
        if (!newCar.dateIn || !newCar.ownerName || !newCar.make || !newCar.model || !newCar.plateNumber || formData.get('insurance') === null || !newCar.lotNumber || !newCar.callType) { alert("Please fill out all car details."); return; }
        inventory.push(newCar); saveInventory();
        inventory.sort((a, b) => new Date(b.dateIn) - new Date(a.dateIn));
        filterAndRenderInventory(); hideModal();
    }
    function handleInventoryRemoveClick(event) {
         const button = event.target.closest('.remove-inventory-btn');
         if (button) { const carId = parseInt(button.getAttribute('data-id')); const carToRemove = inventory.find(car => car.id === carId); const confirmMessage = carToRemove ? `Remove ${carToRemove.make} ${carToRemove.model} (Plate: ${carToRemove.plateNumber})?` : 'Remove this car?'; if (confirm(confirmMessage)) { inventory = inventory.filter(car => car.id !== carId); saveInventory(); filterAndRenderInventory(); } }
    }
    function handleAddTowDataSubmit(event) {
        event.preventDefault(); const dateValue = towDateInput.value; const countValue = parseInt(towCountInput.value, 10);
        if (!dateValue || isNaN(countValue) || countValue < 0) { alert("Invalid date or tow count."); return; }
        const existingIndex = towData.findIndex(d => d.date === dateValue);
        if (existingIndex > -1) { if (!confirm(`Overwrite data for ${formatDisplayDate(dateValue)}?`)) { return; } towData[existingIndex].tows = countValue; } else { towData.push({ id: Date.now(), date: dateValue, tows: countValue }); }
        saveTowData(); renderTowDataTable(); renderTowChart(); displayPrediction();
        addTowDataForm.reset(); if(towDateInput) towDateInput.value = getTodayDateString();
    }
    function handleTowDataRemoveClick(event) {
        const button = event.target.closest('.remove-tow-data-btn');
         if (button) { const dataId = parseInt(button.getAttribute('data-id')); const entryToRemove = towData.find(d => d.id === dataId); const confirmMessage = entryToRemove ? `Remove entry for ${formatDisplayDate(entryToRemove.date)} (${entryToRemove.tows} tows)?` : 'Remove this entry?'; if (confirm(confirmMessage)) { towData = towData.filter(data => data.id !== dataId); saveTowData(); renderTowDataTable(); renderTowChart(); displayPrediction(); } }
    }

    function initializePage() {
        loadInventory(); loadTowData();
        calculateAndDisplayPrice(); filterAndRenderInventory();
        renderTowDataTable(); renderTowChart(); displayPrediction();
        if (addCarModal) { addCarModal.style.display = 'none'; addCarModal.classList.remove('active'); }
        if (modalBackdrop) { modalBackdrop.style.display = 'none'; modalBackdrop.classList.remove('active'); }
        if(towDateInput) towDateInput.value = getTodayDateString();
        setupEventListeners();
    }

    document.addEventListener('DOMContentLoaded', initializePage);
</script>


</body>
</html>
