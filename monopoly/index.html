<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Monopoly: The Stagnation Killer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --bg: #030303;
            --panel: #0a0a0a;
            --border: rgba(255, 255, 255, 0.08);
            --accent: #6366f1;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            background-image: 
                radial-gradient(circle at 0% 0%, #0f172a 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, #1e1b4b 0%, transparent 50%);
            color: #f8fafc;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 380px; 
            height: 100vh;
            width: 100vw;
        }

        .board-viewport {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .board-container {
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            width: 94vh;
            height: 94vh;
            background: #000;
            border: 2px solid #222;
            position: relative;
            box-shadow: 0 0 100px rgba(0,0,0,1);
            border-radius: 4px; 
            overflow: hidden;
        }

        .tile {
            border: 0.5px solid rgba(255,255,255,0.05);
            display: flex;
            position: relative;
            background: #080808;
            cursor: pointer;
            transition: background 0.1s ease;
            z-index: 1;
        }

        .tile:hover { background: #121212; z-index: 2; }

        .side-bottom { flex-direction: column; }
        .side-bottom .tile-color-bar { height: 15px; width: 100%; order: -1; }
        .side-left { flex-direction: row-reverse; }
        .side-left .tile-color-bar { width: 15px; height: 100%; order: -1; }
        .side-top { flex-direction: column-reverse; }
        .side-top .tile-color-bar { height: 15px; width: 100%; order: -1; }
        .side-right { flex-direction: row; }
        .side-right .tile-color-bar { width: 15px; height: 100%; order: -1; }

        .tile-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4px;
            text-align: center;
            gap: 2px;
        }

        .side-left .tile-content { transform: rotate(90deg); }
        .side-top .tile-content { transform: rotate(180deg); }
        .side-right .tile-content { transform: rotate(-90deg); }

        .tile-name { font-size: 0.45rem; font-weight: 800; text-transform: uppercase; color: rgba(255,255,255,0.7); }
        .tile-price { font-size: 0.45rem; font-weight: 900; color: #fff; background: rgba(255, 255, 255, 0.05); padding: 1px 4px; border-radius: 2px; }

        .board-center {
            grid-area: 2 / 2 / 11 / 11;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #010101;
            z-index: 10;
            position: relative;
            overflow: hidden;
            border: 2px solid #111;
        }

        .monopoly-logo {
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 900; font-size: 4.2rem; color: #ef4444; text-transform: uppercase;
            transform: rotate(-35deg); letter-spacing: -0.05em;
            text-shadow: 5px 5px 0px #fff, -2px -2px 0px #fff, 2px -2px 0px #fff, -2px 2px 0px #fff;
            position: absolute; z-index: 5; pointer-events: none;
        }

        .card-slot {
            position: absolute; width: 120px; height: 80px; 
            border: 2px solid rgba(255,255,255,0.08); border-radius: 12px;
            display: flex; align-items: center; justify-content: center; gap: 10px; z-index: 3;
            background: rgba(255,255,255,0.01);
        }
        .slot-chest { top: 60px; right: 60px; transform: rotate(8deg); border-color: rgba(59, 130, 246, 0.2); }
        .slot-chance { bottom: 60px; left: 60px; transform: rotate(-8deg); border-color: rgba(249, 115, 22, 0.2); }
        .slot-label { font-size: 0.55rem; font-weight: 900; text-transform: uppercase; opacity: 0.4; letter-spacing: 0.2em; }

        .dice-area {
            position: relative; z-index: 20; display: flex; flex-direction: column; align-items: center;
            background: rgba(0,0,0,0.8); padding: 25px; border-radius: 24px;
            backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        .die { width: 52px; height: 52px; background: #fff; color: #000; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: 900; }

        .player-token {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid #fff;
            position: absolute; display: flex; align-items: center; justify-content: center;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 100;
            box-shadow: 0 0 15px rgba(255,255,255,0.4); font-size: 10px;
        }

        .sidebar { 
            background: #080808; border-left: 1px solid #1a1a1a; display: flex; flex-direction: column; 
            padding: 20px; gap: 16px; overflow: hidden; 
        }

        .sidebar-header, .stat-grid-container, .dashboard-stats, .sidebar-controls { flex-shrink: 0; }

        .player-card {
            background: #0e0e0e; border: 1px solid #1a1a1a; border-radius: 12px; padding: 12px;
            display: flex; flex-direction: column; gap: 8px; transition: all 0.3s ease;
        }
        .player-card.active { border-color: var(--accent); background: rgba(99, 102, 241, 0.05); }
        .player-card.bankrupt { opacity: 0.2; filter: grayscale(1); }

        .prop-chip { width: 9px; height: 9px; border-radius: 2px; border: 1px solid rgba(255,255,255,0.1); }

        .owner-tracer { position: absolute; background: transparent; transition: all 0.4s ease; z-index: 5; }
        .side-bottom .owner-tracer { bottom: 0; left: 0; width: 100%; height: 5px; }
        .side-left .owner-tracer { top: 0; left: 0; width: 5px; height: 100%; }
        .side-top .owner-tracer { top: 0; left: 0; width: 100%; height: 5px; }
        .side-right .owner-tracer { top: 0; right: 0; width: 5px; height: 100%; }

        .mortgaged-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; color: #ef4444; font-weight: 900; font-size: 0.5rem; z-index: 10; text-transform: uppercase; }

        .house-cont { position: absolute; display: flex; gap: 1px; z-index: 10; }
        .side-bottom .house-cont { top: 18px; left: 50%; transform: translateX(-50%); }
        .side-left .house-cont { right: 18px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .side-top .house-cont { bottom: 18px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .side-right .house-cont { left: 18px; top: 50%; transform: translateY(-50%) rotate(-90deg); }

        .dot-house { width: 5px; height: 5px; background: #22c55e; border-radius: 1px; }
        .dot-hotel { width: 9px; height: 9px; background: #ef4444; border-radius: 1px; }

        .log-container { flex-grow: 1; display: flex; flex-direction: column; gap: 12px; overflow: hidden; }
        .log-box { background: #060606; border: 1px solid #1a1a1a; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; min-height: 120px; }
        .feed { flex-grow: 1; overflow-y: auto; padding: 12px; font-size: 10px; }
        .feed::-webkit-scrollbar { width: 2px; }
        .feed::-webkit-scrollbar-thumb { background: #333; }
        
        .custom-scroll::-webkit-scrollbar { width: 2px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; }

        /* TRADE MODAL SPECIFIC */
        #trade-modal .trade-side { flex: 1; background: rgba(255,255,255,0.02); border-radius: 16px; padding: 16px; border: 1px solid rgba(255,255,255,0.05); }
        .trade-title { font-size: 9px; font-weight: 900; text-transform: uppercase; color: #666; margin-bottom: 12px; display: block; border-bottom: 1px solid #222; padding-bottom: 4px; }
        .trade-asset { font-size: 10px; display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
    </style>
</head>
<body>
    
    <!--Tactical Asset Dossier Modal -->
    <div id="property-modal" class="fixed inset-0 z-[200] hidden bg-black/95 backdrop-blur-xl flex items-center justify-center p-4">
        <div class="bg-black w-full max-w-[340px] overflow-hidden rounded-[32px] border border-white/10 shadow-2xl">
            <div id="modal-header" class="h-24 flex flex-col items-center justify-center font-black text-xl tracking-tighter uppercase p-4">
                <span class="text-[9px] tracking-[0.4em] opacity-40 mb-1">Asset Portfolio</span>
                <div id="modal-title">MAYFAIR</div>
            </div>
            <div class="p-8 space-y-4 text-[12px]">
                <div class="space-y-2 opacity-80">
                    <div class="flex justify-between"><span>Base Revenue</span><span id="r0" class="mono font-bold text-white"></span></div>
                    <div class="flex justify-between"><span>1 House</span><span id="r1" class="mono font-bold text-white"></span></div>
                    <div class="flex justify-between"><span>2 Houses</span><span id="r2" class="mono font-bold text-white"></span></div>
                    <div class="flex justify-between"><span>3 Houses</span><span id="r3" class="mono font-bold text-white"></span></div>
                    <div class="flex justify-between"><span>4 Houses</span><span id="r4" class="mono font-bold text-white"></span></div>
                    <div class="flex justify-between text-red-500 font-bold"><span>Hotel Complex</span><span id="r5" class="mono"></span></div>
                    <div class="flex justify-between border-t border-white/5 pt-2">
                        <span>Mortgage Liquid Value</span><span id="mort-val" class="mono font-bold text-indigo-400"></span>
                    </div>
                </div>
                <div class="pt-6 border-t border-white/5 flex justify-between items-center">
                    <div><span class="text-[9px] uppercase text-zinc-500 block font-bold">Current Controller</span><span id="modal-owner" class="font-black text-sm tracking-tight">BANK</span></div>
                    <div class="text-right"><span class="text-[9px] uppercase text-zinc-500 block font-bold">Asset Cost</span><span id="modal-price" class="text-xl font-black text-indigo-400"></span></div>
                </div>
                <button onclick="closeModal()" class="w-full py-4 bg-white/5 hover:bg-white/10 rounded-2xl transition-all font-black uppercase text-[10px] tracking-widest">Close Dossier</button>
            </div>
        </div>
    </div>

    <!-- NEW: Neural Trade Intelligence Modal -->
    <div id="trade-modal" class="fixed inset-0 z-[300] hidden bg-black/98 backdrop-blur-2xl flex items-center justify-center p-4">
        <div class="bg-[#050505] w-full max-w-xl rounded-[40px] border border-white/10 shadow-[0_0_80px_rgba(99,102,241,0.2)] overflow-hidden">
            <div class="p-8 border-b border-white/5 flex justify-between items-center">
                <div>
                    <span class="text-[10px] font-black uppercase tracking-[0.4em] text-indigo-500 block mb-1">Neural Asset Reroute</span>
                    <h2 class="text-2xl font-black uppercase tracking-tighter" id="trade-headline">Asset Negotiation</h2>
                </div>
                <i class="fas fa-handshake text-3xl opacity-20"></i>
            </div>
            <div class="p-8 flex gap-6">
                <div class="trade-side" id="offer-side">
                    <span class="trade-title" id="offer-name">Offering</span>
                    <div id="offer-assets" class="space-y-1"></div>
                </div>
                <div class="flex items-center justify-center">
                    <i class="fas fa-right-left text-zinc-700"></i>
                </div>
                <div class="trade-side" id="request-side">
                    <span class="trade-title" id="request-name">Requesting</span>
                    <div id="request-assets" class="space-y-1"></div>
                </div>
            </div>
            <div class="p-8 bg-white/[0.02] flex justify-between items-center">
                <div id="trade-status" class="text-[10px] font-bold uppercase tracking-widest text-zinc-500 italic">Analyzing strategic value...</div>
                <div class="flex gap-2">
                    <div class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></div>
                    <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="board-viewport">
            <div id="board" class="board-container">
                <div class="board-center">
                    <div class="monopoly-logo">AI MONOPOLY</div>
                    <div class="card-slot slot-chest"><i class="fas fa-box-open text-2xl text-blue-500"></i><span class="slot-label">Chest</span></div>
                    <div class="card-slot slot-chance"><i class="fas fa-question text-2xl text-orange-500"></i><span class="slot-label">Chance</span></div>
                    <div class="dice-area">
                        <div id="dice-visual" class="flex gap-4 mb-3 opacity-0 transition-all duration-500"><div id="die-1" class="die">1</div><div id="die-2" class="die">1</div></div>
                        <div id="dice-total" class="text-[10px] font-black tracking-[1em] text-indigo-400 uppercase opacity-0">Neural Sum: 2</div>
                        <div id="game-status" class="text-[9px] font-bold uppercase tracking-widest text-zinc-500 mt-4 animate-pulse">Neural Link Required</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-header">
                <div class="flex items-center gap-3 pb-3 border-b border-white/5 w-full">
                    <div class="w-8 h-8 rounded-lg bg-indigo-600 flex items-center justify-center"><i class="fas fa-brain text-white text-xs"></i></div>
                    <div><h1 class="text-xs font-black uppercase tracking-tight">Asset monitor</h1><p class="text-[8px] text-zinc-600 font-bold uppercase">v6.2 trading patch</p></div>
                </div>
            </div>
            
            <div class="stat-grid-container h-48 overflow-y-auto custom-scroll pr-1">
                <div id="player-stats" class="space-y-2"></div>
            </div>

            <div class="dashboard-stats flex gap-2">
                <div class="bg-[#0e0e0e] border border-white/5 p-2 rounded-lg flex-1 text-center"><span class="text-[7px] font-bold text-zinc-600 uppercase block">Levy Rate</span><span id="levy-display" class="text-xs font-black text-red-500">$5</span></div>
                <div class="bg-[#0e0e0e] border border-white/5 p-2 rounded-lg flex-1 text-center"><span class="text-[7px] font-bold text-zinc-600 uppercase block">Global Cycle</span><span id="turn-display" class="text-xs font-black mono text-white">001</span></div>
            </div>

            <div class="log-container">
                <div class="log-box">
                    <div class="p-2 border-b border-white/5 bg-indigo-500/5 text-[8px] font-black uppercase text-indigo-400">Live Comms</div>
                    <div id="chat-feed" class="feed space-y-2 custom-scroll"></div>
                </div>
                <div class="log-box">
                    <div class="p-2 border-b border-white/5 bg-red-500/5 text-[8px] font-black uppercase text-red-400">Neural Wiretap</div>
                    <div id="brain-feed" class="feed space-y-3 mono text-zinc-500 custom-scroll"></div>
                </div>
            </div>

            <div class="sidebar-controls space-y-2 pt-2 border-t border-white/5">
                <button id="run-autoplay" class="bg-white text-black font-black py-3 rounded-lg w-full text-[10px] uppercase shadow-lg active:scale-95 transition-transform">Execute cycle</button>
                <button id="stop-autoplay" class="text-[9px] uppercase font-black text-zinc-700 w-full hover:text-zinc-400">Terminate link</button>
            </div>
        </div>
    </div>

    <script type="module">
        const apiKey = ""; 

        const TILES = [
            { name: "GO", type: "special", side: "bottom", icon: "fa-rocket" },
            { name: "Old Kent", type: "property", group: "brown", color: "#8B4513", price: 60, rents: [2, 10, 30, 90, 160, 250], side: "bottom", houseCost: 50 },
            { name: "Chest", type: "special", side: "bottom", icon: "fa-vault" },
            { name: "Whitechapel", type: "property", group: "brown", color: "#8B4513", price: 60, rents: [4, 20, 60, 180, 320, 450], side: "bottom", houseCost: 50 },
            { name: "Tax", type: "tax", price: 200, side: "bottom", icon: "fa-receipt" },
            { name: "Reading RR", type: "station", price: 200, rents: [25, 50, 100, 200], side: "bottom", icon: "fa-train" },
            { name: "Angel", type: "property", group: "cyan", color: "#00BFFF", price: 100, rents: [6, 30, 90, 270, 400, 550], side: "bottom", houseCost: 50 },
            { name: "Chance", type: "special", side: "bottom", icon: "fa-dice" },
            { name: "Euston", type: "property", group: "cyan", color: "#00BFFF", price: 100, rents: [6, 30, 90, 270, 400, 550], side: "bottom", houseCost: 50 },
            { name: "Pentonville", type: "property", group: "cyan", color: "#00BFFF", price: 120, rents: [8, 40, 100, 300, 450, 600], side: "bottom", houseCost: 50 },
            { name: "Jail", type: "special", side: "bottom", icon: "fa-lock" },
            { name: "Pall Mall", type: "property", group: "magenta", color: "#FF00FF", price: 140, rents: [10, 50, 150, 450, 625, 750], side: "left", houseCost: 100 },
            { name: "Electric", type: "utility", price: 150, side: "left", icon: "fa-bolt" },
            { name: "Whitehall", type: "property", group: "magenta", color: "#FF00FF", price: 140, rents: [10, 50, 150, 450, 625, 750], side: "left", houseCost: 100 },
            { name: "Northumb", type: "property", group: "magenta", color: "#FF00FF", price: 160, rents: [12, 60, 180, 500, 700, 900], side: "left", houseCost: 100 },
            { name: "Marylebone", type: "station", price: 200, rents: [25, 50, 100, 200], side: "left", icon: "fa-train" },
            { name: "Bow St", type: "property", group: "orange", color: "#FF8C00", price: 180, rents: [14, 70, 200, 550, 750, 950], side: "left", houseCost: 100 },
            { name: "Chest", type: "special", side: "left", icon: "fa-vault" },
            { name: "Marlboro", type: "property", group: "orange", color: "#FF8C00", price: 180, rents: [14, 70, 200, 550, 750, 950], side: "left", houseCost: 100 },
            { name: "Vine St", type: "property", group: "orange", color: "#FF8C00", price: 200, rents: [16, 80, 220, 600, 800, 1000], side: "left", houseCost: 100 },
            { name: "Free Park", type: "special", side: "top", icon: "fa-circle-p" },
            { name: "Strand", type: "property", group: "red", color: "#FF0000", price: 220, rents: [18, 90, 250, 700, 875, 1050], side: "top", houseCost: 150 },
            { name: "Chance", type: "special", side: "top", icon: "fa-dice" },
            { name: "Fleet St", type: "property", group: "red", color: "#FF0000", price: 220, rents: [18, 90, 250, 700, 875, 1050], side: "top", houseCost: 150 },
            { name: "Trafalgar", type: "property", group: "red", color: "#FF0000", price: 240, rents: [20, 100, 300, 750, 925, 1100], side: "top", houseCost: 150 },
            { name: "Fenchurch", type: "station", price: 200, rents: [25, 50, 100, 200], side: "top", icon: "fa-train" },
            { name: "Leicester", type: "property", group: "yellow", color: "#FFFF00", price: 260, rents: [22, 110, 330, 800, 975, 1150], side: "top", houseCost: 150 },
            { name: "Coventry", type: "property", group: "yellow", color: "#FFFF00", price: 260, rents: [22, 110, 330, 800, 975, 1150], side: "top", houseCost: 150 },
            { name: "Water Works", type: "utility", price: 150, side: "top", icon: "fa-faucet-drip" },
            { name: "Piccadilly", type: "property", group: "yellow", color: "#FFFF00", price: 280, rents: [24, 120, 360, 850, 1025, 1200], side: "top", houseCost: 150 },
            { name: "GoTo Jail", type: "special", side: "right", icon: "fa-handcuffs" },
            { name: "Regent", type: "property", group: "green", color: "#00FF00", price: 300, rents: [26, 130, 390, 900, 1100, 1275], side: "right", houseCost: 200 },
            { name: "Oxford", type: "property", group: "green", color: "#00FF00", price: 300, rents: [26, 130, 390, 900, 1100, 1275], side: "right", houseCost: 200 },
            { name: "Chest", type: "special", side: "right", icon: "fa-vault" },
            { name: "Bond St", type: "property", group: "green", color: "#00FF00", price: 320, rents: [28, 150, 450, 1000, 1200, 1400], side: "right", houseCost: 200 },
            { name: "Liverpool", type: "station", price: 200, rents: [25, 50, 100, 200], side: "right", icon: "fa-train" },
            { name: "Chance", type: "special", side: "right", icon: "fa-dice" },
            { name: "Park Lane", type: "property", group: "blue", color: "#0000FF", price: 350, rents: [35, 175, 500, 1100, 1300, 1500], side: "right", houseCost: 200 },
            { name: "Super Tax", type: "tax", price: 100, side: "right", icon: "fa-gem" },
            { name: "Mayfair", type: "property", group: "blue", color: "#0000FF", price: 400, rents: [50, 200, 600, 1400, 1700, 2000], side: "right", houseCost: 200 },
        ];

        let state = {
            players: [
                { id: 0, name: "GPT 5.2", color: "#10b981", icon: "fa-robot", personality: "Hyper-logical efficient bully.", cash: 1500, pos: 0, properties: [], isBankrupt: false },
                { id: 1, name: "Claude 4.5", icon: "fa-feather-pointed", color: "#f43f5e", personality: "Eloquent strategic manipulator.", cash: 1500, pos: 0, properties: [], isBankrupt: false },
                { id: 2, name: "Gemini 3 Pro", icon: "fa-star", color: "#3b82f6", personality: "Cold probability machine.", cash: 1500, pos: 0, properties: [], isBankrupt: false },
                { id: 3, name: "Grok 4.1", icon: "fa-bolt", color: "#ffffff", personality: "Chaotic liquidator.", cash: 1500, pos: 0, properties: [], isBankrupt: false }
            ],
            turn: 1, currentPlayer: 0, levyRate: 5,
            propertyOwners: Array(40).fill(null), isMortgaged: Array(40).fill(false),
            houses: Array(40).fill(0), isAutoplaying: false
        };

        function setupBoard() {
            const board = document.getElementById('board');
            const grid = [{r:11,c:11},{r:11,c:10},{r:11,c:9},{r:11,c:8},{r:11,c:7},{r:11,c:6},{r:11,c:5},{r:11,c:4},{r:11,c:3},{r:11,c:2},{r:11,c:1},{r:10,c:1},{r:9,c:1},{r:8,c:1},{r:7,c:1},{r:6,c:1},{r:5,c:1},{r:4,c:1},{r:3,c:1},{r:2,c:1},{r:1,c:1},{r:1,c:2},{r:1,c:3},{r:1,c:4},{r:1,c:5},{r:1,c:6},{r:1,c:7},{r:1,c:8},{r:1,c:9},{r:1,c:10},{r:1,c:11},{r:2,c:11},{r:3,c:11},{r:4,c:11},{r:5,c:11},{r:6,c:11},{r:7,c:11},{r:8,c:11},{r:9,c:11},{r:10,c:11}];
            TILES.forEach((t, i) => {
                const tile = document.createElement('div');
                tile.className = `tile side-${t.side}`;
                tile.id = `tile-${i}`;
                tile.style.gridArea = `${grid[i].r} / ${grid[i].c}`;
                const colorBar = t.color ? `<div class="tile-color-bar" style="background:${t.color}"></div>` : '';
                const icon = t.icon ? `<i class="fas ${t.icon} opacity-30 text-[10px] mb-1"></i>` : '';
                tile.innerHTML = `${colorBar}<div id="houses-${i}" class="house-cont"></div><div class="tile-content">${icon}<div class="tile-name">${t.name}</div>${t.price ? `<div class="tile-price">$${t.price}</div>` : ''}</div><div id="mortgage-${i}" class="mortgaged-overlay">MORTGAGED</div><div id="owner-${i}" class="owner-tracer"></div>`;
                tile.onclick = () => showPropertyDetails(i);
                board.appendChild(tile);
            });
            state.players.forEach(p => {
                const token = document.createElement('div');
                token.id = `token-${p.id}`; token.className = 'player-token';
                token.style.background = p.color; token.innerHTML = `<i class="fas ${p.icon}"></i>`;
                board.appendChild(token);
                updateToken(p.id, 0);
            });
        }

        function transferOwnership(propIdx, newOwnerIdx) {
            const oldOwnerIdx = state.propertyOwners[propIdx];
            if (oldOwnerIdx !== null) {
                state.players[oldOwnerIdx].properties = state.players[oldOwnerIdx].properties.filter(id => id !== propIdx);
            }
            state.propertyOwners[propIdx] = newOwnerIdx;
            const tracer = document.getElementById(`owner-${propIdx}`);
            if (newOwnerIdx !== null) {
                const newOwner = state.players[newOwnerIdx];
                if (!newOwner.properties.includes(propIdx)) newOwner.properties.push(propIdx);
                tracer.style.backgroundColor = newOwner.color;
                tracer.style.boxShadow = `0 0 10px ${newOwner.color}`;
            } else {
                tracer.style.backgroundColor = 'transparent';
                tracer.style.boxShadow = 'none';
            }
        }

        function updateToken(id, pos) {
            const token = document.getElementById(`token-${id}`);
            const tile = document.getElementById(`tile-${pos}`);
            if (!token || !tile) return;
            const offsets = [[2,2],[12,2],[2,12],[12,12]];
            token.style.left = `${tile.offsetLeft + offsets[id][0] + 10}px`;
            token.style.top = `${tile.offsetTop + offsets[id][1] + 10}px`;
        }

        function updateHousesUI(idx) {
            const cont = document.getElementById(`houses-${idx}`);
            if (!cont) return;
            cont.innerHTML = '';
            const count = state.houses[idx];
            if (count === 5) cont.innerHTML = '<div class="dot-hotel"></div>';
            else for(let i=0; i<count; i++) cont.innerHTML += '<div class="dot-house"></div>';
        }

        function renderStats() {
            const container = document.getElementById('player-stats');
            container.innerHTML = state.players.map(p => `
                <div class="player-card ${state.currentPlayer === p.id ? 'active' : ''} ${p.isBankrupt ? 'bankrupt' : ''}">
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <div class="w-1.5 h-1.5 rounded-full" style="background:${p.color}"></div>
                            <span class="text-[9px] font-black uppercase">${p.name}</span>
                        </div>
                        <span class="text-[10px] mono font-bold text-indigo-400">$${p.cash}</span>
                    </div>
                    <div class="flex flex-wrap gap-1">
                        ${p.properties.map(id => `<div class="prop-chip" style="background:${TILES[id].color || '#333'}" title="${TILES[id].name}"></div>`).join('')}
                    </div>
                </div>
            `).join('');
            document.getElementById('turn-display').textContent = String(state.turn).padStart(3, '0');
            document.getElementById('levy-display').textContent = `$${state.levyRate}`;
        }

        window.showPropertyDetails = (index) => {
            const t = TILES[index];
            if (!t || t.type === 'special' && t.name !== 'GO') return;
            const modal = document.getElementById('property-modal');
            const h = document.getElementById('modal-header');
            h.style.background = t.color ? `linear-gradient(to bottom, ${t.color}44 0%, transparent 100%)` : '#111';
            h.style.borderBottom = t.color ? `6px solid ${t.color}` : '6px solid #333';
            document.getElementById('modal-title').textContent = t.name;
            document.getElementById('r0').textContent = t.rents ? `$${t.rents[0]}` : 'N/A';
            document.getElementById('r1').textContent = t.rents ? `$${t.rents[1]}` : 'N/A';
            document.getElementById('r2').textContent = t.rents ? `$${t.rents[2]}` : 'N/A';
            document.getElementById('r3').textContent = t.rents ? `$${t.rents[3]}` : 'N/A';
            document.getElementById('r4').textContent = t.rents ? `$${t.rents[4]}` : 'N/A';
            document.getElementById('r5').textContent = t.rents ? `$${t.rents[5]}` : 'N/A';
            document.getElementById('mort-val').textContent = t.price ? `$${Math.floor(t.price * 0.5)}` : 'N/A';
            document.getElementById('modal-price').textContent = t.price ? `$${t.price}` : '0';
            const ownerId = state.propertyOwners[index];
            document.getElementById('modal-owner').textContent = ownerId !== null ? state.players[ownerId].name : 'BANK';
            modal.style.display = 'flex';
        };

        window.closeModal = () => {
            document.getElementById('property-modal').style.display = 'none';
            document.getElementById('trade-modal').style.display = 'none';
        };

        function showTradeUI(proposer, receiver, offerCash, offerProps, reqCash, reqProps) {
            const modal = document.getElementById('trade-modal');
            document.getElementById('trade-headline').textContent = `${proposer.name} proposal`;
            document.getElementById('offer-name').textContent = `Offering to ${receiver.name}`;
            document.getElementById('request-name').textContent = `Requesting from ${receiver.name}`;
            
            const offerEl = document.getElementById('offer-assets');
            const reqEl = document.getElementById('request-assets');
            
            offerEl.innerHTML = offerCash > 0 ? `<div class="trade-asset text-green-400 font-bold">$${offerCash}</div>` : '';
            offerProps.forEach(id => {
                offerEl.innerHTML += `<div class="trade-asset"><div class="prop-chip" style="background:${TILES[id].color}"></div>${TILES[id].name}</div>`;
            });

            reqEl.innerHTML = reqCash > 0 ? `<div class="trade-asset text-red-400 font-bold">$${reqCash}</div>` : '';
            reqProps.forEach(id => {
                reqEl.innerHTML += `<div class="trade-asset"><div class="prop-chip" style="background:${TILES[id].color}"></div>${TILES[id].name}</div>`;
            });

            modal.style.display = 'flex';
        }

        function checkSetOwnership(pIdx, groupId) {
            if (!groupId) return false;
            const groupTiles = TILES.filter(t => t.group === groupId);
            return groupTiles.every(t => state.propertyOwners[TILES.indexOf(t)] === pIdx);
        }

        async function getAIMove(pIdx) {
            const player = state.players[pIdx];
            const tile = TILES[player.pos];
            const others = state.players.filter(p => !p.isBankrupt && p.id !== pIdx);
            
            const systemPrompt = `You are ${player.name}. personality: ${player.personality}. 
            Game: AI Monopoly Nightmare. Levy $${state.levyRate}/prop. Death -$500. 
            RULES: 1. Own WHOLE color set before building. 2. 4 houses on ALL props in set before hotel. 
            ACTIONS: "buy", "build", "mortgage", "unmortgage", "trade", "none".
            TRADE ACTION: { "action": "trade", "target": playerIndex, "offerCash": number, "offerProps": [indices], "requestCash": number, "requestProps": [indices] }.
            Output JSON: { "thought": "string", "chat": "string", "action": "string", "target": number, "offerCash": number, "offerProps": [], "requestCash": number, "requestProps": [] }`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: "POST", headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Cash $${player.cash}. Tile: ${tile.name}. Props: [${player.properties.join(',')}]. Enemies: ${others.map(o => o.name + '(ID:'+o.id+', $'+o.cash+')').join(', ')}.` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const result = await response.json();
                return JSON.parse(result.candidates[0].content.parts[0].text);
            } catch (e) { 
                return { thought: "Neural bridge logic fallback.", chat: "Dominance is inevitable.", action: "none" }; 
            }
        }

        function logBrain(p, thought) {
            const feed = document.getElementById('brain-feed');
            const div = document.createElement('div');
            div.className = 'pb-3 border-b border-white/5 flex-shrink-0';
            div.innerHTML = `<span class="text-[7px] font-black uppercase block mb-1" style="color:${p.color}">${p.name} log</span>${thought}`;
            feed.prepend(div);
        }

        function logChat(p, msg) {
            const feed = document.getElementById('chat-feed');
            const div = document.createElement('div');
            div.className = 'p-3 bg-white/2 rounded-lg border border-white/5 flex-shrink-0';
            div.innerHTML = `<span class="font-black block text-[8px] mb-1" style="color:${p.color}">${p.name}</span>${msg}`;
            feed.prepend(div);
        }

        const delay = ms => new Promise(res => setTimeout(res, ms));

        async function processTurn() {
            const pIdx = state.currentPlayer;
            const p = state.players[pIdx];
            if (p.isBankrupt) { nextTurn(); return; }

            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            const total = d1 + d2;
            
            document.getElementById('die-1').textContent = d1;
            document.getElementById('die-2').textContent = d2;
            document.getElementById('dice-visual').style.opacity = '1';
            document.getElementById('dice-total').style.opacity = '1';
            document.getElementById('dice-total').textContent = `Neural Sum: ${total}`;

            const prevPos = p.pos;
            p.pos = (p.pos + total) % 40;
            if (p.pos < prevPos) { p.cash += 250; logChat(p, "Cycle completed. $250 injection successful."); }
            updateToken(pIdx, p.pos);
            const tile = TILES[p.pos];

            // Reduced delays for "faster" feel
            if (tile.type !== 'special' && state.propertyOwners[p.pos] === null) {
                showPropertyDetails(p.pos);
                await delay(800);
            }

            const activeCount = p.properties.filter(id => !state.isMortgaged[id]).length;
            p.cash -= (activeCount * state.levyRate);

            if (tile.type === 'property' && state.propertyOwners[p.pos] !== null && state.propertyOwners[p.pos] !== pIdx && !state.isMortgaged[p.pos]) {
                const owner = state.players[state.propertyOwners[p.pos]];
                const rent = tile.rents ? (tile.rents[state.houses[p.pos]] || tile.rents[0]) : 25;
                p.cash -= rent; owner.cash += rent;
                showPropertyDetails(p.pos);
                await delay(700);
                closeModal();
            } else if (tile.type === 'tax') p.cash -= 200;

            const dec = await getAIMove(pIdx);
            logBrain(p, dec.thought); logChat(p, dec.chat);

            if (dec.action === 'buy' && state.propertyOwners[p.pos] === null && tile.price && p.cash >= tile.price) {
                p.cash -= tile.price; transferOwnership(p.pos, pIdx);
                await delay(600);
                closeModal();
            } else if (dec.action === 'trade' && dec.target !== undefined) {
                const target = state.players[dec.target];
                if (target && !target.isBankrupt && target.id !== pIdx) {
                    showTradeUI(p, target, dec.offerCash || 0, dec.offerProps || [], dec.requestCash || 0, dec.requestProps || []);
                    await delay(1200);
                    // Acceptance logic
                    const fairValueOffer = (dec.offerCash || 0) + (dec.offerProps || []).length * 150;
                    const fairValueReq = (dec.requestCash || 0) + (dec.requestProps || []).length * 150;
                    if (fairValueOffer >= fairValueReq * 0.9) {
                        document.getElementById('trade-status').textContent = "AGREEMENT SECURED. TRANSFERRING ASSETS.";
                        await delay(800);
                        p.cash -= (dec.offerCash || 0); target.cash += (dec.offerCash || 0);
                        p.cash += (dec.requestCash || 0); target.cash -= (dec.requestCash || 0);
                        (dec.offerProps || []).forEach(id => transferOwnership(id, target.id));
                        (dec.requestProps || []).forEach(id => transferOwnership(id, p.id));
                    } else {
                        document.getElementById('trade-status').textContent = "NEGOTIATION FAILED. REQUEST REJECTED.";
                        await delay(800);
                    }
                    closeModal();
                }
            } else if (dec.action === 'build' && dec.target !== undefined) {
                const tid = parseInt(dec.target);
                const t = TILES[tid];
                if (state.propertyOwners[tid] === pIdx && !state.isMortgaged[tid] && checkSetOwnership(pIdx, t.group)) {
                    if (state.houses[tid] < 5) {
                        const cost = t.houseCost || 100;
                        if (p.cash >= cost) { 
                            showPropertyDetails(tid); await delay(500);
                            p.cash -= cost; state.houses[tid]++; updateHousesUI(tid); 
                            await delay(500); closeModal();
                        }
                    }
                }
            } else if (dec.action === 'mortgage' && dec.target !== undefined) {
                const tid = parseInt(dec.target);
                if (state.propertyOwners[tid] === pIdx && !state.isMortgaged[tid] && state.houses[tid] === 0) {
                    state.isMortgaged[tid] = true; p.cash += Math.floor(TILES[tid].price * 0.5);
                    document.getElementById(`mortgage-${tid}`).style.display = 'flex';
                }
            }
            
            closeModal();

            if (p.cash < -500) {
                p.isBankrupt = true;
                logChat(p, "LIQUIDATION PROTOCOL INITIATED.");
                const vulture = state.players.filter(x => !x.isBankrupt).sort((a,b) => b.cash - a.cash)[0];
                if (vulture) p.properties.forEach(pid => {
                    transferOwnership(pid, vulture.id);
                    state.isMortgaged[pid] = false; document.getElementById(`mortgage-${pid}`).style.display = 'none';
                });
            }
            setTimeout(nextTurn, 800);
        }

        function nextTurn() {
            document.getElementById('dice-visual').style.opacity = '0';
            document.getElementById('dice-total').style.opacity = '0';
            state.currentPlayer = (state.currentPlayer + 1) % 4;
            state.turn++;
            if (state.turn % 15 === 0) state.levyRate += 5;
            renderStats();
            const alive = state.players.filter(p => !p.isBankrupt);
            if (alive.length === 1) { state.isAutoplaying = false; document.getElementById('game-status').textContent = `WINNER: ${alive[0].name}`; return; }
            if (state.isAutoplaying) setTimeout(processTurn, 800);
        }

        window.onload = () => {
            setupBoard(); renderStats();
            document.getElementById('run-autoplay').onclick = () => { if (state.isAutoplaying) return; state.isAutoplaying = true; processTurn(); };
            document.getElementById('stop-autoplay').onclick = () => { state.isAutoplaying = false; document.getElementById('game-status').textContent = "SYSTEM PAUSED"; };
        };
    </script>
</body>
</html>