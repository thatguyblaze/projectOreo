<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treadz Salvage - Parts Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #DC3B0B; /* Salvage Red */
            --primary-hover: #b93009;
            --secondary-color: #0078D4; /* Accent Blue */
            --border-color: #E1E1E1;
            --background-color: #F5F5F5;
            --card-background: #FFFFFF;
            --text-dark: #201F1E;
            --text-light: #605E5C;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-dark);
        }
        .main-nav {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border-color);
        }
        .container-box {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 1.2px 3.6px rgba(0,0,0,0.02), 0 6.4px 14.4px rgba(0,0,0,0.03);
        }
        .search-bar-wrapper { position: relative; }
        .search-bar {
            background-color: #F5F5F5;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding-right: 2.5rem;
        }
        .search-bar:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(220, 59, 11, 0.3);
        }
        .clear-search-btn {
            position: absolute; right: 0.5rem; top: 50%;
            transform: translateY(-50%); color: var(--text-light); display: none;
        }
        .btn { transition: all 0.2s ease-in-out; border-radius: 0.375rem; font-weight: 600; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-secondary { background-color: #F5F5F5; color: var(--text-dark); border: 1px solid #C8C6C4;}
        .btn-secondary:hover { background-color: #E1E1E1; }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        .car-card {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: .5rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: fadeIn 0.5s ease forwards;
            position: relative;
            cursor: pointer;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .car-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        
        .toast {
            transition: transform 0.4s ease, opacity 0.4s ease;
            transform: translateY(-120%); opacity: 0;
            background-color: var(--text-dark);
            color: var(--background-color);
            border-radius: 0.5rem;
        }
        .toast.show { transform: translateY(0); opacity: 1; }

        .data-input { width: 100%; padding: 0.6rem 0.8rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background-color: #F8F8F8; }
        .data-input:focus { border-color: var(--primary-color); background-color: white; outline: none; box-shadow: 0 0 0 2px rgba(220, 59, 11, 0.1); }
        
        /* Part Status Styles */
        .part-status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 90px;
            text-align: center;
            user-select: none;
        }
        .status-available { background-color: #e2f4e8; color: #107C10; }
        .status-removed { background-color: #fcebeb; color: #DC3B0B; }

        /* Modal specific styles */
        .part-grid {
            display: grid;
            grid-template-columns: 1fr 150px; /* Name | Status/Action */
            gap: 1.5rem;
        }
        .part-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid #F0F0F0;
            display: grid;
            grid-template-columns: subgrid;
            grid-column: 1 / -1;
            align-items: center;
        }
        .part-row:last-child { border-bottom: none; }
        .part-action-col { display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; }
    </style>
</head>
<body class="antialiased">
    <div id="app">
        <div id="toast" class="toast fixed top-5 right-5 z-50 p-4 shadow-xl flex items-center"></div>
        
        <!-- Navigation Bar -->
        <nav class="main-nav sticky top-0 z-40 p-4">
            <div class="max-w-7xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <!-- Treadz Salvage Logo -->
                    <svg role="img" width="30" height="30" viewBox="0 0 50 50" fill="var(--primary-color)" xmlns="http://www.w3.org/2000/svg">
                        <title>Treadz Salvage</title>
                        <path d="M44.75 32.74c-.58-1.12-1.74-1.84-2.81-1.84h-4.05c-.09 0-.17.06-.21.16-.04.09-.03.2.03.28l1.49 1.95c.23.3.09.73-.25.93-.34.2-.78.07-1.02-.23l-1.52-2c-1.17 1.35-2.6 2.4-4.27 3.08-1.66.68-3.52 1.02-5.46 1.02-7.73 0-14-6.27-14-14s6.27-14 14-14c1.93 0 3.79.34 5.46 1.02 1.67.68 3.1 1.73 4.27 3.08l1.52-2c.23-.31.67-.44 1.02-.23.34.2.48.63.25.93l-1.49 1.95c-.06.08-.07.19-.03.28.04.1.12.16.21.16h4.05c1.07 0 2.23-.72 2.81-1.84l4.58-8.7c.36-.68.17-1.51-.43-1.92s-1.44-.33-1.8.35L41.34 26.3H8.66L4.76 17.57c-.36-.68-1.2-.87-1.8-.35s-.79 1.24-.43 1.92l4.58 8.7c.58 1.12 1.74 1.84 2.81 1.84h3.69l-.79 2.53c-.2.65.17 1.34.82 1.54.65.2 1.34-.17 1.54-.82l.79-2.53h10.99l.79 2.53c.2.65.89 1.02 1.54.82.65-.2 1.02-.89.82-1.54l-.79-2.53h3.69c1.07 0 2.23-.72 2.81-1.84l4.58-8.7c.36-.68.17-1.51-.43-1.92s-1.44-.33-1.8.35l-3.9 8.73zM25 15c-5 0-9 4-9 9s4 9 9 9 9-4 9-9-4-9-9-9zM25 29c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
                    </svg>
                    <h1 class="text-xl font-extrabold text-gray-800 hidden sm:block">Treadz Salvage</h1>
                </div>
                <!-- Nav placeholder, all actions moved below search bar -->
                <div class="hidden"></div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            <!-- Search and Action Area (Centered) -->
            <section class="mb-8 p-6 container-box">
                <div class="search-bar-wrapper max-w-2xl mx-auto">
                    <div class="search-bar flex items-center p-2">
                        <input type="text" id="search-input" class="w-full bg-transparent text-xl focus:outline-none px-3" placeholder="Search by Year, Make, Model, or Stock ID...">
                    </div>
                    <button id="clear-search-btn" class="clear-search-btn p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                
                <!-- Centered Action Buttons (Cleaned up) -->
                <div class="mt-6 flex flex-wrap justify-center gap-4 max-w-4xl mx-auto">
                    <button id="add-car-btn" class="btn btn-primary py-2 px-6 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add New Vehicle
                    </button>
                </div>
            </section>
            
            <div id="search-results-container" class="mb-8"></div>
            
            <div id="inventory-container">
                <h2 class="text-2xl font-semibold mb-6 text-gray-700">Vehicle Inventory (<span id="car-count">0</span>)</h2>
                <div id="car-grid" class="inventory-grid"></div>
            </div>
            
            <div id="empty-state" class="text-center py-20 hidden">
                <h2 class="text-2xl font-semibold text-gray-800">Inventory is Empty</h2>
                <p class="text-gray-500 mt-2">Add your first vehicle using the "Add New Vehicle" button above.</p>
            </div>
        </main>
    </div>

    <!-- ADD CAR MODAL (New Vehicle Entry) -->
    <div id="add-car-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background-color: rgba(33, 37, 41, 0.7);">
        <div class="bg-white w-full max-w-md p-6 rounded-xl shadow-2xl m-4 border flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">New Vehicle Entry</h2>
                <button id="close-add-car-modal-btn" class="p-1 -mt-1 font-bold text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <input type="number" id="car-year" class="data-input" placeholder="Year (e.g., 2015)" min="1900" max="2099" required>
                <input type="text" id="car-make" class="data-input" placeholder="Make (e.g., Toyota)" required>
                <input type="text" id="car-model" class="data-input" placeholder="Model (e.g., Camry)" required>
                <input type="text" id="car-vin" class="data-input" placeholder="VIN (Optional)">
                <input type="text" id="car-stock-id" class="data-input" placeholder="Stock/Lot ID (e.g., A123)" required>
            </div>

            <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                <button id="cancel-add-car-btn" class="btn btn-secondary py-2 px-5">Cancel</button>
                <button id="confirm-add-car-btn" class="btn btn-primary py-2 px-5">Add Vehicle</button>
            </div>
        </div>
    </div>
    
    <!-- PART DETAIL MODAL (To manage parts of an existing car) -->
    <div id="part-detail-modal" class="fixed inset-0 z-50 hidden items-center justify-center" style="background-color: rgba(33, 37, 41, 0.7);">
        <div class="bg-white w-full max-w-3xl p-6 rounded-xl shadow-2xl m-4 border flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-start mb-4 border-b pb-3">
                <h2 class="text-2xl font-bold text-gray-800"><span id="detail-car-title">Vehicle Details</span></h2>
                <button id="close-part-detail-modal-btn" class="p-1 -mt-1 font-bold text-2xl">&times;</button>
            </div>
            <p class="text-sm text-gray-500 mb-4" id="detail-car-subtitle"></p>

            <div class="flex-grow overflow-y-auto space-y-3 p-1">
                <div class="part-grid font-bold text-sm text-gray-600 border-b pb-2">
                    <span>Part Name</span>
                    <span class="text-right">Status / Action</span>
                </div>
                <div id="parts-list-container" class="part-grid" style="grid-template-columns: 1fr 150px;">
                    <!-- Parts will be rendered here -->
                </div>
            </div>

            <div class="flex justify-between gap-4 mt-6 pt-4 border-t">
                <button id="delete-car-btn" class="btn btn-secondary text-red-600 py-2 px-5 transition duration-150 ease-in-out">Delete Vehicle</button>
                <button id="close-part-detail-btn" class="btn btn-primary py-2 px-5">Done</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS & STATE ---
            const getEl = (id) => document.getElementById(id);
            const INVENTORY_KEY = 'treadzSalvageInventoryV2';
            
            let inventory = [];
            let currentCarId = null;

            // Simple Part Keys (camelCase) to ensure easy logic access
            const ALL_PARTS_KEYS = [
                'frontDoorL', 'frontDoorR', 'rearDoorL', 'rearDoorR',
                'hood', 'trunkLid', 'frontFender', 'motor', 
                'transmission', 'frontSeats', 'rearSeats', 'rearFender'
            ];

            // Mapping for display names
            const PART_DISPLAY_MAP = {
                'frontDoorL': 'Front Door (Left)',
                'frontDoorR': 'Front Door (Right)',
                'rearDoorL': 'Rear Door (Left)',
                'rearDoorR': 'Rear Door (Right)',
                'hood': 'Hood',
                'trunkLid': 'Trunk Lid',
                'frontFender': 'Front Fender',
                'motor': 'Motor (Engine)',
                'transmission': 'Transmission',
                'frontSeats': 'Front Seats Set',
                'rearSeats': 'Rear Seats Set',
                'rearFender': 'Rear Fender'
            };

            // --- UTILITIES ---
            const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 9);
            const capitalize = (s) => s.charAt(0).toUpperCase() + s.slice(1);
            const formatPartName = (key) => PART_DISPLAY_MAP[key] || key;
            
            const showToast = (message, isError = false) => {
                const toast = getEl('toast');
                toast.innerHTML = `<p class="font-medium">${message}</p>`;
                toast.style.backgroundColor = isError ? '#DC3B0B' : 'var(--text-dark)';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            };

            // --- DATA MANAGEMENT ---
            const loadData = () => {
                inventory = JSON.parse(localStorage.getItem(INVENTORY_KEY)) || [];
            };
            const saveData = () => {
                localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
                // Explicitly calling renderAll() where needed after save operations
            };
            
            // --- CORE LOGIC ---

            const createNewCar = (year, make, model, vin, stockId) => {
                const newCar = {
                    id: generateUniqueId(),
                    year: parseInt(year, 10),
                    make: capitalize(make.trim()),
                    model: capitalize(model.trim()),
                    vin: vin.trim().toUpperCase(),
                    stockId: stockId.trim().toUpperCase(),
                    addedDate: new Date().toISOString(),
                    // Initialize all parts to 'available'
                    parts: ALL_PARTS_KEYS.reduce((acc, partKey) => {
                        acc[partKey] = { status: 'available' };
                        return acc;
                    }, {})
                };
                inventory.unshift(newCar);
                saveData(); 
                renderAll(); // Explicitly render all views after a major change
                showToast(`Vehicle ${newCar.stockId} added: ${newCar.year} ${newCar.make} ${newCar.model}`);
            };

            const updatePartStatus = (carId, partKey, newStatus) => {
                const car = inventory.find(c => c.id === carId);
                if (car && car.parts[partKey]) {
                    car.parts[partKey].status = newStatus;
                    saveData(); // Save to storage only
                    renderInventory(); // Update the card view on the main screen

                    const statusText = newStatus === 'removed' ? 'REMOVED' : 'AVAILABLE';
                    showToast(`${formatPartName(partKey)} on ${car.stockId} marked as ${statusText}.`);

                    // Re-render the parts list to update the visual feedback instantly in the modal
                    renderPartsList(car);
                }
            };
            
            const deleteCar = (carId) => {
                const car = inventory.find(c => c.id === carId);
                inventory = inventory.filter(c => c.id !== carId);
                saveData();
                renderAll(); // Explicitly render all views after deletion
                showToast(`Vehicle ${car.stockId} permanently removed from inventory.`);
                togglePartDetailModal(false);
            };
            
            // --- RENDERING ---

            const renderAll = () => {
                const term = getEl('search-input').value.trim();
                if (term.length >= 3) {
                    renderSearchResults();
                } else {
                    getEl('search-results-container').innerHTML = '';
                    getEl('inventory-container').classList.remove('hidden');
                    renderInventory();
                }
                getEl('clear-search-btn').style.display = term ? 'block' : 'none';
            };

            const renderInventory = (searchQuery = '') => {
                const container = getEl('car-grid');
                const emptyState = getEl('empty-state');
                const carCountEl = getEl('car-count');
                container.innerHTML = '';
                
                let filteredInventory = inventory;
                
                if (searchQuery) {
                    const term = searchQuery.toLowerCase();
                    filteredInventory = inventory.filter(car => 
                        car.year.toString().includes(term) ||
                        car.make.toLowerCase().includes(term) ||
                        car.model.toLowerCase().includes(term) ||
                        car.vin.toLowerCase().includes(term) ||
                        car.stockId.toLowerCase().includes(term)
                    );
                }

                carCountEl.textContent = inventory.length;

                if (inventory.length === 0) {
                    emptyState.classList.remove('hidden');
                    container.classList.add('hidden');
                    return;
                }
                
                if (filteredInventory.length === 0) {
                     container.innerHTML = '<p class="col-span-full text-center py-8 text-gray-500">No vehicles match your search criteria.</p>';
                } else {
                    filteredInventory.forEach(car => container.appendChild(createCarCardElement(car)));
                }

                emptyState.classList.add('hidden');
                container.classList.remove('hidden');
            };
            
            const renderSearchResults = () => {
                const term = getEl('search-input').value.trim();
                const container = getEl('search-results-container');
                
                let matches = inventory.filter(car => 
                    car.year.toString().includes(term) ||
                    car.make.toLowerCase().includes(term.toLowerCase()) ||
                    car.model.toLowerCase().includes(term.toLowerCase()) ||
                    car.vin.toLowerCase().includes(term.toLowerCase()) ||
                    car.stockId.toLowerCase().includes(term.toLowerCase())
                );

                if (matches.length > 0) {
                    container.innerHTML = `
                        <h2 class="text-xl font-semibold text-gray-800 mb-4" style="color: var(--secondary-color);">Search Results (${matches.length})</h2>
                        <div class="inventory-grid mb-8" id="search-grid"></div>
                    `;
                    const searchGrid = getEl('search-grid');
                    matches.forEach(car => searchGrid.appendChild(createCarCardElement(car)));
                    
                    getEl('inventory-container').classList.add('hidden');
                } else {
                    container.innerHTML = `<p class="p-4 text-center text-gray-500 border border-dashed rounded-lg">No vehicles found matching "${term}".</p>`;
                    getEl('inventory-container').classList.remove('hidden');
                }
            };

            const createCarCardElement = (car) => {
                const card = document.createElement('div');
                card.id = `car-card-${car.id}`;
                card.className = `car-card p-4 flex flex-col justify-between`;
                card.dataset.carId = car.id;
                
                const availablePartsCount = Object.values(car.parts).filter(p => p.status === 'available').length;
                const totalPartsCount = ALL_PARTS_KEYS.length;
                const progressColor = availablePartsCount > totalPartsCount / 2 ? 'bg-green-500' : (availablePartsCount > 0 ? 'bg-yellow-500' : 'bg-red-500');
                const progressWidth = (availablePartsCount / totalPartsCount) * 100;
                
                card.innerHTML = `
                    <div class="flex flex-col">
                        <p class="text-xs font-medium text-gray-500 mb-1">Stock ID: <span class="font-mono font-bold">${car.stockId}</span></p>
                        <h3 class="text-xl font-bold mb-1">${car.year} ${car.make} ${car.model}</h3>
                        <p class="text-sm text-gray-500 font-mono">VIN: ${car.vin || 'N/A'}</p>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100">
                        <div class="flex justify-between items-center text-sm font-semibold mb-2">
                            <span>Parts Availability:</span>
                            <span class="${availablePartsCount === 0 ? 'text-red-600' : 'text-green-600'}">${availablePartsCount} / ${totalPartsCount}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="${progressColor} h-2.5 rounded-full" style="width: ${progressWidth}%;"></div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => openPartDetailModal(car.id));
                return card;
            };

            // --- MODAL LOGIC (ADD CAR) ---
            const toggleAddCarModal = (show) => {
                const modal = getEl('add-car-modal');
                modal.classList.toggle('hidden', !show);
                modal.classList.toggle('flex', show);
                if (show) {
                    getEl('car-year').value = '';
                    getEl('car-make').value = '';
                    getEl('car-model').value = '';
                    getEl('car-vin').value = '';
                    getEl('car-stock-id').value = '';
                    getEl('car-year').focus();
                }
            };
            
            // --- MODAL LOGIC (PART DETAIL) ---
            const togglePartDetailModal = (show) => {
                const modal = getEl('part-detail-modal');
                modal.classList.toggle('hidden', !show);
                modal.classList.toggle('flex', show);
                if (!show) currentCarId = null;
            };

            const openPartDetailModal = (carId) => {
                currentCarId = carId;
                const car = inventory.find(c => c.id === carId);
                if (!car) return;
                
                getEl('detail-car-title').textContent = `${car.year} ${car.make} ${car.model}`;
                getEl('detail-car-subtitle').innerHTML = `Stock ID: <span class="font-mono font-medium text-gray-700">${car.stockId}</span> | VIN: ${car.vin || 'N/A'}`;
                
                // Reset delete button state
                const deleteBtn = getEl('delete-car-btn');
                deleteBtn.textContent = 'Delete Vehicle';
                deleteBtn.classList.remove('btn-primary', 'bg-red-600', 'hover:bg-red-700');
                deleteBtn.classList.add('btn-secondary', 'text-red-600');
                
                renderPartsList(car);
                
                deleteBtn.onclick = () => {
                    if (deleteBtn.textContent === 'Confirm Delete') {
                        deleteCar(carId);
                    } else {
                        deleteBtn.textContent = 'Confirm Delete';
                        deleteBtn.classList.remove('btn-secondary', 'text-red-600');
                        deleteBtn.classList.add('btn-primary', 'bg-red-600', 'hover:bg-red-700');
                        showToast("Click 'Confirm Delete' again to remove the vehicle permanently.", true);
                    }
                };
                
                togglePartDetailModal(true);
            };

            const renderPartsList = (car) => {
                const container = getEl('parts-list-container');
                container.innerHTML = '';

                ALL_PARTS_KEYS.forEach(partKey => {
                    const part = car.parts[partKey];
                    const isRemoved = part.status === 'removed';
                    const name = formatPartName(partKey);
                    
                    const item = document.createElement('div');
                    item.className = 'part-row';
                    item.innerHTML = `
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${isRemoved ? 'text-red-500' : 'text-green-500'}"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            <span class="font-medium text-gray-700">${name}</span>
                        </div>
                        <div class="part-action-col">
                            <span class="part-status-badge ${isRemoved ? 'status-removed' : 'status-available'}">${isRemoved ? 'REMOVED' : 'AVAILABLE'}</span>
                            <button class="btn btn-sm text-xs py-1 px-3 ${isRemoved ? 'btn-primary' : 'btn-secondary'}" data-part-key="${partKey}" data-new-status="${isRemoved ? 'available' : 'removed'}">
                                ${isRemoved ? 'Mark Available' : 'Mark Removed'}
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
            };

            // --- EVENT LISTENERS ---
            
            // Main Search Input
            getEl('search-input').addEventListener('input', renderAll);
            getEl('clear-search-btn').addEventListener('click', () => { 
                getEl('search-input').value = ''; 
                renderAll(); 
            });

            // Add Car Modal triggers
            getEl('add-car-btn').addEventListener('click', () => toggleAddCarModal(true));
            getEl('close-add-car-modal-btn').addEventListener('click', () => toggleAddCarModal(false));
            getEl('cancel-add-car-btn').addEventListener('click', () => toggleAddCarModal(false));
            
            getEl('confirm-add-car-btn').addEventListener('click', () => {
                const year = getEl('car-year').value;
                const make = getEl('car-make').value;
                const model = getEl('car-model').value;
                const vin = getEl('car-vin').value;
                const stockId = getEl('car-stock-id').value;

                if (!year || !make || !model || !stockId) {
                    showToast('Please fill in Year, Make, Model, and Stock ID.', true);
                    return;
                }

                createNewCar(year, make, model, vin, stockId);
                toggleAddCarModal(false);
            });
            
            // Part Detail Modal triggers
            getEl('close-part-detail-modal-btn').addEventListener('click', () => togglePartDetailModal(false));
            getEl('close-part-detail-btn').addEventListener('click', () => togglePartDetailModal(false));
            
            // Part Status Update listener (delegated)
            getEl('parts-list-container').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn && btn.dataset.partKey) {
                    const partKey = btn.dataset.partKey;
                    // FIX: Access dataset property using camelCase (newStatus) not hyphenated (new-status)
                    const newStatus = btn.dataset.newStatus; 
                    updatePartStatus(currentCarId, partKey, newStatus);
                    
                    // Reset the delete button if a part status was changed
                    const deleteBtn = getEl('delete-car-btn');
                    deleteBtn.textContent = 'Delete Vehicle';
                    deleteBtn.classList.remove('btn-primary', 'bg-red-600', 'hover:bg-red-700');
                    deleteBtn.classList.add('btn-secondary', 'text-red-600');
                }
            });

            // Initial load
            loadData();
            renderAll();
        });
    </script>
</body>
</html>